var dc=Object.create,Ti=Object.defineProperty,pc=Object.getPrototypeOf,lc=Object.prototype.hasOwnProperty,uc=Object.getOwnPropertyNames,fc=Object.getOwnPropertyDescriptor;var G=Object.assign,hc=r=>Ti(r,"__esModule",{value:!0});var b=(r,e)=>()=>(e||(e={exports:{}},r(e.exports,e)),e.exports);var mc=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of uc(e))!lc.call(r,i)&&i!=="default"&&Ti(r,i,{get:()=>e[i],enumerable:!(t=fc(e,i))||t.enumerable});return r},Ei=r=>r&&r.__esModule?r:mc(hc(Ti(r!=null?dc(pc(r)):{},"default",{value:r,enumerable:!0})),r);var m=(r,e,t)=>new Promise((i,n)=>{var s=o=>{try{a(t.next(o))}catch(d){n(d)}},c=o=>{try{a(t.throw(o))}catch(d){n(d)}},a=o=>o.done?i(o.value):Promise.resolve(o.value).then(s,c);a((t=t.apply(r,e)).next())});var $i=b((sr,Ui)=>{(function(r,e){typeof sr=="object"&&typeof Ui=="object"?Ui.exports=e():typeof define=="function"&&define.amd?define([],e):typeof sr=="object"?sr.bowser=e():r.bowser=e()})(sr,function(){return function(r){var e={};function t(i){if(e[i])return e[i].exports;var n=e[i]={i,l:!1,exports:{}};return r[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}return t.m=r,t.c=e,t.d=function(i,n,s){t.o(i,n)||Object.defineProperty(i,n,{enumerable:!0,get:s})},t.r=function(i){typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},t.t=function(i,n){if(1&n&&(i=t(i)),8&n||4&n&&typeof i=="object"&&i&&i.__esModule)return i;var s=Object.create(null);if(t.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:i}),2&n&&typeof i!="string")for(var c in i)t.d(s,c,function(a){return i[a]}.bind(null,c));return s},t.n=function(i){var n=i&&i.__esModule?function(){return i.default}:function(){return i};return t.d(n,"a",n),n},t.o=function(i,n){return Object.prototype.hasOwnProperty.call(i,n)},t.p="",t(t.s=90)}({17:function(r,e,t){"use strict";e.__esModule=!0,e.default=void 0;var i=t(18),n=function(){function s(){}return s.getFirstMatch=function(c,a){var o=a.match(c);return o&&o.length>0&&o[1]||""},s.getSecondMatch=function(c,a){var o=a.match(c);return o&&o.length>1&&o[2]||""},s.matchAndReturnConst=function(c,a,o){if(c.test(a))return o},s.getWindowsVersionName=function(c){switch(c){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}},s.getMacOSVersionName=function(c){var a=c.split(".").splice(0,2).map(function(o){return parseInt(o,10)||0});if(a.push(0),a[0]===10)switch(a[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}},s.getAndroidVersionName=function(c){var a=c.split(".").splice(0,2).map(function(o){return parseInt(o,10)||0});if(a.push(0),!(a[0]===1&&a[1]<5))return a[0]===1&&a[1]<6?"Cupcake":a[0]===1&&a[1]>=6?"Donut":a[0]===2&&a[1]<2?"Eclair":a[0]===2&&a[1]===2?"Froyo":a[0]===2&&a[1]>2?"Gingerbread":a[0]===3?"Honeycomb":a[0]===4&&a[1]<1?"Ice Cream Sandwich":a[0]===4&&a[1]<4?"Jelly Bean":a[0]===4&&a[1]>=4?"KitKat":a[0]===5?"Lollipop":a[0]===6?"Marshmallow":a[0]===7?"Nougat":a[0]===8?"Oreo":a[0]===9?"Pie":void 0},s.getVersionPrecision=function(c){return c.split(".").length},s.compareVersions=function(c,a,o){o===void 0&&(o=!1);var d=s.getVersionPrecision(c),l=s.getVersionPrecision(a),p=Math.max(d,l),u=0,f=s.map([c,a],function(h){var g=p-s.getVersionPrecision(h),v=h+new Array(g+1).join(".0");return s.map(v.split("."),function(_){return new Array(20-_.length).join("0")+_}).reverse()});for(o&&(u=p-Math.min(d,l)),p-=1;p>=u;){if(f[0][p]>f[1][p])return 1;if(f[0][p]===f[1][p]){if(p===u)return 0;p-=1}else if(f[0][p]<f[1][p])return-1}},s.map=function(c,a){var o,d=[];if(Array.prototype.map)return Array.prototype.map.call(c,a);for(o=0;o<c.length;o+=1)d.push(a(c[o]));return d},s.find=function(c,a){var o,d;if(Array.prototype.find)return Array.prototype.find.call(c,a);for(o=0,d=c.length;o<d;o+=1){var l=c[o];if(a(l,o))return l}},s.assign=function(c){for(var a,o,d=c,l=arguments.length,p=new Array(l>1?l-1:0),u=1;u<l;u++)p[u-1]=arguments[u];if(Object.assign)return Object.assign.apply(Object,[c].concat(p));var f=function(){var h=p[a];typeof h=="object"&&h!==null&&Object.keys(h).forEach(function(g){d[g]=h[g]})};for(a=0,o=p.length;a<o;a+=1)f();return c},s.getBrowserAlias=function(c){return i.BROWSER_ALIASES_MAP[c]},s.getBrowserTypeByAlias=function(c){return i.BROWSER_MAP[c]||""},s}();e.default=n,r.exports=e.default},18:function(r,e,t){"use strict";e.__esModule=!0,e.ENGINE_MAP=e.OS_MAP=e.PLATFORMS_MAP=e.BROWSER_MAP=e.BROWSER_ALIASES_MAP=void 0,e.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},e.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},e.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},e.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},e.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"}},90:function(r,e,t){"use strict";e.__esModule=!0,e.default=void 0;var i,n=(i=t(91))&&i.__esModule?i:{default:i},s=t(18);function c(o,d){for(var l=0;l<d.length;l++){var p=d[l];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(o,p.key,p)}}var a=function(){function o(){}var d,l,p;return o.getParser=function(u,f){if(f===void 0&&(f=!1),typeof u!="string")throw new Error("UserAgent should be a string");return new n.default(u,f)},o.parse=function(u){return new n.default(u).getResult()},d=o,p=[{key:"BROWSER_MAP",get:function(){return s.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return s.ENGINE_MAP}},{key:"OS_MAP",get:function(){return s.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return s.PLATFORMS_MAP}}],(l=null)&&c(d.prototype,l),p&&c(d,p),o}();e.default=a,r.exports=e.default},91:function(r,e,t){"use strict";e.__esModule=!0,e.default=void 0;var i=o(t(92)),n=o(t(93)),s=o(t(94)),c=o(t(95)),a=o(t(17));function o(l){return l&&l.__esModule?l:{default:l}}var d=function(){function l(u,f){if(f===void 0&&(f=!1),u==null||u==="")throw new Error("UserAgent parameter can't be empty");this._ua=u,this.parsedResult={},f!==!0&&this.parse()}var p=l.prototype;return p.getUA=function(){return this._ua},p.test=function(u){return u.test(this._ua)},p.parseBrowser=function(){var u=this;this.parsedResult.browser={};var f=a.default.find(i.default,function(h){if(typeof h.test=="function")return h.test(u);if(h.test instanceof Array)return h.test.some(function(g){return u.test(g)});throw new Error("Browser's test function is not valid")});return f&&(this.parsedResult.browser=f.describe(this.getUA())),this.parsedResult.browser},p.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},p.getBrowserName=function(u){return u?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""},p.getBrowserVersion=function(){return this.getBrowser().version},p.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},p.parseOS=function(){var u=this;this.parsedResult.os={};var f=a.default.find(n.default,function(h){if(typeof h.test=="function")return h.test(u);if(h.test instanceof Array)return h.test.some(function(g){return u.test(g)});throw new Error("Browser's test function is not valid")});return f&&(this.parsedResult.os=f.describe(this.getUA())),this.parsedResult.os},p.getOSName=function(u){var f=this.getOS().name;return u?String(f).toLowerCase()||"":f||""},p.getOSVersion=function(){return this.getOS().version},p.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},p.getPlatformType=function(u){u===void 0&&(u=!1);var f=this.getPlatform().type;return u?String(f).toLowerCase()||"":f||""},p.parsePlatform=function(){var u=this;this.parsedResult.platform={};var f=a.default.find(s.default,function(h){if(typeof h.test=="function")return h.test(u);if(h.test instanceof Array)return h.test.some(function(g){return u.test(g)});throw new Error("Browser's test function is not valid")});return f&&(this.parsedResult.platform=f.describe(this.getUA())),this.parsedResult.platform},p.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},p.getEngineName=function(u){return u?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""},p.parseEngine=function(){var u=this;this.parsedResult.engine={};var f=a.default.find(c.default,function(h){if(typeof h.test=="function")return h.test(u);if(h.test instanceof Array)return h.test.some(function(g){return u.test(g)});throw new Error("Browser's test function is not valid")});return f&&(this.parsedResult.engine=f.describe(this.getUA())),this.parsedResult.engine},p.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},p.getResult=function(){return a.default.assign({},this.parsedResult)},p.satisfies=function(u){var f=this,h={},g=0,v={},_=0;if(Object.keys(u).forEach(function(C){var V=u[C];typeof V=="string"?(v[C]=V,_+=1):typeof V=="object"&&(h[C]=V,g+=1)}),g>0){var y=Object.keys(h),S=a.default.find(y,function(C){return f.isOS(C)});if(S){var R=this.satisfies(h[S]);if(R!==void 0)return R}var E=a.default.find(y,function(C){return f.isPlatform(C)});if(E){var L=this.satisfies(h[E]);if(L!==void 0)return L}}if(_>0){var x=Object.keys(v),T=a.default.find(x,function(C){return f.isBrowser(C,!0)});if(T!==void 0)return this.compareVersion(v[T])}},p.isBrowser=function(u,f){f===void 0&&(f=!1);var h=this.getBrowserName().toLowerCase(),g=u.toLowerCase(),v=a.default.getBrowserTypeByAlias(g);return f&&v&&(g=v.toLowerCase()),g===h},p.compareVersion=function(u){var f=[0],h=u,g=!1,v=this.getBrowserVersion();if(typeof v=="string")return u[0]===">"||u[0]==="<"?(h=u.substr(1),u[1]==="="?(g=!0,h=u.substr(2)):f=[],u[0]===">"?f.push(1):f.push(-1)):u[0]==="="?h=u.substr(1):u[0]==="~"&&(g=!0,h=u.substr(1)),f.indexOf(a.default.compareVersions(v,h,g))>-1},p.isOS=function(u){return this.getOSName(!0)===String(u).toLowerCase()},p.isPlatform=function(u){return this.getPlatformType(!0)===String(u).toLowerCase()},p.isEngine=function(u){return this.getEngineName(!0)===String(u).toLowerCase()},p.is=function(u,f){return f===void 0&&(f=!1),this.isBrowser(u,f)||this.isOS(u)||this.isPlatform(u)},p.some=function(u){var f=this;return u===void 0&&(u=[]),u.some(function(h){return f.is(h)})},l}();e.default=d,r.exports=e.default},92:function(r,e,t){"use strict";e.__esModule=!0,e.default=void 0;var i,n=(i=t(17))&&i.__esModule?i:{default:i},s=/version\/(\d+(\.?_?\d+)+)/i,c=[{test:[/googlebot/i],describe:function(a){var o={name:"Googlebot"},d=n.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/opera/i],describe:function(a){var o={name:"Opera"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/opr\/|opios/i],describe:function(a){var o={name:"Opera"},d=n.default.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/SamsungBrowser/i],describe:function(a){var o={name:"Samsung Internet for Android"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/Whale/i],describe:function(a){var o={name:"NAVER Whale Browser"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/MZBrowser/i],describe:function(a){var o={name:"MZ Browser"},d=n.default.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/focus/i],describe:function(a){var o={name:"Focus"},d=n.default.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/swing/i],describe:function(a){var o={name:"Swing"},d=n.default.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/coast/i],describe:function(a){var o={name:"Opera Coast"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe:function(a){var o={name:"Opera Touch"},d=n.default.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/yabrowser/i],describe:function(a){var o={name:"Yandex Browser"},d=n.default.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/ucbrowser/i],describe:function(a){var o={name:"UC Browser"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/Maxthon|mxios/i],describe:function(a){var o={name:"Maxthon"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/epiphany/i],describe:function(a){var o={name:"Epiphany"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/puffin/i],describe:function(a){var o={name:"Puffin"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/sleipnir/i],describe:function(a){var o={name:"Sleipnir"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/k-meleon/i],describe:function(a){var o={name:"K-Meleon"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/micromessenger/i],describe:function(a){var o={name:"WeChat"},d=n.default.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/qqbrowser/i],describe:function(a){var o={name:/qqbrowserlite/i.test(a)?"QQ Browser Lite":"QQ Browser"},d=n.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/msie|trident/i],describe:function(a){var o={name:"Internet Explorer"},d=n.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/\sedg\//i],describe:function(a){var o={name:"Microsoft Edge"},d=n.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/edg([ea]|ios)/i],describe:function(a){var o={name:"Microsoft Edge"},d=n.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/vivaldi/i],describe:function(a){var o={name:"Vivaldi"},d=n.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/seamonkey/i],describe:function(a){var o={name:"SeaMonkey"},d=n.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/sailfish/i],describe:function(a){var o={name:"Sailfish"},d=n.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,a);return d&&(o.version=d),o}},{test:[/silk/i],describe:function(a){var o={name:"Amazon Silk"},d=n.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/phantom/i],describe:function(a){var o={name:"PhantomJS"},d=n.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/slimerjs/i],describe:function(a){var o={name:"SlimerJS"},d=n.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(a){var o={name:"BlackBerry"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/(web|hpw)[o0]s/i],describe:function(a){var o={name:"WebOS Browser"},d=n.default.getFirstMatch(s,a)||n.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/bada/i],describe:function(a){var o={name:"Bada"},d=n.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/tizen/i],describe:function(a){var o={name:"Tizen"},d=n.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/qupzilla/i],describe:function(a){var o={name:"QupZilla"},d=n.default.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/firefox|iceweasel|fxios/i],describe:function(a){var o={name:"Firefox"},d=n.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/electron/i],describe:function(a){var o={name:"Electron"},d=n.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/MiuiBrowser/i],describe:function(a){var o={name:"Miui"},d=n.default.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/chromium/i],describe:function(a){var o={name:"Chromium"},d=n.default.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,a)||n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/chrome|crios|crmo/i],describe:function(a){var o={name:"Chrome"},d=n.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/GSA/i],describe:function(a){var o={name:"Google Search"},d=n.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:function(a){var o=!a.test(/like android/i),d=a.test(/android/i);return o&&d},describe:function(a){var o={name:"Android Browser"},d=n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/playstation 4/i],describe:function(a){var o={name:"PlayStation 4"},d=n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/safari|applewebkit/i],describe:function(a){var o={name:"Safari"},d=n.default.getFirstMatch(s,a);return d&&(o.version=d),o}},{test:[/.*/i],describe:function(a){var o=a.search("\\(")!==-1?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:n.default.getFirstMatch(o,a),version:n.default.getSecondMatch(o,a)}}}];e.default=c,r.exports=e.default},93:function(r,e,t){"use strict";e.__esModule=!0,e.default=void 0;var i,n=(i=t(17))&&i.__esModule?i:{default:i},s=t(18),c=[{test:[/Roku\/DVP/],describe:function(a){var o=n.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,a);return{name:s.OS_MAP.Roku,version:o}}},{test:[/windows phone/i],describe:function(a){var o=n.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,a);return{name:s.OS_MAP.WindowsPhone,version:o}}},{test:[/windows /i],describe:function(a){var o=n.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,a),d=n.default.getWindowsVersionName(o);return{name:s.OS_MAP.Windows,version:o,versionName:d}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(a){var o={name:s.OS_MAP.iOS},d=n.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,a);return d&&(o.version=d),o}},{test:[/macintosh/i],describe:function(a){var o=n.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,a).replace(/[_\s]/g,"."),d=n.default.getMacOSVersionName(o),l={name:s.OS_MAP.MacOS,version:o};return d&&(l.versionName=d),l}},{test:[/(ipod|iphone|ipad)/i],describe:function(a){var o=n.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,a).replace(/[_\s]/g,".");return{name:s.OS_MAP.iOS,version:o}}},{test:function(a){var o=!a.test(/like android/i),d=a.test(/android/i);return o&&d},describe:function(a){var o=n.default.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,a),d=n.default.getAndroidVersionName(o),l={name:s.OS_MAP.Android,version:o};return d&&(l.versionName=d),l}},{test:[/(web|hpw)[o0]s/i],describe:function(a){var o=n.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,a),d={name:s.OS_MAP.WebOS};return o&&o.length&&(d.version=o),d}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(a){var o=n.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,a)||n.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,a)||n.default.getFirstMatch(/\bbb(\d+)/i,a);return{name:s.OS_MAP.BlackBerry,version:o}}},{test:[/bada/i],describe:function(a){var o=n.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,a);return{name:s.OS_MAP.Bada,version:o}}},{test:[/tizen/i],describe:function(a){var o=n.default.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,a);return{name:s.OS_MAP.Tizen,version:o}}},{test:[/linux/i],describe:function(){return{name:s.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return{name:s.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(a){var o=n.default.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,a);return{name:s.OS_MAP.PlayStation4,version:o}}}];e.default=c,r.exports=e.default},94:function(r,e,t){"use strict";e.__esModule=!0,e.default=void 0;var i,n=(i=t(17))&&i.__esModule?i:{default:i},s=t(18),c=[{test:[/googlebot/i],describe:function(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(a){var o=n.default.getFirstMatch(/(can-l01)/i,a)&&"Nova",d={type:s.PLATFORMS_MAP.mobile,vendor:"Huawei"};return o&&(d.model=o),d}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return{type:s.PLATFORMS_MAP.tablet}}},{test:function(a){var o=a.test(/ipod|iphone/i),d=a.test(/like (ipod|iphone)/i);return o&&!d},describe:function(a){var o=n.default.getFirstMatch(/(ipod|iphone)/i,a);return{type:s.PLATFORMS_MAP.mobile,vendor:"Apple",model:o}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(a){return a.getBrowserName(!0)==="blackberry"},describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(a){return a.getBrowserName(!0)==="bada"},describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(a){return a.getBrowserName()==="windows phone"},describe:function(){return{type:s.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(a){var o=Number(String(a.getOSVersion()).split(".")[0]);return a.getOSName(!0)==="android"&&o>=3},describe:function(){return{type:s.PLATFORMS_MAP.tablet}}},{test:function(a){return a.getOSName(!0)==="android"},describe:function(){return{type:s.PLATFORMS_MAP.mobile}}},{test:function(a){return a.getOSName(!0)==="macos"},describe:function(){return{type:s.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(a){return a.getOSName(!0)==="windows"},describe:function(){return{type:s.PLATFORMS_MAP.desktop}}},{test:function(a){return a.getOSName(!0)==="linux"},describe:function(){return{type:s.PLATFORMS_MAP.desktop}}},{test:function(a){return a.getOSName(!0)==="playstation 4"},describe:function(){return{type:s.PLATFORMS_MAP.tv}}},{test:function(a){return a.getOSName(!0)==="roku"},describe:function(){return{type:s.PLATFORMS_MAP.tv}}}];e.default=c,r.exports=e.default},95:function(r,e,t){"use strict";e.__esModule=!0,e.default=void 0;var i,n=(i=t(17))&&i.__esModule?i:{default:i},s=t(18),c=[{test:function(a){return a.getBrowserName(!0)==="microsoft edge"},describe:function(a){if(/\sedg\//i.test(a))return{name:s.ENGINE_MAP.Blink};var o=n.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,a);return{name:s.ENGINE_MAP.EdgeHTML,version:o}}},{test:[/trident/i],describe:function(a){var o={name:s.ENGINE_MAP.Trident},d=n.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:function(a){return a.test(/presto/i)},describe:function(a){var o={name:s.ENGINE_MAP.Presto},d=n.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:function(a){var o=a.test(/gecko/i),d=a.test(/like gecko/i);return o&&!d},describe:function(a){var o={name:s.ENGINE_MAP.Gecko},d=n.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return{name:s.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(a){var o={name:s.ENGINE_MAP.WebKit},d=n.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,a);return d&&(o.version=d),o}}];e.default=c,r.exports=e.default}})})});var Ts=b((ju,Rs)=>{Rs.exports={_from:"protoo-client@^4.0.6",_id:"protoo-client@4.0.6",_inBundle:!1,_integrity:"sha512-ZqImkKHpeJhSlgvyI6QAfZNc/aXcCgmmocMx4S1w2lAaxXtckxxeDtcVNtkOISUWm/mbC+BrmYPXoGMkfhkKOQ==",_location:"/protoo-client",_phantomChildren:{},_requested:{type:"range",registry:!0,raw:"protoo-client@^4.0.6",name:"protoo-client",escapedName:"protoo-client",rawSpec:"^4.0.6",saveSpec:null,fetchSpec:"^4.0.6"},_requiredBy:["/"],_resolved:"https://registry.npmjs.org/protoo-client/-/protoo-client-4.0.6.tgz",_shasum:"02a89f997ee5a4f385dab7be938dda1a2c5158e4",_spec:"protoo-client@^4.0.6",_where:"C:\\WebstormProjects\\lightstream-webrtc-client",author:{name:"I\xF1aki Baz Castillo",email:"ibc@aliax.net"},bugs:{url:"https://github.com/ibc/protoo/issues"},bundleDependencies:!1,dependencies:{debug:"^4.3.1",events:"^3.2.0",retry:"^0.12.0",websocket:"^1.0.33"},deprecated:!1,description:"protoo JavaScript client module",devDependencies:{eslint:"^5.16.0"},engines:{node:">=8.0.0"},homepage:"https://protoo.versatica.com",keywords:["nodejs","browser","websocket"],license:"MIT",main:"lib/index.js",name:"protoo-client",optionalDependencies:{websocket:"^1.0.33"},repository:{type:"git",url:"git+https://github.com/ibc/protoo.git"},scripts:{lint:"eslint -c .eslintrc.js lib"},version:"4.0.6"}});var Cs=b((Nu,Es)=>{var wt=1e3,St=wt*60,bt=St*60,tt=bt*24,Mc=tt*7,kc=tt*365.25;Es.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return Ic(r);if(t==="number"&&isFinite(r))return e.long?Oc(r):Lc(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Ic(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!!e){var t=parseFloat(e[1]),i=(e[2]||"ms").toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return t*kc;case"weeks":case"week":case"w":return t*Mc;case"days":case"day":case"d":return t*tt;case"hours":case"hour":case"hrs":case"hr":case"h":return t*bt;case"minutes":case"minute":case"mins":case"min":case"m":return t*St;case"seconds":case"second":case"secs":case"sec":case"s":return t*wt;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Lc(r){var e=Math.abs(r);return e>=tt?Math.round(r/tt)+"d":e>=bt?Math.round(r/bt)+"h":e>=St?Math.round(r/St)+"m":e>=wt?Math.round(r/wt)+"s":r+"ms"}function Oc(r){var e=Math.abs(r);return e>=tt?Fr(r,e,tt,"day"):e>=bt?Fr(r,e,bt,"hour"):e>=St?Fr(r,e,St,"minute"):e>=wt?Fr(r,e,wt,"second"):r+" ms"}function Fr(r,e,t,i){var n=e>=t*1.5;return Math.round(r/t)+" "+i+(n?"s":"")}});var Ps=b((Fu,xs)=>{function Ac(r){t.debug=t,t.default=t,t.coerce=o,t.disable=s,t.enable=n,t.enabled=c,t.humanize=Cs(),t.destroy=d,Object.keys(r).forEach(l=>{t[l]=r[l]}),t.names=[],t.skips=[],t.formatters={};function e(l){let p=0;for(let u=0;u<l.length;u++)p=(p<<5)-p+l.charCodeAt(u),p|=0;return t.colors[Math.abs(p)%t.colors.length]}t.selectColor=e;function t(l){let p,u=null;function f(...h){if(!f.enabled)return;let g=f,v=Number(new Date),_=v-(p||v);g.diff=_,g.prev=p,g.curr=v,p=v,h[0]=t.coerce(h[0]),typeof h[0]!="string"&&h.unshift("%O");let y=0;h[0]=h[0].replace(/%([a-zA-Z%])/g,(R,E)=>{if(R==="%%")return"%";y++;let L=t.formatters[E];if(typeof L=="function"){let x=h[y];R=L.call(g,x),h.splice(y,1),y--}return R}),t.formatArgs.call(g,h),(g.log||t.log).apply(g,h)}return f.namespace=l,f.useColors=t.useColors(),f.color=t.selectColor(l),f.extend=i,f.destroy=t.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>u===null?t.enabled(l):u,set:h=>{u=h}}),typeof t.init=="function"&&t.init(f),f}function i(l,p){let u=t(this.namespace+(typeof p=="undefined"?":":p)+l);return u.log=this.log,u}function n(l){t.save(l),t.names=[],t.skips=[];let p,u=(typeof l=="string"?l:"").split(/[\s,]+/),f=u.length;for(p=0;p<f;p++)!u[p]||(l=u[p].replace(/\*/g,".*?"),l[0]==="-"?t.skips.push(new RegExp("^"+l.substr(1)+"$")):t.names.push(new RegExp("^"+l+"$")))}function s(){let l=[...t.names.map(a),...t.skips.map(a).map(p=>"-"+p)].join(",");return t.enable(""),l}function c(l){if(l[l.length-1]==="*")return!0;let p,u;for(p=0,u=t.skips.length;p<u;p++)if(t.skips[p].test(l))return!1;for(p=0,u=t.names.length;p<u;p++)if(t.names[p].test(l))return!0;return!1}function a(l){return l.toString().substring(2,l.toString().length-2).replace(/\.\*\?$/,"*")}function o(l){return l instanceof Error?l.stack||l.message:l}function d(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}xs.exports=Ac});var Br=b((se,qr)=>{se.formatArgs=jc;se.save=Nc;se.load=Fc;se.useColors=qc;se.storage=Bc();se.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();se.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function qc(){return typeof window!="undefined"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document!="undefined"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window!="undefined"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator!="undefined"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function jc(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+qr.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,i=0;r[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(t++,n==="%c"&&(i=t))}),r.splice(i,0,e)}se.log=console.debug||console.log||(()=>{});function Nc(r){try{r?se.storage.setItem("debug",r):se.storage.removeItem("debug")}catch(e){}}function Fc(){let r;try{r=se.storage.getItem("debug")}catch(e){}return!r&&typeof process!="undefined"&&"env"in process&&(r=process.env.DEBUG),r}function Bc(){try{return localStorage}catch(r){}}qr.exports=Ps()(se);var{formatters:Uc}=qr.exports;Uc.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var ar=b((qu,Ds)=>{var Rt=Br(),Tt="protoo-client",Ms=class{constructor(e){e?(this._debug=Rt(`${Tt}:${e}`),this._warn=Rt(`${Tt}:WARN:${e}`),this._error=Rt(`${Tt}:ERROR:${e}`)):(this._debug=Rt(Tt),this._warn=Rt(`${Tt}:WARN`),this._error=Rt(`${Tt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};Ds.exports=Ms});var Wi=b((Bu,zi)=>{"use strict";var Et=typeof Reflect=="object"?Reflect:null,ks=Et&&typeof Et.apply=="function"?Et.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)},Ur;Et&&typeof Et.ownKeys=="function"?Ur=Et.ownKeys:Object.getOwnPropertySymbols?Ur=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Ur=function(e){return Object.getOwnPropertyNames(e)};function $c(r){console&&console.warn&&console.warn(r)}var Is=Number.isNaN||function(e){return e!==e};function W(){W.init.call(this)}zi.exports=W;zi.exports.once=zc;W.EventEmitter=W;W.prototype._events=void 0;W.prototype._eventsCount=0;W.prototype._maxListeners=void 0;var Ls=10;function $r(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(W,"defaultMaxListeners",{enumerable:!0,get:function(){return Ls},set:function(r){if(typeof r!="number"||r<0||Is(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Ls=r}});W.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};W.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Is(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Os(r){return r._maxListeners===void 0?W.defaultMaxListeners:r._maxListeners}W.prototype.getMaxListeners=function(){return Os(this)};W.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n=e==="error",s=this._events;if(s!==void 0)n=n&&s.error===void 0;else if(!n)return!1;if(n){var c;if(t.length>0&&(c=t[0]),c instanceof Error)throw c;var a=new Error("Unhandled error."+(c?" ("+c.message+")":""));throw a.context=c,a}var o=s[e];if(o===void 0)return!1;if(typeof o=="function")ks(o,this,t);else for(var d=o.length,l=As(o,d),i=0;i<d;++i)ks(l[i],this,t);return!0};function js(r,e,t,i){var n,s,c;if($r(t),s=r._events,s===void 0?(s=r._events=Object.create(null),r._eventsCount=0):(s.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),s=r._events),c=s[e]),c===void 0)c=s[e]=t,++r._eventsCount;else if(typeof c=="function"?c=s[e]=i?[t,c]:[c,t]:i?c.unshift(t):c.push(t),n=Os(r),n>0&&c.length>n&&!c.warned){c.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=c.length,$c(a)}return r}W.prototype.addListener=function(e,t){return js(this,e,t,!1)};W.prototype.on=W.prototype.addListener;W.prototype.prependListener=function(e,t){return js(this,e,t,!0)};function Wc(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ns(r,e,t){var i={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},n=Wc.bind(i);return n.listener=t,i.wrapFn=n,n}W.prototype.once=function(e,t){return $r(t),this.on(e,Ns(this,e,t)),this};W.prototype.prependOnceListener=function(e,t){return $r(t),this.prependListener(e,Ns(this,e,t)),this};W.prototype.removeListener=function(e,t){var i,n,s,c,a;if($r(t),n=this._events,n===void 0)return this;if(i=n[e],i===void 0)return this;if(i===t||i.listener===t)--this._eventsCount==0?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if(typeof i!="function"){for(s=-1,c=i.length-1;c>=0;c--)if(i[c]===t||i[c].listener===t){a=i[c].listener,s=c;break}if(s<0)return this;s===0?i.shift():Vc(i,s),i.length===1&&(n[e]=i[0]),n.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};W.prototype.off=W.prototype.removeListener;W.prototype.removeAllListeners=function(e){var t,i,n;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var s=Object.keys(i),c;for(n=0;n<s.length;++n)c=s[n],c!=="removeListener"&&this.removeAllListeners(c);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=i[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this};function Fs(r,e,t){var i=r._events;if(i===void 0)return[];var n=i[e];return n===void 0?[]:typeof n=="function"?t?[n.listener||n]:[n]:t?Gc(n):As(n,n.length)}W.prototype.listeners=function(e){return Fs(this,e,!0)};W.prototype.rawListeners=function(e){return Fs(this,e,!1)};W.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):qs.call(r,e)};W.prototype.listenerCount=qs;function qs(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}W.prototype.eventNames=function(){return this._eventsCount>0?Ur(this._events):[]};function As(r,e){for(var t=new Array(e),i=0;i<e;++i)t[i]=r[i];return t}function Vc(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function Gc(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function zc(r,e){return new Promise(function(t,i){function n(){s!==void 0&&r.removeListener("error",s),t([].slice.call(arguments))}var s;e!=="error"&&(s=function(a){r.removeListener(e,n),i(a)},r.once("error",s)),r.once(e,n)})}});var Vi=b((Uu,Bs)=>{var{EventEmitter:Kc}=Wi(),Hc=ar(),Us=class extends Kc{constructor(e){super();this.setMaxListeners(Infinity),this._logger=e||new Hc("EnhancedEventEmitter")}safeEmit(e,...t){try{this.emit(e,...t)}catch(i){this._logger.error("safeEmit() | event listener threw an error [event:%s]:%o",e,i)}}safeEmitAsPromise(e,...t){return m(this,null,function*(){return new Promise((i,n)=>{this.safeEmit(e,...t,i,n)})})}};Bs.exports=Us});var zs=b($s=>{$s.generateRandomNumber=function(){return Math.round(Math.random()*1e7)}});var Gi=b((zu,Ws)=>{var Jc=ar(),{generateRandomNumber:Qc}=zs(),rt=new Jc("Message"),Vs=class{static parse(e){let t,i={};try{t=JSON.parse(e)}catch(n){rt.error("parse() | invalid JSON: %s",n);return}if(typeof t!="object"||Array.isArray(t)){rt.error("parse() | not an object");return}if(t.request){if(i.request=!0,typeof t.method!="string"){rt.error("parse() | missing/invalid method field");return}if(typeof t.id!="number"){rt.error("parse() | missing/invalid id field");return}i.id=t.id,i.method=t.method,i.data=t.data||{}}else if(t.response){if(i.response=!0,typeof t.id!="number"){rt.error("parse() | missing/invalid id field");return}i.id=t.id,t.ok?(i.ok=!0,i.data=t.data||{}):(i.ok=!1,i.errorCode=t.errorCode,i.errorReason=t.errorReason)}else if(t.notification){if(i.notification=!0,typeof t.method!="string"){rt.error("parse() | missing/invalid method field");return}i.method=t.method,i.data=t.data||{}}else{rt.error("parse() | missing request/response field");return}return i}static createRequest(e,t){return{request:!0,id:Qc(),method:e,data:t||{}}}static createSuccessResponse(e,t){return{response:!0,id:e.id,ok:!0,data:t||{}}}static createErrorResponse(e,t,i){return{response:!0,id:e.id,ok:!1,errorCode:t,errorReason:i}}static createNotification(e,t){return{notification:!0,method:e,data:t||{}}}};Ws.exports=Vs});var Hs=b((Wu,Gs)=>{var Yc=ar(),Xc=Vi(),or=Gi(),Be=new Yc("Peer"),Ks=class extends Xc{constructor(e){super(Be);Be.debug("constructor()"),this._closed=!1,this._transport=e,this._connected=!1,this._data={},this._sents=new Map,this._handleTransport()}get closed(){return this._closed}get connected(){return this._connected}get data(){return this._data}set data(e){throw new Error("cannot override data object")}close(){if(!this._closed){Be.debug("close()"),this._closed=!0,this._connected=!1,this._transport.close();for(let e of this._sents.values())e.close();this.safeEmit("close")}}request(e,t=void 0){return m(this,null,function*(){let i=or.createRequest(e,t);return this._logger.debug("request() [method:%s, id:%s]",e,i.id),yield this._transport.send(i),new Promise((n,s)=>{let c=1500*(15+.1*this._sents.size),a={id:i.id,method:i.method,resolve:o=>{!this._sents.delete(i.id)||(clearTimeout(a.timer),n(o))},reject:o=>{!this._sents.delete(i.id)||(clearTimeout(a.timer),s(o))},timer:setTimeout(()=>{!this._sents.delete(i.id)||s(new Error("request timeout"))},c),close:()=>{clearTimeout(a.timer),s(new Error("peer closed"))}};this._sents.set(i.id,a)})})}notify(e,t=void 0){return m(this,null,function*(){let i=or.createNotification(e,t);this._logger.debug("notify() [method:%s]",e),yield this._transport.send(i)})}_handleTransport(){if(this._transport.closed){this._closed=!0,setTimeout(()=>{this._closed||(this._connected=!1,this.safeEmit("close"))});return}this._transport.on("open",()=>{this._closed||(Be.debug('emit "open"'),this._connected=!0,this.safeEmit("open"))}),this._transport.on("disconnected",()=>{this._closed||(Be.debug('emit "disconnected"'),this._connected=!1,this.safeEmit("disconnected"))}),this._transport.on("failed",e=>{this._closed||(Be.debug('emit "failed" [currentAttempt:%s]',e),this._connected=!1,this.safeEmit("failed",e))}),this._transport.on("close",()=>{this._closed||(this._closed=!0,Be.debug('emit "close"'),this._connected=!1,this.safeEmit("close"))}),this._transport.on("message",e=>{e.request?this._handleRequest(e):e.response?this._handleResponse(e):e.notification&&this._handleNotification(e)})}_handleRequest(e){try{this.emit("request",e,t=>{let i=or.createSuccessResponse(e,t);this._transport.send(i).catch(()=>{})},(t,i)=>{t instanceof Error?(i=t.message,t=500):typeof t=="number"&&i instanceof Error&&(i=i.message);let n=or.createErrorResponse(e,t,i);this._transport.send(n).catch(()=>{})})}catch(t){let i=or.createErrorResponse(e,500,String(t));this._transport.send(i).catch(()=>{})}}_handleResponse(e){let t=this._sents.get(e.id);if(!t){Be.error("received response does not match any sent request [id:%s]",e.id);return}if(e.ok)t.resolve(e.data);else{let i=new Error(e.errorReason);i.code=e.errorCode,t.reject(i)}}_handleNotification(e){this.safeEmit("notification",e)}};Gs.exports=Ks});var Ys=b((Vu,Js)=>{var Qs=function(){if(typeof self=="object"&&self)return self;if(typeof window=="object"&&window)return window;throw new Error("Unable to resolve global `this`")};Js.exports=function(){if(this)return this;if(typeof globalThis=="object"&&globalThis)return globalThis;try{Object.defineProperty(Object.prototype,"__global__",{get:function(){return this},configurable:!0})}catch(r){return Qs()}try{return __global__||Qs()}finally{delete Object.prototype.__global__}}()});var Zs=b((Gu,Xs)=>{Xs.exports={_from:"websocket@^1.0.33",_id:"websocket@1.0.33",_inBundle:!1,_integrity:"sha512-XwNqM2rN5eh3G2CUQE3OHZj+0xfdH42+OFK6LdC2yqiC0YU8e5UK0nYre220T0IyyN031V/XOvtHvXozvJYFWA==",_location:"/websocket",_phantomChildren:{},_requested:{type:"range",registry:!0,raw:"websocket@^1.0.33",name:"websocket",escapedName:"websocket",rawSpec:"^1.0.33",saveSpec:null,fetchSpec:"^1.0.33"},_requiredBy:["/protoo-client"],_resolved:"https://registry.npmjs.org/websocket/-/websocket-1.0.33.tgz",_shasum:"407f763fc58e74a3fa41ca3ae5d78d3f5e3b82a5",_spec:"websocket@^1.0.33",_where:"C:\\WebstormProjects\\lightstream-webrtc-client\\node_modules\\protoo-client",author:{name:"Brian McKelvey",email:"theturtle32@gmail.com",url:"https://github.com/theturtle32"},browser:"lib/browser.js",bugs:{url:"https://github.com/theturtle32/WebSocket-Node/issues"},bundleDependencies:!1,config:{verbose:!1},contributors:[{name:"I\xF1aki Baz Castillo",email:"ibc@aliax.net",url:"http://dev.sipdoc.net"}],dependencies:{bufferutil:"^4.0.1",debug:"^2.2.0","es5-ext":"^0.10.50","typedarray-to-buffer":"^3.1.5","utf-8-validate":"^5.0.2",yaeti:"^0.0.6"},deprecated:!1,description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",devDependencies:{"buffer-equal":"^1.0.0",gulp:"^4.0.2","gulp-jshint":"^2.0.4",jshint:"^2.0.0","jshint-stylish":"^2.2.1",tape:"^4.9.1"},directories:{lib:"./lib"},engines:{node:">=4.0.0"},homepage:"https://github.com/theturtle32/WebSocket-Node",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],license:"Apache-2.0",main:"index",name:"websocket",repository:{type:"git",url:"git+https://github.com/theturtle32/WebSocket-Node.git"},scripts:{gulp:"gulp",test:"tape test/unit/*.js"},version:"1.0.33"}});var ta=b((Ku,ea)=>{ea.exports=Zs().version});var na=b((Hu,ra)=>{var Ct;try{Ct=Ys()}catch(r){}finally{if(!Ct&&typeof window!="undefined"&&(Ct=window),!Ct)throw new Error("Could not determine global this")}var cr=Ct.WebSocket||Ct.MozWebSocket,Zc=ta();function ia(r,e){var t;return e?t=new cr(r,e):t=new cr(r),t}cr&&["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(r){Object.defineProperty(ia,r,{get:function(){return cr[r]}})});ra.exports={w3cwebsocket:cr?ia:null,version:Zc}});var aa=b((Ju,sa)=>{function ce(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||Infinity,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}sa.exports=ce;ce.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts};ce.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null};ce.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),t=this._timeouts.shift();else return!1;var i=this,n=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},t);return this._options.unref&&n.unref(),!0};ce.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};ce.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};ce.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};ce.prototype.start=ce.prototype.try;ce.prototype.errors=function(){return this._errors};ce.prototype.attempts=function(){return this._attempts};ce.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,i=0;i<this._errors.length;i++){var n=this._errors[i],s=n.message,c=(r[s]||0)+1;r[s]=c,c>=t&&(e=n,t=c)}return e}});var oa=b(it=>{var ed=aa();it.operation=function(r){var e=it.timeouts(r);return new ed(e,{forever:r&&r.forever,unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};it.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:Infinity,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],n=0;n<e.retries;n++)i.push(this.createTimeout(n,e));return r&&r.forever&&!i.length&&i.push(this.createTimeout(n,e)),i.sort(function(s,c){return s-c}),i};it.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,i=Math.round(t*e.minTimeout*Math.pow(e.factor,r));return i=Math.min(i,e.maxTimeout),i};it.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var i in r)typeof r[i]=="function"&&t.push(i)}for(var n=0;n<t.length;n++){var s=t[n],c=r[s];r[s]=function(o){var d=it.operation(e),l=Array.prototype.slice.call(arguments,1),p=l.pop();l.push(function(u){d.retry(u)||(u&&(arguments[0]=d.mainError()),p.apply(this,arguments))}),d.attempt(function(){o.apply(r,l)})}.bind(r,c),r[s].options=e}}});var da=b((Yu,ca)=>{ca.exports=oa()});var ua=b((Xu,pa)=>{var td=na().w3cwebsocket,rd=da(),id=ar(),nd=Vi(),sd=Gi(),ad="protoo",od={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:8*1e3},Me=new id("WebSocketTransport"),la=class extends nd{constructor(e,t){super(Me);Me.debug("constructor() [url:%s, options:%o]",e,t),this._closed=!1,this._url=e,this._options=t||{},this._ws=null,this._runWebSocket()}get closed(){return this._closed}close(){if(!this._closed){Me.debug("close()"),this._closed=!0,this.safeEmit("close");try{this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=null,this._ws.onmessage=null,this._ws.close()}catch(e){Me.error("close() | error closing the WebSocket: %o",e)}}}send(e){return m(this,null,function*(){if(this._closed)throw new Error("transport closed");try{this._ws.send(JSON.stringify(e))}catch(t){throw Me.warn("send() failed:%o",t),t}})}_runWebSocket(){let e=rd.operation(this._options.retry||od),t=!1;e.attempt(i=>{if(this._closed){e.stop();return}Me.debug("_runWebSocket() [currentAttempt:%s]",i),this._ws=new td(this._url,ad,this._options.origin,this._options.headers,this._options.requestOptions,this._options.clientConfig),this._ws.onopen=()=>{this._closed||(t=!0,this.safeEmit("open"))},this._ws.onclose=n=>{if(!this._closed){if(Me.warn('WebSocket "close" event [wasClean:%s, code:%s, reason:"%s"]',n.wasClean,n.code,n.reason),n.code!==4e3){if(t){if(e.stop(),this.safeEmit("disconnected"),this._closed)return;this._runWebSocket();return}else if(this.safeEmit("failed",i),this._closed||e.retry(!0))return}this._closed=!0,this.safeEmit("close")}},this._ws.onerror=()=>{this._closed||Me.error('WebSocket "error" event')},this._ws.onmessage=n=>{if(this._closed)return;let s=sd.parse(n.data);if(!!s){if(this.listenerCount("message")===0){Me.error('no listeners for WebSocket "message" event, ignoring received message');return}this.safeEmit("message",s)}}})}};pa.exports=la});var fa=b(zr=>{var{version:cd}=Ts(),dd=Hs(),pd=ua();zr.version=cd;zr.Peer=dd;zr.WebSocketTransport=pd});var Z=b(Ki=>{"use strict";Object.defineProperty(Ki,"__esModule",{value:!0});var xt=Br(),Pt="mediasoup-client",ha=class{constructor(e){e?(this._debug=xt.default(`${Pt}:${e}`),this._warn=xt.default(`${Pt}:WARN:${e}`),this._error=xt.default(`${Pt}:ERROR:${e}`)):(this._debug=xt.default(Pt),this._warn=xt.default(`${Pt}:WARN`),this._error=xt.default(`${Pt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};Ki.Logger=ha});var Ue=b(Hi=>{"use strict";Object.defineProperty(Hi,"__esModule",{value:!0});var ld=Wi(),ud=Z(),ma=new ud.Logger("EnhancedEventEmitter"),ga=class extends ld.EventEmitter{constructor(){super();this.setMaxListeners(Infinity)}safeEmit(e,...t){let i=this.listenerCount(e);try{return this.emit(e,...t)}catch(n){return ma.error("safeEmit() | event listener threw an error [event:%s]:%o",e,n),Boolean(i)}}safeEmitAsPromise(e,...t){return m(this,null,function*(){return new Promise((i,n)=>{try{this.emit(e,...t,i,n)}catch(s){ma.error("safeEmitAsPromise() | event listener threw an error [event:%s]:%o",e,s),n(s)}})})}};Hi.EnhancedEventEmitter=ga});var he=b(Wr=>{"use strict";Object.defineProperty(Wr,"__esModule",{value:!0});var Vr=class extends Error{constructor(e){super(e);this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Vr):this.stack=new Error(e).stack}};Wr.UnsupportedError=Vr;var Gr=class extends Error{constructor(e){super(e);this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Gr):this.stack=new Error(e).stack}};Wr.InvalidStateError=Gr});var ie=b(Kr=>{"use strict";Object.defineProperty(Kr,"__esModule",{value:!0});function fd(r,e){return typeof r=="undefined"?e:JSON.parse(JSON.stringify(r))}Kr.clone=fd;function hd(){return Math.round(Math.random()*1e7)}Kr.generateRandomNumber=hd});var Ia=b(M=>{var nt=Br()("h264-profile-level-id");nt.log=console.info.bind(console);var st=1,dr=2,Hr=3,Ji=4,Qi=5;M.ProfileConstrainedBaseline=st;M.ProfileBaseline=dr;M.ProfileMain=Hr;M.ProfileConstrainedHigh=Ji;M.ProfileHigh=Qi;var Dt=0,Jr=10,Yi=11,va=12,_a=13,ya=20,wa=21,Sa=22,ba=30,Xi=31,Ra=32,Ta=40,Ea=41,Ca=42,xa=50,Pa=51,Da=52;M.Level1_b=Dt;M.Level1=Jr;M.Level1_1=Yi;M.Level1_2=va;M.Level1_3=_a;M.Level2=ya;M.Level2_1=wa;M.Level2_2=Sa;M.Level3=ba;M.Level3_1=Xi;M.Level3_2=Ra;M.Level4=Ta;M.Level4_1=Ea;M.Level4_2=Ca;M.Level5=xa;M.Level5_1=Pa;M.Level5_2=Da;var pr=class{constructor(e,t){this.profile=e,this.level=t}};M.ProfileLevelId=pr;var md=new pr(st,Xi),gd=16,ke=class{constructor(e){this._mask=~Ma("x",e),this._maskedValue=Ma("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}},Ie=class{constructor(e,t,i){this.profile_idc=e,this.profile_iop=t,this.profile=i}},vd=[new Ie(66,new ke("x1xx0000"),st),new Ie(77,new ke("1xxx0000"),st),new Ie(88,new ke("11xx0000"),st),new Ie(66,new ke("x0xx0000"),dr),new Ie(88,new ke("10xx0000"),dr),new Ie(77,new ke("0x0x0000"),Hr),new Ie(100,new ke("00000000"),Qi),new Ie(100,new ke("00001100"),Ji)];M.parseProfileLevelId=function(r){if(typeof r!="string"||r.length!==6)return null;let e=parseInt(r,16);if(e===0)return null;let t=e&255,i=e>>8&255,n=e>>16&255,s;switch(t){case Yi:{s=(i&gd)!=0?Dt:Yi;break}case Jr:case va:case _a:case ya:case wa:case Sa:case ba:case Xi:case Ra:case Ta:case Ea:case Ca:case xa:case Pa:case Da:{s=t;break}default:return nt("parseProfileLevelId() | unrecognized level_idc:%s",t),null}for(let c of vd)if(n===c.profile_idc&&c.profile_iop.isMatch(i))return new pr(c.profile,s);return nt("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null};M.profileLevelIdToString=function(r){if(r.level==Dt)switch(r.profile){case st:return"42f00b";case dr:return"42100b";case Hr:return"4d100b";default:return nt("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",r.profile),null}let e;switch(r.profile){case st:{e="42e0";break}case dr:{e="4200";break}case Hr:{e="4d00";break}case Ji:{e="640c";break}case Qi:{e="6400";break}default:return nt("profileLevelIdToString() | unrecognized profile:%s",r.profile),null}let t=r.level.toString(16);return t.length===1&&(t=`0${t}`),`${e}${t}`};M.parseSdpProfileLevelId=function(r={}){let e=r["profile-level-id"];return e?M.parseProfileLevelId(e):md};M.isSameProfile=function(r={},e={}){let t=M.parseSdpProfileLevelId(r),i=M.parseSdpProfileLevelId(e);return Boolean(t&&i&&t.profile===i.profile)};M.generateProfileLevelIdForAnswer=function(r={},e={}){if(!r["profile-level-id"]&&!e["profile-level-id"])return nt("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;let t=M.parseSdpProfileLevelId(r),i=M.parseSdpProfileLevelId(e);if(!t)throw new TypeError("invalid local_profile_level_id");if(!i)throw new TypeError("invalid remote_profile_level_id");if(t.profile!==i.profile)throw new TypeError("H264 Profile mismatch");let n=ka(r)&&ka(e),s=t.level,c=i.level,a=_d(s,c),o=n?s:a;return nt("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",t.profile,o),M.profileLevelIdToString(new pr(t.profile,o))};function Ma(r,e){return(e[0]===r)<<7|(e[1]===r)<<6|(e[2]===r)<<5|(e[3]===r)<<4|(e[4]===r)<<3|(e[5]===r)<<2|(e[6]===r)<<1|(e[7]===r)<<0}function yd(r,e){return r===Dt?e!==Jr&&e!==Dt:e===Dt?r!==Jr:r<e}function _d(r,e){return yd(r,e)?r:e}function ka(r={}){let e=r["level-asymmetry-allowed"];return e===1||e==="1"}});var de=b(J=>{"use strict";Object.defineProperty(J,"__esModule",{value:!0});var La=Ia(),wd=ie(),Sd="probator",bd=1234,Rd=127;function Td(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(r.codecs&&!Array.isArray(r.codecs))throw new TypeError("caps.codecs is not an array");r.codecs||(r.codecs=[]);for(let e of r.codecs)Oa(e);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(let e of r.headerExtensions)Aa(e)}J.validateRtpCapabilities=Td;function Oa(r){let e=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");let t=e.exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(r.kind=t[1].toLowerCase(),r.preferredPayloadType&&typeof r.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");r.kind==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let i of Object.keys(r.parameters)){let n=r.parameters[i];if(n===void 0&&(r.parameters[i]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${i}s, value:${n}]`);if(i==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(let i of r.rtcpFeedback)Zi(i)}J.validateRtpCodecCapability=Oa;function Zi(r){if(typeof r!="object")throw new TypeError("fb is not an object");if(!r.type||typeof r.type!="string")throw new TypeError("missing fb.type");(!r.parameter||typeof r.parameter!="string")&&(r.parameter="")}J.validateRtcpFeedback=Zi;function Aa(r){if(typeof r!="object")throw new TypeError("ext is not an object");if((!r.kind||typeof r.kind!="string")&&(r.kind=""),r.kind!==""&&r.kind!=="audio"&&r.kind!=="video")throw new TypeError("invalid ext.kind");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.preferredId!="number")throw new TypeError("missing ext.preferredId");if(r.preferredEncrypt&&typeof r.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(r.preferredEncrypt||(r.preferredEncrypt=!1),r.direction&&typeof r.direction!="string")throw new TypeError("invalid ext.direction");r.direction||(r.direction="sendrecv")}J.validateRtpHeaderExtension=Aa;function en(r){if(typeof r!="object")throw new TypeError("params is not an object");if(r.mid&&typeof r.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(r.codecs))throw new TypeError("missing params.codecs");for(let e of r.codecs)ja(e);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("params.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(let e of r.headerExtensions)Na(e);if(r.encodings&&!Array.isArray(r.encodings))throw new TypeError("params.encodings is not an array");r.encodings||(r.encodings=[]);for(let e of r.encodings)Fa(e);if(r.rtcp&&typeof r.rtcp!="object")throw new TypeError("params.rtcp is not an object");r.rtcp||(r.rtcp={}),qa(r.rtcp)}J.validateRtpParameters=en;function ja(r){let e=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");let t=e.exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(typeof r.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");t[1].toLowerCase()==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let n of Object.keys(r.parameters)){let s=r.parameters[n];if(s===void 0&&(r.parameters[n]="",s=""),typeof s!="string"&&typeof s!="number")throw new TypeError(`invalid codec parameter [key:${n}s, value:${s}]`);if(n==="apt"&&typeof s!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(let n of r.rtcpFeedback)Zi(n)}J.validateRtpCodecParameters=ja;function Na(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.id!="number")throw new TypeError("missing ext.id");if(r.encrypt&&typeof r.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");r.encrypt||(r.encrypt=!1),(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let e of Object.keys(r.parameters)){let t=r.parameters[e];if(t===void 0&&(r.parameters[e]="",t=""),typeof t!="string"&&typeof t!="number")throw new TypeError("invalid header extension parameter")}}J.validateRtpHeaderExtensionParameters=Na;function Fa(r){if(typeof r!="object")throw new TypeError("encoding is not an object");if(r.ssrc&&typeof r.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(r.rid&&typeof r.rid!="string")throw new TypeError("invalid encoding.rid");if(r.rtx&&typeof r.rtx!="object")throw new TypeError("invalid encoding.rtx");if(r.rtx&&typeof r.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!r.dtx||typeof r.dtx!="boolean")&&(r.dtx=!1),r.scalabilityMode&&typeof r.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}J.validateRtpEncodingParameters=Fa;function qa(r){if(typeof r!="object")throw new TypeError("rtcp is not an object");if(r.cname&&typeof r.cname!="string")throw new TypeError("invalid rtcp.cname");(!r.reducedSize||typeof r.reducedSize!="boolean")&&(r.reducedSize=!0)}J.validateRtcpParameters=qa;function Ed(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(!r.numStreams||typeof r.numStreams!="object")throw new TypeError("missing caps.numStreams");Ba(r.numStreams)}J.validateSctpCapabilities=Ed;function Ba(r){if(typeof r!="object")throw new TypeError("numStreams is not an object");if(typeof r.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof r.MIS!="number")throw new TypeError("missing numStreams.MIS")}J.validateNumSctpStreams=Ba;function Cd(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.port!="number")throw new TypeError("missing params.port");if(typeof r.OS!="number")throw new TypeError("missing params.OS");if(typeof r.MIS!="number")throw new TypeError("missing params.MIS");if(typeof r.maxMessageSize!="number")throw new TypeError("missing params.maxMessageSize")}J.validateSctpParameters=Cd;function xd(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.streamId!="number")throw new TypeError("missing params.streamId");let e=!1;if(typeof r.ordered=="boolean"?e=!0:r.ordered=!0,r.maxPacketLifeTime&&typeof r.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(r.maxRetransmits&&typeof r.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(r.maxPacketLifeTime&&r.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(e&&r.ordered&&(r.maxPacketLifeTime||r.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!e&&(r.maxPacketLifeTime||r.maxRetransmits)&&(r.ordered=!1),r.priority&&typeof r.priority!="string")throw new TypeError("invalid params.priority");if(r.label&&typeof r.label!="string")throw new TypeError("invalid params.label");if(r.protocol&&typeof r.protocol!="string")throw new TypeError("invalid params.protocol")}J.validateSctpStreamParameters=xd;function Md(r,e){let t={codecs:[],headerExtensions:[]};for(let i of e.codecs||[]){if(lr(i))continue;let n=(r.codecs||[]).find(c=>Ua(c,i,{strict:!0,modify:!0}));if(!n)continue;let s={mimeType:n.mimeType,kind:n.kind,clockRate:n.clockRate,channels:n.channels,localPayloadType:n.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:i.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:n.parameters,remoteParameters:i.parameters,rtcpFeedback:Dd(n,i)};t.codecs.push(s)}for(let i of t.codecs){let n=r.codecs.find(c=>lr(c)&&c.parameters.apt===i.localPayloadType),s=e.codecs.find(c=>lr(c)&&c.parameters.apt===i.remotePayloadType);n&&s&&(i.localRtxPayloadType=n.preferredPayloadType,i.remoteRtxPayloadType=s.preferredPayloadType)}for(let i of e.headerExtensions){let n=r.headerExtensions.find(c=>Pd(c,i));if(!n)continue;let s={kind:i.kind,uri:i.uri,sendId:n.preferredId,recvId:i.preferredId,encrypt:n.preferredEncrypt,direction:"sendrecv"};switch(i.direction){case"sendrecv":s.direction="sendrecv";break;case"recvonly":s.direction="sendonly";break;case"sendonly":s.direction="recvonly";break;case"inactive":s.direction="inactive";break}t.headerExtensions.push(s)}return t}J.getExtendedRtpCapabilities=Md;function kd(r){let e={codecs:[],headerExtensions:[]};for(let t of r.codecs){let i={mimeType:t.mimeType,kind:t.kind,preferredPayloadType:t.remotePayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(i),!t.remoteRtxPayloadType)continue;let n={mimeType:`${t.kind}/rtx`,kind:t.kind,preferredPayloadType:t.remoteRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.remotePayloadType},rtcpFeedback:[]};e.codecs.push(n)}for(let t of r.headerExtensions){if(t.direction!=="sendrecv"&&t.direction!=="recvonly")continue;let i={kind:t.kind,uri:t.uri,preferredId:t.recvId,preferredEncrypt:t.encrypt,direction:t.direction};e.headerExtensions.push(i)}return e}J.getRecvRtpCapabilities=kd;function Id(r,e){let t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(let i of e.codecs){if(i.kind!==r)continue;let n={mimeType:i.mimeType,payloadType:i.localPayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.localParameters,rtcpFeedback:i.rtcpFeedback};if(t.codecs.push(n),i.localRtxPayloadType){let s={mimeType:`${i.kind}/rtx`,payloadType:i.localRtxPayloadType,clockRate:i.clockRate,parameters:{apt:i.localPayloadType},rtcpFeedback:[]};t.codecs.push(s)}}for(let i of e.headerExtensions){if(i.kind&&i.kind!==r||i.direction!=="sendrecv"&&i.direction!=="sendonly")continue;let n={uri:i.uri,id:i.sendId,encrypt:i.encrypt,parameters:{}};t.headerExtensions.push(n)}return t}J.getSendingRtpParameters=Id;function Ld(r,e){let t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(let i of e.codecs){if(i.kind!==r)continue;let n={mimeType:i.mimeType,payloadType:i.localPayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.remoteParameters,rtcpFeedback:i.rtcpFeedback};if(t.codecs.push(n),i.localRtxPayloadType){let s={mimeType:`${i.kind}/rtx`,payloadType:i.localRtxPayloadType,clockRate:i.clockRate,parameters:{apt:i.localPayloadType},rtcpFeedback:[]};t.codecs.push(s)}}for(let i of e.headerExtensions){if(i.kind&&i.kind!==r||i.direction!=="sendrecv"&&i.direction!=="sendonly")continue;let n={uri:i.uri,id:i.sendId,encrypt:i.encrypt,parameters:{}};t.headerExtensions.push(n)}if(t.headerExtensions.some(i=>i.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(let i of t.codecs)i.rtcpFeedback=(i.rtcpFeedback||[]).filter(n=>n.type!=="goog-remb");else if(t.headerExtensions.some(i=>i.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(let i of t.codecs)i.rtcpFeedback=(i.rtcpFeedback||[]).filter(n=>n.type!=="transport-cc");else for(let i of t.codecs)i.rtcpFeedback=(i.rtcpFeedback||[]).filter(n=>n.type!=="transport-cc"&&n.type!=="goog-remb");return t}J.getSendingRemoteRtpParameters=Ld;function Od(r,e){let t=[];if(!e)t.push(r[0]),lr(r[1])&&t.push(r[1]);else{for(let i=0;i<r.length;++i)if(Ua(r[i],e)){t.push(r[i]),lr(r[i+1])&&t.push(r[i+1]);break}if(t.length===0)throw new TypeError("no matching codec found")}return t}J.reduceCodecs=Od;function Ad(r){r=wd.clone(r,{}),en(r);let e={mid:Sd,codecs:[],headerExtensions:[],encodings:[{ssrc:bd}],rtcp:{cname:"probator"}};return e.codecs.push(r.codecs[0]),e.codecs[0].payloadType=Rd,e.headerExtensions=r.headerExtensions,e}J.generateProbatorRtpParameters=Ad;function jd(r,e){return e.codecs.some(t=>t.kind===r)}J.canSend=jd;function Nd(r,e){if(en(r),r.codecs.length===0)return!1;let t=r.codecs[0];return e.codecs.some(i=>i.remotePayloadType===t.payloadType)}J.canReceive=Nd;function lr(r){return r?/.+\/rtx$/i.test(r.mimeType):!1}function Ua(r,e,{strict:t=!1,modify:i=!1}={}){let n=r.mimeType.toLowerCase(),s=e.mimeType.toLowerCase();if(n!==s||r.clockRate!==e.clockRate||r.channels!==e.channels)return!1;switch(n){case"video/h264":{let c=r.parameters["packetization-mode"]||0,a=e.parameters["packetization-mode"]||0;if(c!==a)return!1;if(t){if(!La.isSameProfile(r.parameters,e.parameters))return!1;let o;try{o=La.generateProfileLevelIdForAnswer(r.parameters,e.parameters)}catch(d){return!1}i&&(o?(r.parameters["profile-level-id"]=o,e.parameters["profile-level-id"]=o):(delete r.parameters["profile-level-id"],delete e.parameters["profile-level-id"]))}break}case"video/vp9":{if(t){let c=r.parameters["profile-id"]||0,a=e.parameters["profile-id"]||0;if(c!==a)return!1}break}}return!0}function Pd(r,e){return!(r.kind&&e.kind&&r.kind!==e.kind||r.uri!==e.uri)}function Dd(r,e){let t=[];for(let i of r.rtcpFeedback||[]){let n=(e.rtcpFeedback||[]).find(s=>s.type===i.type&&(s.parameter===i.parameter||!s.parameter&&!i.parameter));n&&t.push(n)}return t}});var za=b(ur=>{"use strict";var tn=ur&&ur.__awaiter||function(r,e,t,i){function n(s){return s instanceof t?s:new t(function(c){c(s)})}return new(t||(t=Promise))(function(s,c){function a(l){try{d(i.next(l))}catch(p){c(p)}}function o(l){try{d(i.throw(l))}catch(p){c(p)}}function d(l){l.done?s(l.value):n(l.value).then(a,o)}d((i=i.apply(r,e||[])).next())})};Object.defineProperty(ur,"__esModule",{value:!0});var $a=class{constructor({ClosedErrorClass:e=Error,StoppedErrorClass:t=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.ClosedErrorClass=e,this.StoppedErrorClass=t}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(let e of this.pendingTasks)e.stopped=!0,e.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0}}push(e,t){return tn(this,void 0,void 0,function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if(typeof e!="function")throw new TypeError("given task is not a function");if(!e.name&&t)try{Object.defineProperty(e,"name",{value:t})}catch(i){}return new Promise((i,n)=>{let s={task:e,name:t,resolve:i,reject:n,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(s),this.pendingTasks.length===1&&this.next()})})}stop(){if(!this.closed){for(let e of this.pendingTasks)e.stopped=!0,e.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0}}dump(){let e=new Date;return this.pendingTasks.map(t=>({task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt.getTime()-t.enqueuedAt.getTime():e.getTime()-t.enqueuedAt.getTime(),executingTime:t.executedAt?e.getTime()-t.executedAt.getTime():0}))}next(){return tn(this,void 0,void 0,function*(){let e=this.pendingTasks[0];!e||(yield this.executeTask(e),this.pendingTasks.shift(),this.next())})}executeTask(e){return tn(this,void 0,void 0,function*(){if(!e.stopped){e.executedAt=new Date;try{let t=yield e.task();if(e.stopped)return;e.resolve(t)}catch(t){if(e.stopped)return;e.reject(t)}}})}};ur.AwaitQueue=$a});var nn=b(rn=>{"use strict";Object.defineProperty(rn,"__esModule",{value:!0});var Fd=Z(),Wa=Ue(),Mt=he(),we=new Fd.Logger("Producer"),Va=class extends Wa.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:i,track:n,rtpParameters:s,stopTracks:c,disableTrackOnPause:a,zeroRtpOnPause:o,appData:d}){super();this._closed=!1,this._observer=new Wa.EnhancedEventEmitter,we.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=i,this._track=n,this._kind=n.kind,this._rtpParameters=s,this._paused=a?!n.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=c,this._disableTrackOnPause=a,this._zeroRtpOnPause=o,this._appData=d,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(we.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(we.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}getStats(){return m(this,null,function*(){if(this._closed)throw new Mt.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")})}pause(){if(we.debug("pause()"),this._closed){we.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",null).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(we.debug("resume()"),this._closed){we.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",this._track).catch(()=>{}),this._observer.safeEmit("resume")}replaceTrack(t){return m(this,arguments,function*({track:e}){if(we.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch(i){}throw new Mt.InvalidStateError("closed")}else if(e&&e.readyState==="ended")throw new Mt.InvalidStateError("track ended");if(e===this._track){we.debug("replaceTrack() | same track, ignored");return}(!this._zeroRtpOnPause||!this._paused)&&(yield this.safeEmitAsPromise("@replacetrack",e)),this._destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()})}setMaxSpatialLayer(e){return m(this,null,function*(){if(this._closed)throw new Mt.InvalidStateError("closed");if(this._kind!=="video")throw new Mt.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(yield this.safeEmitAsPromise("@setmaxspatiallayer",e),this._maxSpatialLayer=e)})}setRtpEncodingParameters(e){return m(this,null,function*(){if(this._closed)throw new Mt.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");yield this.safeEmitAsPromise("@setrtpencodingparameters",e)})}_onTrackEnded(){we.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){!this._track||this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){if(!!this._track)try{this._track.removeEventListener("ended",this._onTrackEnded),this._stopTracks&&this._track.stop()}catch(e){}}};rn.Producer=Va});var an=b(sn=>{"use strict";Object.defineProperty(sn,"__esModule",{value:!0});var qd=Z(),Ga=Ue(),Bd=he(),$e=new qd.Logger("Consumer"),Ka=class extends Ga.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:i,rtpReceiver:n,track:s,rtpParameters:c,appData:a}){super();this._closed=!1,this._observer=new Ga.EnhancedEventEmitter,$e.debug("constructor()"),this._id=e,this._localId=t,this._producerId=i,this._rtpReceiver=n,this._track=s,this._rtpParameters=c,this._paused=!s.enabled,this._appData=a,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||($e.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||($e.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}getStats(){return m(this,null,function*(){if(this._closed)throw new Bd.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")})}pause(){if($e.debug("pause()"),this._closed){$e.error("pause() | Consumer closed");return}this._paused=!0,this._track.enabled=!1,this._observer.safeEmit("pause")}resume(){if($e.debug("resume()"),this._closed){$e.error("resume() | Consumer closed");return}this._paused=!1,this._track.enabled=!0,this._observer.safeEmit("resume")}_onTrackEnded(){$e.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){try{this._track.removeEventListener("ended",this._onTrackEnded),this._track.stop()}catch(e){}}};sn.Consumer=Ka});var cn=b(on=>{"use strict";Object.defineProperty(on,"__esModule",{value:!0});var Ud=Z(),Ha=Ue(),$d=he(),Le=new Ud.Logger("DataProducer"),Ja=class extends Ha.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:i,appData:n}){super();this._closed=!1,this._observer=new Ha.EnhancedEventEmitter,Le.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=i,this._appData=n,this._handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Le.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Le.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(Le.debug("send()"),this._closed)throw new $d.InvalidStateError("closed");this._dataChannel.send(e)}_handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Le.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?Le.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):Le.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Le.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||Le.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}};on.DataProducer=Ja});var pn=b(dn=>{"use strict";Object.defineProperty(dn,"__esModule",{value:!0});var zd=Z(),Qa=Ue(),at=new zd.Logger("DataConsumer"),Ya=class extends Qa.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:i,sctpStreamParameters:n,appData:s}){super();this._closed=!1,this._observer=new Qa.EnhancedEventEmitter,at.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=i,this._sctpStreamParameters=n,this._appData=s,this._handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(at.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(at.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}_handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(at.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?at.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):at.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(at.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}};dn.DataConsumer=Ya});var fn=b(ln=>{"use strict";Object.defineProperty(ln,"__esModule",{value:!0});var Wd=za(),Vd=Z(),Xa=Ue(),ee=he(),un=ie(),fr=de(),Gd=nn(),Kd=an(),Hd=cn(),Jd=pn(),pe=new Vd.Logger("Transport"),Za=class extends Xa.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:s,sctpParameters:c,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:l,appData:p,handlerFactory:u,extendedRtpCapabilities:f,canProduceByKind:h}){super();this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new Wd.AwaitQueue({ClosedErrorClass:ee.InvalidStateError}),this._observer=new Xa.EnhancedEventEmitter,pe.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=f,this._canProduceByKind=h,this._maxSctpMessageSize=c?c.maxMessageSize:null,d=un.clone(d,{}),delete d.iceServers,delete d.iceTransportPolicy,delete d.bundlePolicy,delete d.rtcpMuxPolicy,delete d.sdpSemantics,this._handler=u(),this._handler.run({direction:e,iceParameters:i,iceCandidates:n,dtlsParameters:s,sctpParameters:c,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:l,extendedRtpCapabilities:f}),this._appData=p,this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){if(!this._closed){pe.debug("close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(let e of this._producers.values())e.transportClosed();this._producers.clear();for(let e of this._consumers.values())e.transportClosed();this._consumers.clear();for(let e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(let e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}getStats(){return m(this,null,function*(){if(this._closed)throw new ee.InvalidStateError("closed");return this._handler.getTransportStats()})}restartIce(t){return m(this,arguments,function*({iceParameters:e}){if(pe.debug("restartIce()"),this._closed)throw new ee.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(()=>m(this,null,function*(){return this._handler.restartIce(e)}),"transport.restartIce()")})}updateIceServers(){return m(this,arguments,function*({iceServers:e}={}){if(pe.debug("updateIceServers()"),this._closed)throw new ee.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(()=>m(this,null,function*(){return this._handler.updateIceServers(e)}),"transport.updateIceServers()")})}produce(){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n,stopTracks:s=!0,disableTrackOnPause:c=!0,zeroRtpOnPause:a=!1,appData:o={}}={}){if(pe.debug("produce() [track:%o]",e),e){if(this._direction!=="send")throw new ee.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new ee.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new ee.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(()=>m(this,null,function*(){let d;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?d=void 0:t&&(d=t.map(f=>{let h={active:!0};return f.active===!1&&(h.active=!1),typeof f.dtx=="boolean"&&(h.dtx=f.dtx),typeof f.scalabilityMode=="string"&&(h.scalabilityMode=f.scalabilityMode),typeof f.scaleResolutionDownBy=="number"&&(h.scaleResolutionDownBy=f.scaleResolutionDownBy),typeof f.maxBitrate=="number"&&(h.maxBitrate=f.maxBitrate),typeof f.maxFramerate=="number"&&(h.maxFramerate=f.maxFramerate),typeof f.adaptivePtime=="boolean"&&(h.adaptivePtime=f.adaptivePtime),typeof f.priority=="string"&&(h.priority=f.priority),typeof f.networkPriority=="string"&&(h.networkPriority=f.networkPriority),h}));let{localId:l,rtpParameters:p,rtpSender:u}=yield this._handler.send({track:e,encodings:d,codecOptions:i,codec:n});try{fr.validateRtpParameters(p);let{id:f}=yield this.safeEmitAsPromise("produce",{kind:e.kind,rtpParameters:p,appData:o}),h=new Gd.Producer({id:f,localId:l,rtpSender:u,track:e,rtpParameters:p,stopTracks:s,disableTrackOnPause:c,zeroRtpOnPause:a,appData:o});return this._producers.set(h.id,h),this._handleProducer(h),this._observer.safeEmit("newproducer",h),h}catch(f){throw this._handler.stopSending(l).catch(()=>{}),f}}),"transport.produce()").catch(d=>{if(s)try{e.stop()}catch(l){}throw d})})}consume(c){return m(this,arguments,function*({id:e,producerId:t,kind:i,rtpParameters:n,appData:s={}}){if(pe.debug("consume()"),n=un.clone(n,void 0),this._closed)throw new ee.InvalidStateError("closed");if(this._direction!=="recv")throw new ee.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(i!=="audio"&&i!=="video")throw new TypeError(`invalid kind '${i}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(s&&typeof s!="object")throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(()=>m(this,null,function*(){if(!fr.canReceive(n,this._extendedRtpCapabilities))throw new ee.UnsupportedError("cannot consume this Producer");let{localId:o,rtpReceiver:d,track:l}=yield this._handler.receive({trackId:e,kind:i,rtpParameters:n}),p=new Kd.Consumer({id:e,localId:o,producerId:t,rtpReceiver:d,track:l,rtpParameters:n,appData:s});if(this._consumers.set(p.id,p),this._handleConsumer(p),!this._probatorConsumerCreated&&i==="video")try{let u=fr.generateProbatorRtpParameters(p.rtpParameters);yield this._handler.receive({trackId:"probator",kind:"video",rtpParameters:u}),pe.debug("consume() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(u){pe.error("consume() | failed to create Consumer for RTP probation:%o",u)}return this._observer.safeEmit("newconsumer",p),p}),"transport.consume()")})}produceData(){return m(this,arguments,function*({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:i,priority:n="low",label:s="",protocol:c="",appData:a={}}={}){if(pe.debug("produceData()"),this._direction!=="send")throw new ee.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize)if(["very-low","low","medium","high"].includes(n)){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("wrong priority");else throw new ee.UnsupportedError("SCTP not enabled by remote Transport");return(t||i)&&(e=!1),this._awaitQueue.push(()=>m(this,null,function*(){let{dataChannel:o,sctpStreamParameters:d}=yield this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,priority:n,label:s,protocol:c});fr.validateSctpStreamParameters(d);let{id:l}=yield this.safeEmitAsPromise("producedata",{sctpStreamParameters:d,label:s,protocol:c,appData:a}),p=new Hd.DataProducer({id:l,dataChannel:o,sctpStreamParameters:d,appData:a});return this._dataProducers.set(p.id,p),this._handleDataProducer(p),this._observer.safeEmit("newdataproducer",p),p}),"transport.produceData()")})}consumeData(a){return m(this,arguments,function*({id:e,dataProducerId:t,sctpStreamParameters:i,label:n="",protocol:s="",appData:c={}}){if(pe.debug("consumeData()"),i=un.clone(i,void 0),this._closed)throw new ee.InvalidStateError("closed");if(this._direction!=="recv")throw new ee.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(c&&typeof c!="object")throw new TypeError("if given, appData must be an object")}else throw new ee.UnsupportedError("SCTP not enabled by remote Transport");return fr.validateSctpStreamParameters(i),this._awaitQueue.push(()=>m(this,null,function*(){let{dataChannel:o}=yield this._handler.receiveDataChannel({sctpStreamParameters:i,label:n,protocol:s}),d=new Jd.DataConsumer({id:e,dataProducerId:t,dataChannel:o,sctpStreamParameters:i,appData:c});return this._dataConsumers.set(d.id,d),this._handleDataConsumer(d),this._observer.safeEmit("newdataconsumer",d),d}),"transport.consumeData()")})}_handleHandler(){let e=this._handler;e.on("@connect",({dtlsParameters:t},i,n)=>{if(this._closed){n(new ee.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},i,n)}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(pe.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}_handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(()=>m(this,null,function*(){return this._handler.stopSending(e.localId)}),"producer @close event").catch(t=>pe.warn("producer.close() failed:%o",t))}),e.on("@replacetrack",(t,i,n)=>{this._awaitQueue.push(()=>m(this,null,function*(){return this._handler.replaceTrack(e.localId,t)}),"producer @replacetrack event").then(i).catch(n)}),e.on("@setmaxspatiallayer",(t,i,n)=>{this._awaitQueue.push(()=>m(this,null,function*(){return this._handler.setMaxSpatialLayer(e.localId,t)}),"producer @setmaxspatiallayer event").then(i).catch(n)}),e.on("@setrtpencodingparameters",(t,i,n)=>{this._awaitQueue.push(()=>m(this,null,function*(){return this._handler.setRtpEncodingParameters(e.localId,t)}),"producer @setrtpencodingparameters event").then(i).catch(n)}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new ee.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i)})}_handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),!this._closed&&this._awaitQueue.push(()=>m(this,null,function*(){return this._handler.stopReceiving(e.localId)}),"consumer @close event").catch(()=>{})}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new ee.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i)})}_handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}_handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}};ln.Transport=Za});var hn=b((ff,eo)=>{var to=eo.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(to).forEach(function(r){var e=to[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})})});var no=b(Oe=>{var kt=function(r){return String(Number(r))===r?Number(r):r},Qd=function(r,e,t,i){if(i&&!t)e[i]=kt(r[1]);else for(var n=0;n<t.length;n+=1)r[n+1]!=null&&(e[t[n]]=kt(r[n+1]))},Yd=function(r,e,t){var i=r.name&&r.names;r.push&&!e[r.push]?e[r.push]=[]:i&&!e[r.name]&&(e[r.name]={});var n=r.push?{}:i?e[r.name]:e;Qd(t.match(r.reg),n,r.names,r.name),r.push&&e[r.push].push(n)},ro=hn(),Xd=RegExp.prototype.test.bind(/^([a-z])=(.*)/);Oe.parse=function(r){var e={},t=[],i=e;return r.split(/(\r\n|\r|\n)/).filter(Xd).forEach(function(n){var s=n[0],c=n.slice(2);s==="m"&&(t.push({rtp:[],fmtp:[]}),i=t[t.length-1]);for(var a=0;a<(ro[s]||[]).length;a+=1){var o=ro[s][a];if(o.reg.test(c))return Yd(o,i,c)}}),e.media=t,e};var io=function(r,e){var t=e.split(/=(.+)/,2);return t.length===2?r[t[0]]=kt(t[1]):t.length===1&&e.length>1&&(r[t[0]]=void 0),r};Oe.parseParams=function(r){return r.split(/;\s?/).reduce(io,{})};Oe.parseFmtpConfig=Oe.parseParams;Oe.parsePayloads=function(r){return r.toString().split(" ").map(Number)};Oe.parseRemoteCandidates=function(r){for(var e=[],t=r.split(" ").map(kt),i=0;i<t.length;i+=3)e.push({component:t[i],ip:t[i+1],port:t[i+2]});return e};Oe.parseImageAttributes=function(r){return r.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(io,{})})};Oe.parseSimulcastStreamList=function(r){return r.split(";").map(function(e){return e.split(",").map(function(t){var i,n=!1;return t[0]!=="~"?i=kt(t):(i=kt(t.substring(1,t.length)),n=!0),{scid:i,paused:n}})})}});var ao=b((mf,so)=>{var mn=hn(),Zd=/%[sdv%]/g,ep=function(r){var e=1,t=arguments,i=t.length;return r.replace(Zd,function(n){if(e>=i)return n;var s=t[e];switch(e+=1,n){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}})},hr=function(r,e,t){var i=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,n=[r+"="+i];if(e.names)for(var s=0;s<e.names.length;s+=1){var c=e.names[s];e.name?n.push(t[e.name][c]):n.push(t[e.names[s]])}else n.push(t[e.name]);return ep.apply(null,n)},tp=["v","o","s","i","u","e","p","c","b","t","r","z","a"],rp=["i","c","b","a"];so.exports=function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(s){s.payloads==null&&(s.payloads="")});var t=e.outerOrder||tp,i=e.innerOrder||rp,n=[];return t.forEach(function(s){mn[s].forEach(function(c){c.name in r&&r[c.name]!=null?n.push(hr(s,c,r)):c.push in r&&r[c.push]!=null&&r[c.push].forEach(function(a){n.push(hr(s,c,a))})})}),r.media.forEach(function(s){n.push(hr("m",mn.m[0],s)),i.forEach(function(c){mn[c].forEach(function(a){a.name in s&&s[a.name]!=null?n.push(hr(c,a,s)):a.push in s&&s[a.push]!=null&&s[a.push].forEach(function(o){n.push(hr(c,a,o))})})})}),n.join(`\r
`)+`\r
`}});var me=b(Ae=>{var ot=no(),ip=ao();Ae.write=ip;Ae.parse=ot.parse;Ae.parseParams=ot.parseParams;Ae.parseFmtpConfig=ot.parseFmtpConfig;Ae.parsePayloads=ot.parsePayloads;Ae.parseRemoteCandidates=ot.parseRemoteCandidates;Ae.parseImageAttributes=ot.parseImageAttributes;Ae.parseSimulcastStreamList=ot.parseSimulcastStreamList});var je=b(It=>{"use strict";Object.defineProperty(It,"__esModule",{value:!0});var oo=me();function np({sdpObject:r}){let e=new Map,t=[],i=!1,n=!1;for(let c of r.media){let a=c.type;switch(a){case"audio":{if(i)continue;i=!0;break}case"video":{if(n)continue;n=!0;break}default:continue}for(let o of c.rtp){let d={kind:a,mimeType:`${a}/${o.codec}`,preferredPayloadType:o.payload,clockRate:o.rate,channels:o.encoding,parameters:{},rtcpFeedback:[]};e.set(d.preferredPayloadType,d)}for(let o of c.fmtp||[]){let d=oo.parseParams(o.config),l=e.get(o.payload);!l||(d&&d["profile-level-id"]&&(d["profile-level-id"]=String(d["profile-level-id"])),l.parameters=d)}for(let o of c.rtcpFb||[]){let d=e.get(o.payload);if(!d)continue;let l={type:o.type,parameter:o.subtype};l.parameter||delete l.parameter,d.rtcpFeedback.push(l)}for(let o of c.ext||[]){if(o["encrypt-uri"])continue;let d={kind:a,uri:o.uri,preferredId:o.value};t.push(d)}}return{codecs:Array.from(e.values()),headerExtensions:t}}It.extractRtpCapabilities=np;function sp({sdpObject:r}){let e=(r.media||[]).find(s=>s.iceUfrag&&s.port!==0);if(!e)throw new Error("no active media section found");let t=e.fingerprint||r.fingerprint,i;switch(e.setup){case"active":i="client";break;case"passive":i="server";break;case"actpass":i="auto";break}return{role:i,fingerprints:[{algorithm:t.type,value:t.hash}]}}It.extractDtlsParameters=sp;function ap({offerMediaObject:r}){let e=(r.ssrcs||[]).find(t=>t.attribute==="cname");return e?e.value:""}It.getCname=ap;function op({offerRtpParameters:r,answerMediaObject:e}){for(let t of r.codecs){let i=t.mimeType.toLowerCase();if(i!=="audio/opus"||!(e.rtp||[]).find(a=>a.payload===t.payloadType))continue;e.fmtp=e.fmtp||[];let s=e.fmtp.find(a=>a.payload===t.payloadType);s||(s={payload:t.payloadType,config:""},e.fmtp.push(s));let c=oo.parseParams(s.config);switch(i){case"audio/opus":{let a=t.parameters["sprop-stereo"];a!==void 0&&(c.stereo=a?1:0);break}}s.config="";for(let a of Object.keys(c))s.config&&(s.config+=";"),s.config+=`${a}=${c[a]}`}}It.applyCodecParameters=op});var mr=b(Qr=>{"use strict";Object.defineProperty(Qr,"__esModule",{value:!0});function cp({offerMediaObject:r}){let e=new Set;for(let n of r.ssrcs||[]){let s=n.id;e.add(s)}if(e.size===0)throw new Error("no a=ssrc lines found");let t=new Map;for(let n of r.ssrcGroups||[]){if(n.semantics!=="FID")continue;let[s,c]=n.ssrcs.split(/\s+/);s=Number(s),c=Number(c),e.has(s)&&(e.delete(s),e.delete(c),t.set(s,c))}for(let n of e)t.set(n,null);let i=[];for(let[n,s]of t){let c={ssrc:n};s&&(c.rtx={ssrc:s}),i.push(c)}return i}Qr.getRtpEncodings=cp;function dp({offerMediaObject:r,numStreams:e}){if(e<=1)throw new TypeError("numStreams must be greater than 1");let t=(r.ssrcs||[]).find(p=>p.attribute==="msid");if(!t)throw new Error("a=ssrc line with msid information not found");let[i,n]=t.value.split(" ")[0],s=t.id,c;(r.ssrcGroups||[]).some(p=>{if(p.semantics!=="FID")return!1;let u=p.ssrcs.split(/\s+/);return Number(u[0])===s?(c=Number(u[1]),!0):!1});let a=r.ssrcs.find(p=>p.attribute==="cname");if(!a)throw new Error("a=ssrc line with cname information not found");let o=a.value,d=[],l=[];for(let p=0;p<e;++p)d.push(s+p),c&&l.push(c+p);r.ssrcGroups=[],r.ssrcs=[],r.ssrcGroups.push({semantics:"SIM",ssrcs:d.join(" ")});for(let p=0;p<d.length;++p){let u=d[p];r.ssrcs.push({id:u,attribute:"cname",value:o}),r.ssrcs.push({id:u,attribute:"msid",value:`${i} ${n}`})}for(let p=0;p<l.length;++p){let u=d[p],f=l[p];r.ssrcs.push({id:f,attribute:"cname",value:o}),r.ssrcs.push({id:f,attribute:"msid",value:`${i} ${n}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${u} ${f}`})}}Qr.addLegacySimulcast=dp});var ge=b(gn=>{"use strict";Object.defineProperty(gn,"__esModule",{value:!0});var pp=Ue(),co=class extends pp.EnhancedEventEmitter{constructor(){super()}};gn.HandlerInterface=co});var fo=b(gr=>{"use strict";Object.defineProperty(gr,"__esModule",{value:!0});var lp=ie(),Yr=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:n=!1}){if(this._mediaObject={},this._planB=n,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(let s of t){let c={};c.component=1,c.foundation=s.foundation,c.ip=s.ip,c.port=s.port,c.priority=s.priority,c.transport=s.protocol,c.type=s.type,s.tcpType&&(c.tcptype=s.tcpType),this._mediaObject.candidates.push(c)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}i&&this.setDtlsRole(i.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}disable(){this._mediaObject.direction="inactive",delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids}close(){this._mediaObject.direction="inactive",this._mediaObject.port=0,delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}};gr.MediaSection=Yr;var po=class extends Yr{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,plainRtpParameters:s,planB:c=!1,offerMediaObject:a,offerRtpParameters:o,answerRtpParameters:d,codecOptions:l,extmapAllowMixed:p=!1}){super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:c});switch(this._mediaObject.mid=String(a.mid),this._mediaObject.type=a.type,this._mediaObject.protocol=a.protocol,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),a.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(let u of d.codecs){let f={payload:u.payloadType,codec:lo(u),rate:u.clockRate};u.channels>1&&(f.encoding=u.channels),this._mediaObject.rtp.push(f);let h=lp.clone(u.parameters,{});if(l){let{opusStereo:v,opusFec:_,opusDtx:y,opusMaxPlaybackRate:S,opusMaxAverageBitrate:R,opusPtime:E,videoGoogleStartBitrate:L,videoGoogleMaxBitrate:x,videoGoogleMinBitrate:T}=l,C=o.codecs.find(V=>V.payloadType===u.payloadType);switch(u.mimeType.toLowerCase()){case"audio/opus":{v!==void 0&&(C.parameters["sprop-stereo"]=v?1:0,h.stereo=v?1:0),_!==void 0&&(C.parameters.useinbandfec=_?1:0,h.useinbandfec=_?1:0),y!==void 0&&(C.parameters.usedtx=y?1:0,h.usedtx=y?1:0),S!==void 0&&(h.maxplaybackrate=S),R!==void 0&&(h.maxaveragebitrate=R),E!==void 0&&(C.parameters.ptime=E,h.ptime=E);break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{L!==void 0&&(h["x-google-start-bitrate"]=L),x!==void 0&&(h["x-google-max-bitrate"]=x),T!==void 0&&(h["x-google-min-bitrate"]=T);break}}}let g={payload:u.payloadType,config:""};for(let v of Object.keys(h))g.config&&(g.config+=";"),g.config+=`${v}=${h[v]}`;g.config&&this._mediaObject.fmtp.push(g);for(let v of u.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:u.payloadType,type:v.type,subtype:v.parameter})}this._mediaObject.payloads=d.codecs.map(u=>u.payloadType).join(" "),this._mediaObject.ext=[];for(let u of d.headerExtensions)!(a.ext||[]).some(h=>h.uri===u.uri)||this._mediaObject.ext.push({uri:u.uri,value:u.id});if(p&&a.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),a.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:a.simulcast.list1},this._mediaObject.rids=[];for(let u of a.rids||[])u.direction==="send"&&this._mediaObject.rids.push({id:u.id,direction:"recv"})}else if(a.simulcast_03){this._mediaObject.simulcast_03={value:a.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(let u of a.rids||[])u.direction==="send"&&this._mediaObject.rids.push({id:u.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof a.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=n.port,this._mediaObject.maxMessageSize=n.maxMessageSize):a.sctpmap&&(this._mediaObject.payloads=n.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:n.port,maxMessageSize:n.maxMessageSize});break}}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass";break}}};gr.AnswerMediaSection=po;var uo=class extends Yr{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,plainRtpParameters:s,planB:c=!1,mid:a,kind:o,offerRtpParameters:d,streamId:l,trackId:p,oldDataChannelSpec:u=!1}){super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:c});switch(this._mediaObject.mid=String(a),this._mediaObject.type=o,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},n?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),o){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l||"-"} ${p}`);for(let v of d.codecs){let _={payload:v.payloadType,codec:lo(v),rate:v.clockRate};v.channels>1&&(_.encoding=v.channels),this._mediaObject.rtp.push(_);let y={payload:v.payloadType,config:""};for(let S of Object.keys(v.parameters))y.config&&(y.config+=";"),y.config+=`${S}=${v.parameters[S]}`;y.config&&this._mediaObject.fmtp.push(y);for(let S of v.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:v.payloadType,type:S.type,subtype:S.parameter})}this._mediaObject.payloads=d.codecs.map(v=>v.payloadType).join(" "),this._mediaObject.ext=[];for(let v of d.headerExtensions)this._mediaObject.ext.push({uri:v.uri,value:v.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";let f=d.encodings[0],h=f.ssrc,g=f.rtx&&f.rtx.ssrc?f.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],d.rtcp.cname&&this._mediaObject.ssrcs.push({id:h,attribute:"cname",value:d.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:h,attribute:"msid",value:`${l||"-"} ${p}`}),g&&(d.rtcp.cname&&this._mediaObject.ssrcs.push({id:g,attribute:"cname",value:d.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:g,attribute:"msid",value:`${l||"-"} ${p}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${h} ${g}`}));break}case"application":{u?(this._mediaObject.payloads=n.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:n.port,maxMessageSize:n.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=n.port,this._mediaObject.maxMessageSize=n.maxMessageSize);break}}}setDtlsRole(e){this._mediaObject.setup="actpass"}planBReceive({offerRtpParameters:e,streamId:t,trackId:i}){let n=e.encodings[0],s=n.ssrc,c=n.rtx&&n.rtx.ssrc?n.rtx.ssrc:void 0;e.rtcp.cname&&this._mediaObject.ssrcs.push({id:s,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:s,attribute:"msid",value:`${t||"-"} ${i}`}),c&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:c,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:c,attribute:"msid",value:`${t||"-"} ${i}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${s} ${c}`}))}planBStopReceiving({offerRtpParameters:e}){let t=e.encodings[0],i=t.ssrc,n=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(s=>s.id!==i&&s.id!==n),n&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(s=>s.ssrcs!==`${i} ${n}`))}};gr.OfferMediaSection=uo;function lo(r){let t=new RegExp("^(audio|video)/(.+)","i").exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}});var Ne=b(vn=>{"use strict";Object.defineProperty(vn,"__esModule",{value:!0});var up=me(),fp=Z(),Xr=fo(),_n=new fp.Logger("RemoteSdp"),ho=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,plainRtpParameters:s,planB:c=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=i,this._sctpParameters=n,this._plainRtpParameters=s,this._planB=c,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),i){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};let a=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:i.fingerprints[a-1].algorithm,hash:i.fingerprints[a-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}s&&(this._sdpObject.origin.address=s.ip,this._sdpObject.origin.ipVer=s.ipVersion)}updateIceParameters(e){_n.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(let t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){_n.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(let t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){let t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:i,answerRtpParameters:n,codecOptions:s,extmapAllowMixed:c=!1}){let a=new Xr.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:i,answerRtpParameters:n,codecOptions:s,extmapAllowMixed:c});t?this._replaceMediaSection(a,t):this._midToIndex.has(a.mid)?this._replaceMediaSection(a):this._addMediaSection(a)}receive({mid:e,kind:t,offerRtpParameters:i,streamId:n,trackId:s}){let c=this._midToIndex.get(e),a;if(c!==void 0&&(a=this._mediaSections[c]),a)a.planBReceive({offerRtpParameters:i,streamId:n,trackId:s}),this._replaceMediaSection(a);else{a=new Xr.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:n,trackId:s});let o=this._mediaSections.find(d=>d.closed);o?this._replaceMediaSection(a,o.mid):this._addMediaSection(a)}}disableMediaSection(e){let t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found with mid '${e}'`);this._mediaSections[t].disable()}closeMediaSection(e){let t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found with mid '${e}'`);let i=this._mediaSections[t];if(e===this._firstMid){_n.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),this.disableMediaSection(e);return}i.close(),this._regenerateBundleMids()}planBStopReceiving({mid:e,offerRtpParameters:t}){let i=this._midToIndex.get(e);if(i===void 0)throw new Error(`no media section found with mid '${e}'`);let n=this._mediaSections[i];n.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(n)}sendSctpAssociation({offerMediaObject:e}){let t=new Xr.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){let t=new Xr.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,up.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if(typeof t=="string"){let i=this._midToIndex.get(t);if(i===void 0)throw new Error(`no media section found for reuseMid '${t}'`);let n=this._mediaSections[i];this._mediaSections[i]=e,this._midToIndex.delete(n.mid),this._midToIndex.set(e.mid,i),this._sdpObject.media[i]=e.getObject(),this._regenerateBundleMids()}else{let i=this._midToIndex.get(e.mid);if(i===void 0)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[i]=e,this._sdpObject.media[i]=e.getObject()}}_regenerateBundleMids(){!this._dtlsParameters||(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}};vn.RemoteSdp=ho});var Zr=b(yn=>{"use strict";Object.defineProperty(yn,"__esModule",{value:!0});var hp=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function mp(r){let e=hp.exec(r||"");return e?{spatialLayers:Number(e[1]),temporalLayers:Number(e[2])}:{spatialLayers:1,temporalLayers:1}}yn.parse=mp});var vo=b(wn=>{"use strict";Object.defineProperty(wn,"__esModule",{value:!0});var Se=me(),gp=Z(),mo=ie(),Lt=de(),ei=je(),Sn=mr(),vp=ge(),_p=Ne(),yp=Zr(),A=new gp.Logger("Chrome74"),go={OS:1024,MIS:1024},ti=class extends vp.HandlerInterface{constructor(){super();this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new ti}get name(){return"Chrome74"}close(){if(A.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}getNativeRtpCapabilities(){return m(this,null,function*(){A.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");let t=yield e.createOffer();try{e.close()}catch(s){}let i=Se.parse(t.sdp);return ei.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(i){}throw t}})}getNativeSctpCapabilities(){return m(this,null,function*(){return A.debug("getNativeSctpCapabilities()"),{numStreams:go}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){A.debug("run()"),this._direction=e,this._remoteSdp=new _p.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s}),this._sendingRtpParametersByKind={audio:Lt.getSendingRtpParameters("audio",l),video:Lt.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:Lt.getSendingRemoteRtpParameters("audio",l),video:Lt.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(Object.assign({iceServers:c||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},o),d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}updateIceServers(e){return m(this,null,function*(){A.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)})}restartIce(e){return m(this,null,function*(){if(A.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=yield this._pc.createOffer({iceRestart:!0});A.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),yield this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};A.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),yield this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};A.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);let i=yield this._pc.createAnswer();A.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}})}getTransportStats(){return m(this,null,function*(){return this._pc.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){this._assertSendDirection(),A.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((_,y)=>{_.rid=`r${y}`});let c=mo.clone(this._sendingRtpParametersByKind[e.kind],{});c.codecs=Lt.reduceCodecs(c.codecs,n);let a=mo.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});a.codecs=Lt.reduceCodecs(a.codecs,n);let o=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t}),l=yield this._pc.createOffer(),p=Se.parse(l.sdp),u;this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:p}));let f=!1,h=yp.parse((t||[{}])[0].scalabilityMode);t&&t.length===1&&h.spatialLayers>1&&c.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(A.debug("send() | enabling legacy simulcast for VP9 SVC"),f=!0,p=Se.parse(l.sdp),u=p.media[o.idx],Sn.addLegacySimulcast({offerMediaObject:u,numStreams:h.spatialLayers}),l={type:"offer",sdp:Se.write(p)}),A.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),yield this._pc.setLocalDescription(l);let g=d.mid;if(c.mid=g,p=Se.parse(this._pc.localDescription.sdp),u=p.media[o.idx],c.rtcp.cname=ei.getCname({offerMediaObject:u}),!t)c.encodings=Sn.getRtpEncodings({offerMediaObject:u});else if(t.length===1){let _=Sn.getRtpEncodings({offerMediaObject:u});Object.assign(_[0],t[0]),f&&(_=[_[0]]),c.encodings=_}else c.encodings=t;if(c.encodings.length>1&&(c.codecs[0].mimeType.toLowerCase()==="video/vp8"||c.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let _ of c.encodings)_.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:o.reuseMid,offerRtpParameters:c,answerRtpParameters:a,codecOptions:i,extmapAllowMixed:!0});let v={type:"answer",sdp:this._remoteSdp.getSdp()};return A.debug("send() | calling pc.setRemoteDescription() [answer:%o]",v),yield this._pc.setRemoteDescription(v),this._mapMidTransceiver.set(g,d),{localId:g,rtpParameters:c,rtpSender:d.sender}})}stopSending(e){return m(this,null,function*(){this._assertSendDirection(),A.debug("stopSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);let i=yield this._pc.createOffer();A.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};A.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)})}replaceTrack(e,t){return m(this,null,function*(){this._assertSendDirection(),t?A.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):A.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)})}setMaxSpatialLayer(e,t){return m(this,null,function*(){this._assertSendDirection(),A.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((s,c)=>{c<=t?s.active=!0:s.active=!1}),yield i.sender.setParameters(n)})}setRtpEncodingParameters(e,t){return m(this,null,function*(){this._assertSendDirection(),A.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((s,c)=>{n.encodings[c]=Object.assign(Object.assign({},s),t)}),yield i.sender.setParameters(n)})}getSenderStats(e){return m(this,null,function*(){this._assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()})}sendDataChannel(a){return m(this,arguments,function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s,priority:c}){this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s,priority:c};A.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%go.MIS,!this._hasDataChannelMediaSection){let p=yield this._pc.createOffer(),u=Se.parse(p.sdp),f=u.media.find(g=>g.type==="application");this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:u})),A.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),yield this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:f});let h={type:"answer",sdp:this._remoteSdp.getSdp()};A.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:l}})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){this._assertRecvDirection(),A.debug("receive() [trackId:%s, kind:%s]",e,t);let s=i.mid||String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:i,streamId:i.rtcp.cname,trackId:e});let c={type:"offer",sdp:this._remoteSdp.getSdp()};A.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",c),yield this._pc.setRemoteDescription(c);let a=yield this._pc.createAnswer(),o=Se.parse(a.sdp),d=o.media.find(p=>String(p.mid)===s);ei.applyCodecParameters({offerRtpParameters:i,answerMediaObject:d}),a={type:"answer",sdp:Se.write(o)},this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:o})),A.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),yield this._pc.setLocalDescription(a);let l=this._pc.getTransceivers().find(p=>p.mid===s);if(!l)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(s,l),{localId:s,track:l.receiver.track,rtpReceiver:l.receiver}})}stopReceiving(e){return m(this,null,function*(){this._assertRecvDirection(),A.debug("stopReceiving() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);let i={type:"offer",sdp:this._remoteSdp.getSdp()};A.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",i),yield this._pc.setRemoteDescription(i);let n=yield this._pc.createAnswer();A.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",n),yield this._pc.setLocalDescription(n)})}getReceiverStats(e){return m(this,null,function*(){this._assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()})}receiveDataChannel(n){return m(this,arguments,function*({sctpStreamParameters:e,label:t,protocol:i}){this._assertRecvDirection();let{streamId:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o,protocol:i};A.debug("receiveDataChannel() [options:%o]",d);let l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};A.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),yield this._pc.setRemoteDescription(p);let u=yield this._pc.createAnswer();if(!this._transportReady){let f=Se.parse(u.sdp);yield this._setupTransport({localDtlsRole:"client",localSdpObject:f})}A.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),yield this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:l}})}_setupTransport(i){return m(this,arguments,function*({localDtlsRole:e,localSdpObject:t}){t||(t=Se.parse(this._pc.localDescription.sdp));let n=ei.extractDtlsParameters({sdpObject:t});n.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),yield this.safeEmitAsPromise("@connect",{dtlsParameters:n}),this._transportReady=!0})}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};wn.Chrome74=ti});var wo=b(bn=>{"use strict";Object.defineProperty(bn,"__esModule",{value:!0});var le=me(),wp=Z(),_o=ie(),Ot=de(),ri=je(),Rn=mr(),Sp=ge(),bp=Ne(),Rp=Zr(),k=new wp.Logger("Chrome70"),yo={OS:1024,MIS:1024},ii=class extends Sp.HandlerInterface{constructor(){super();this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new ii}get name(){return"Chrome70"}close(){if(k.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}getNativeRtpCapabilities(){return m(this,null,function*(){k.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");let t=yield e.createOffer();try{e.close()}catch(s){}let i=le.parse(t.sdp);return ri.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(i){}throw t}})}getNativeSctpCapabilities(){return m(this,null,function*(){return k.debug("getNativeSctpCapabilities()"),{numStreams:yo}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){k.debug("run()"),this._direction=e,this._remoteSdp=new bp.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s}),this._sendingRtpParametersByKind={audio:Ot.getSendingRtpParameters("audio",l),video:Ot.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:Ot.getSendingRemoteRtpParameters("audio",l),video:Ot.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(Object.assign({iceServers:c||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},o),d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}updateIceServers(e){return m(this,null,function*(){k.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)})}restartIce(e){return m(this,null,function*(){if(k.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=yield this._pc.createOffer({iceRestart:!0});k.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),yield this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};k.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),yield this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};k.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);let i=yield this._pc.createAnswer();k.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}})}getTransportStats(){return m(this,null,function*(){return this._pc.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){this._assertSendDirection(),k.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);let c=_o.clone(this._sendingRtpParametersByKind[e.kind],{});c.codecs=Ot.reduceCodecs(c.codecs,n);let a=_o.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});a.codecs=Ot.reduceCodecs(a.codecs,n);let o=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]}),l=yield this._pc.createOffer(),p=le.parse(l.sdp),u;this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:p})),t&&t.length>1&&(k.debug("send() | enabling legacy simulcast"),p=le.parse(l.sdp),u=p.media[o.idx],Rn.addLegacySimulcast({offerMediaObject:u,numStreams:t.length}),l={type:"offer",sdp:le.write(p)});let f=!1,h=Rp.parse((t||[{}])[0].scalabilityMode);if(t&&t.length===1&&h.spatialLayers>1&&c.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(k.debug("send() | enabling legacy simulcast for VP9 SVC"),f=!0,p=le.parse(l.sdp),u=p.media[o.idx],Rn.addLegacySimulcast({offerMediaObject:u,numStreams:h.spatialLayers}),l={type:"offer",sdp:le.write(p)}),k.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),yield this._pc.setLocalDescription(l),t){k.debug("send() | applying given encodings");let _=d.sender.getParameters();for(let y=0;y<(_.encodings||[]).length;++y){let S=_.encodings[y],R=t[y];if(!R)break;_.encodings[y]=Object.assign(S,R)}yield d.sender.setParameters(_)}let g=d.mid;if(c.mid=g,p=le.parse(this._pc.localDescription.sdp),u=p.media[o.idx],c.rtcp.cname=ri.getCname({offerMediaObject:u}),c.encodings=Rn.getRtpEncodings({offerMediaObject:u}),t)for(let _=0;_<c.encodings.length;++_)t[_]&&Object.assign(c.encodings[_],t[_]);if(f&&(c.encodings=[c.encodings[0]]),c.encodings.length>1&&(c.codecs[0].mimeType.toLowerCase()==="video/vp8"||c.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let _ of c.encodings)_.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:o.reuseMid,offerRtpParameters:c,answerRtpParameters:a,codecOptions:i});let v={type:"answer",sdp:this._remoteSdp.getSdp()};return k.debug("send() | calling pc.setRemoteDescription() [answer:%o]",v),yield this._pc.setRemoteDescription(v),this._mapMidTransceiver.set(g,d),{localId:g,rtpParameters:c,rtpSender:d.sender}})}stopSending(e){return m(this,null,function*(){this._assertSendDirection(),k.debug("stopSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);let i=yield this._pc.createOffer();k.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};k.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)})}replaceTrack(e,t){return m(this,null,function*(){this._assertSendDirection(),t?k.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):k.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)})}setMaxSpatialLayer(e,t){return m(this,null,function*(){this._assertSendDirection(),k.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((s,c)=>{c<=t?s.active=!0:s.active=!1}),yield i.sender.setParameters(n)})}setRtpEncodingParameters(e,t){return m(this,null,function*(){this._assertSendDirection(),k.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((s,c)=>{n.encodings[c]=Object.assign(Object.assign({},s),t)}),yield i.sender.setParameters(n)})}getSenderStats(e){return m(this,null,function*(){this._assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()})}sendDataChannel(a){return m(this,arguments,function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s,priority:c}){this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:s,priority:c};k.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%yo.MIS,!this._hasDataChannelMediaSection){let p=yield this._pc.createOffer(),u=le.parse(p.sdp),f=u.media.find(g=>g.type==="application");this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:u})),k.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),yield this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:f});let h={type:"answer",sdp:this._remoteSdp.getSdp()};k.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:l}})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){this._assertRecvDirection(),k.debug("receive() [trackId:%s, kind:%s]",e,t);let s=i.mid||String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:i,streamId:i.rtcp.cname,trackId:e});let c={type:"offer",sdp:this._remoteSdp.getSdp()};k.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",c),yield this._pc.setRemoteDescription(c);let a=yield this._pc.createAnswer(),o=le.parse(a.sdp),d=o.media.find(p=>String(p.mid)===s);ri.applyCodecParameters({offerRtpParameters:i,answerMediaObject:d}),a={type:"answer",sdp:le.write(o)},this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:o})),k.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),yield this._pc.setLocalDescription(a);let l=this._pc.getTransceivers().find(p=>p.mid===s);if(!l)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(s,l),{localId:s,track:l.receiver.track,rtpReceiver:l.receiver}})}stopReceiving(e){return m(this,null,function*(){this._assertRecvDirection(),k.debug("stopReceiving() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);let i={type:"offer",sdp:this._remoteSdp.getSdp()};k.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",i),yield this._pc.setRemoteDescription(i);let n=yield this._pc.createAnswer();k.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",n),yield this._pc.setLocalDescription(n)})}getReceiverStats(e){return m(this,null,function*(){this._assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()})}receiveDataChannel(n){return m(this,arguments,function*({sctpStreamParameters:e,label:t,protocol:i}){this._assertRecvDirection();let{streamId:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:s,ordered:c,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:i};k.debug("receiveDataChannel() [options:%o]",d);let l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};k.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),yield this._pc.setRemoteDescription(p);let u=yield this._pc.createAnswer();if(!this._transportReady){let f=le.parse(u.sdp);yield this._setupTransport({localDtlsRole:"client",localSdpObject:f})}k.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),yield this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:l}})}_setupTransport(i){return m(this,arguments,function*({localDtlsRole:e,localSdpObject:t}){t||(t=le.parse(this._pc.localDescription.sdp));let n=ri.extractDtlsParameters({sdpObject:t});n.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),yield this.safeEmitAsPromise("@connect",{dtlsParameters:n}),this._transportReady=!0})}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};bn.Chrome70=ii});var vr=b(ni=>{"use strict";Object.defineProperty(ni,"__esModule",{value:!0});function Tp({offerMediaObject:r,track:e}){let t,i=new Set;for(let c of r.ssrcs||[]){if(c.attribute!=="msid")continue;if(c.value.split(" ")[1]===e.id){let o=c.id;i.add(o),t||(t=o)}}if(i.size===0)throw new Error(`a=ssrc line with msid information not found [track.id:${e.id}]`);let n=new Map;for(let c of r.ssrcGroups||[]){if(c.semantics!=="FID")continue;let[a,o]=c.ssrcs.split(/\s+/);a=Number(a),o=Number(o),i.has(a)&&(i.delete(a),i.delete(o),n.set(a,o))}for(let c of i)n.set(c,null);let s=[];for(let[c,a]of n){let o={ssrc:c};a&&(o.rtx={ssrc:a}),s.push(o)}return s}ni.getRtpEncodings=Tp;function Ep({offerMediaObject:r,track:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");let i,n,s;if(!(r.ssrcs||[]).find(p=>p.attribute!=="msid"?!1:p.value.split(" ")[1]===e.id?(i=p.id,s=p.value.split(" ")[0],!0):!1))throw new Error(`a=ssrc line with msid information not found [track.id:${e.id}]`);(r.ssrcGroups||[]).some(p=>{if(p.semantics!=="FID")return!1;let u=p.ssrcs.split(/\s+/);return Number(u[0])===i?(n=Number(u[1]),!0):!1});let a=r.ssrcs.find(p=>p.attribute==="cname"&&p.id===i);if(!a)throw new Error(`a=ssrc line with cname information not found [track.id:${e.id}]`);let o=a.value,d=[],l=[];for(let p=0;p<t;++p)d.push(i+p),n&&l.push(n+p);r.ssrcGroups=r.ssrcGroups||[],r.ssrcs=r.ssrcs||[],r.ssrcGroups.push({semantics:"SIM",ssrcs:d.join(" ")});for(let p=0;p<d.length;++p){let u=d[p];r.ssrcs.push({id:u,attribute:"cname",value:o}),r.ssrcs.push({id:u,attribute:"msid",value:`${s} ${e.id}`})}for(let p=0;p<l.length;++p){let u=d[p],f=l[p];r.ssrcs.push({id:f,attribute:"cname",value:o}),r.ssrcs.push({id:f,attribute:"msid",value:`${s} ${e.id}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${u} ${f}`})}}ni.addLegacySimulcast=Ep});var To=b(Tn=>{"use strict";Object.defineProperty(Tn,"__esModule",{value:!0});var be=me(),Cp=Z(),So=ie(),At=de(),si=je(),bo=vr(),xp=ge(),Pp=Ne(),I=new Cp.Logger("Chrome67"),Ro={OS:1024,MIS:1024},ai=class extends xp.HandlerInterface{constructor(){super();this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new ai}get name(){return"Chrome67"}close(){if(I.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}getNativeRtpCapabilities(){return m(this,null,function*(){I.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{let t=yield e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(s){}let i=be.parse(t.sdp);return si.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(i){}throw t}})}getNativeSctpCapabilities(){return m(this,null,function*(){return I.debug("getNativeSctpCapabilities()"),{numStreams:Ro}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){I.debug("run()"),this._direction=e,this._remoteSdp=new Pp.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,planB:!0}),this._sendingRtpParametersByKind={audio:At.getSendingRtpParameters("audio",l),video:At.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:At.getSendingRemoteRtpParameters("audio",l),video:At.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(Object.assign({iceServers:c||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},o),d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}updateIceServers(e){return m(this,null,function*(){I.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)})}restartIce(e){return m(this,null,function*(){if(I.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=yield this._pc.createOffer({iceRestart:!0});I.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),yield this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),yield this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);let i=yield this._pc.createAnswer();I.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}})}getTransportStats(){return m(this,null,function*(){return this._pc.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){this._assertSendDirection(),I.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&I.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let c=yield this._pc.createOffer(),a=be.parse(c.sdp),o,d=So.clone(this._sendingRtpParametersByKind[e.kind],{});d.codecs=At.reduceCodecs(d.codecs);let l=So.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(l.codecs=At.reduceCodecs(l.codecs),this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:a})),e.kind==="video"&&t&&t.length>1&&(I.debug("send() | enabling simulcast"),a=be.parse(c.sdp),o=a.media.find(h=>h.type==="video"),bo.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),c={type:"offer",sdp:be.write(a)}),I.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),yield this._pc.setLocalDescription(c),a=be.parse(this._pc.localDescription.sdp),o=a.media.find(h=>h.type===e.kind),d.rtcp.cname=si.getCname({offerMediaObject:o}),d.encodings=bo.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let h=0;h<d.encodings.length;++h)t[h]&&Object.assign(d.encodings[h],t[h]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(let h of d.encodings)h.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:l,codecOptions:i});let p={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),yield this._pc.setRemoteDescription(p);let u=String(this._nextSendLocalId);this._nextSendLocalId++;let f=this._pc.getSenders().find(h=>h.track===e);return this._mapSendLocalIdRtpSender.set(u,f),{localId:u,rtpParameters:d,rtpSender:f}})}stopSending(e){return m(this,null,function*(){this._assertSendDirection(),I.debug("stopSending() [localId:%s]",e);let t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(t),t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);let i=yield this._pc.createOffer();I.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{yield this._pc.setLocalDescription(i)}catch(s){if(this._sendStream.getTracks().length===0){I.warn("stopSending() | ignoring expected error due no sending tracks: %s",s.toString());return}throw s}if(this._pc.signalingState==="stable")return;let n={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)})}replaceTrack(e,t){return m(this,null,function*(){this._assertSendDirection(),t?I.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):I.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");let n=i.track;yield i.replaceTrack(t),n&&this._sendStream.removeTrack(n),t&&this._sendStream.addTrack(t)})}setMaxSpatialLayer(e,t){return m(this,null,function*(){this._assertSendDirection(),I.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");let n=i.getParameters();n.encodings.forEach((s,c)=>{c<=t?s.active=!0:s.active=!1}),yield i.setParameters(n)})}setRtpEncodingParameters(e,t){return m(this,null,function*(){this._assertSendDirection(),I.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");let n=i.getParameters();n.encodings.forEach((s,c)=>{n.encodings[c]=Object.assign(Object.assign({},s),t)}),yield i.setParameters(n)})}getSenderStats(e){return m(this,null,function*(){this._assertSendDirection();let t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()})}sendDataChannel(a){return m(this,arguments,function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s,priority:c}){this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:s,priority:c};I.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ro.MIS,!this._hasDataChannelMediaSection){let p=yield this._pc.createOffer(),u=be.parse(p.sdp),f=u.media.find(g=>g.type==="application");this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:u})),I.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),yield this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:f});let h={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:l}})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){this._assertRecvDirection(),I.debug("receive() [trackId:%s, kind:%s]",e,t);let s=e,c=t;this._remoteSdp.receive({mid:c,kind:t,offerRtpParameters:i,streamId:i.rtcp.cname,trackId:e});let a={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",a),yield this._pc.setRemoteDescription(a);let o=yield this._pc.createAnswer(),d=be.parse(o.sdp),l=d.media.find(u=>String(u.mid)===c);si.applyCodecParameters({offerRtpParameters:i,answerMediaObject:l}),o={type:"answer",sdp:be.write(d)},this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:d})),I.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),yield this._pc.setLocalDescription(o);let p=this._pc.getReceivers().find(u=>u.track&&u.track.id===s);if(!p)throw new Error("new RTCRtpReceiver not");return this._mapRecvLocalIdInfo.set(s,{mid:c,rtpParameters:i,rtpReceiver:p}),{localId:s,track:p.track,rtpReceiver:p}})}stopReceiving(e){return m(this,null,function*(){this._assertRecvDirection(),I.debug("stopReceiving() [localId:%s]",e);let{mid:t,rtpParameters:i}=this._mapRecvLocalIdInfo.get(e)||{};this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:i});let n={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),yield this._pc.setRemoteDescription(n);let s=yield this._pc.createAnswer();I.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),yield this._pc.setLocalDescription(s)})}getReceiverStats(e){return m(this,null,function*(){this._assertRecvDirection();let{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()})}receiveDataChannel(n){return m(this,arguments,function*({sctpStreamParameters:e,label:t,protocol:i}){this._assertRecvDirection();let{streamId:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:s,ordered:c,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:i};I.debug("receiveDataChannel() [options:%o]",d);let l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});let p={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),yield this._pc.setRemoteDescription(p);let u=yield this._pc.createAnswer();if(!this._transportReady){let f=be.parse(u.sdp);yield this._setupTransport({localDtlsRole:"client",localSdpObject:f})}I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),yield this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:l}})}_setupTransport(i){return m(this,arguments,function*({localDtlsRole:e,localSdpObject:t}){t||(t=be.parse(this._pc.localDescription.sdp));let n=si.extractDtlsParameters({sdpObject:t});n.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),yield this.safeEmitAsPromise("@connect",{dtlsParameters:n}),this._transportReady=!0})}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Tn.Chrome67=ai});var Po=b(En=>{"use strict";Object.defineProperty(En,"__esModule",{value:!0});var Re=me(),Dp=Z(),_r=he(),Eo=ie(),jt=de(),oi=je(),Co=vr(),Mp=ge(),kp=Ne(),B=new Dp.Logger("Chrome55"),xo={OS:1024,MIS:1024},ci=class extends Mp.HandlerInterface{constructor(){super();this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new ci}get name(){return"Chrome55"}close(){if(B.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}getNativeRtpCapabilities(){return m(this,null,function*(){B.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{let t=yield e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(s){}let i=Re.parse(t.sdp);return oi.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(i){}throw t}})}getNativeSctpCapabilities(){return m(this,null,function*(){return B.debug("getNativeSctpCapabilities()"),{numStreams:xo}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){B.debug("run()"),this._direction=e,this._remoteSdp=new kp.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,planB:!0}),this._sendingRtpParametersByKind={audio:jt.getSendingRtpParameters("audio",l),video:jt.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:jt.getSendingRemoteRtpParameters("audio",l),video:jt.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(Object.assign({iceServers:c||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},o),d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}updateIceServers(e){return m(this,null,function*(){B.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)})}restartIce(e){return m(this,null,function*(){if(B.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=yield this._pc.createOffer({iceRestart:!0});B.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),yield this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};B.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),yield this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};B.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);let i=yield this._pc.createAnswer();B.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}})}getTransportStats(){return m(this,null,function*(){return this._pc.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){this._assertSendDirection(),B.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&B.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let c=yield this._pc.createOffer(),a=Re.parse(c.sdp),o,d=Eo.clone(this._sendingRtpParametersByKind[e.kind],{});d.codecs=jt.reduceCodecs(d.codecs);let l=Eo.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(l.codecs=jt.reduceCodecs(l.codecs),this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:a})),e.kind==="video"&&t&&t.length>1&&(B.debug("send() | enabling simulcast"),a=Re.parse(c.sdp),o=a.media.find(f=>f.type==="video"),Co.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),c={type:"offer",sdp:Re.write(a)}),B.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),yield this._pc.setLocalDescription(c),a=Re.parse(this._pc.localDescription.sdp),o=a.media.find(f=>f.type===e.kind),d.rtcp.cname=oi.getCname({offerMediaObject:o}),d.encodings=Co.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let f=0;f<d.encodings.length;++f)t[f]&&Object.assign(d.encodings[f],t[f]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(let f of d.encodings)f.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:l,codecOptions:i});let p={type:"answer",sdp:this._remoteSdp.getSdp()};B.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),yield this._pc.setRemoteDescription(p);let u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(u,e),{localId:u,rtpParameters:d}})}stopSending(e){return m(this,null,function*(){this._assertSendDirection(),B.debug("stopSending() [localId:%s]",e);let t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);let i=yield this._pc.createOffer();B.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{yield this._pc.setLocalDescription(i)}catch(s){if(this._sendStream.getTracks().length===0){B.warn("stopSending() | ignoring expected error due no sending tracks: %s",s.toString());return}throw s}if(this._pc.signalingState==="stable")return;let n={type:"answer",sdp:this._remoteSdp.getSdp()};B.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)})}replaceTrack(e,t){return m(this,null,function*(){throw new _r.UnsupportedError("not implemented")})}setMaxSpatialLayer(e,t){return m(this,null,function*(){throw new _r.UnsupportedError(" not implemented")})}setRtpEncodingParameters(e,t){return m(this,null,function*(){throw new _r.UnsupportedError("not supported")})}getSenderStats(e){return m(this,null,function*(){throw new _r.UnsupportedError("not implemented")})}sendDataChannel(a){return m(this,arguments,function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s,priority:c}){this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:s,priority:c};B.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%xo.MIS,!this._hasDataChannelMediaSection){let p=yield this._pc.createOffer(),u=Re.parse(p.sdp),f=u.media.find(g=>g.type==="application");this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:u})),B.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),yield this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:f});let h={type:"answer",sdp:this._remoteSdp.getSdp()};B.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:l}})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){this._assertRecvDirection(),B.debug("receive() [trackId:%s, kind:%s]",e,t);let s=e,c=t,a=i.rtcp.cname;this._remoteSdp.receive({mid:c,kind:t,offerRtpParameters:i,streamId:a,trackId:e});let o={type:"offer",sdp:this._remoteSdp.getSdp()};B.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",o),yield this._pc.setRemoteDescription(o);let d=yield this._pc.createAnswer(),l=Re.parse(d.sdp),p=l.media.find(h=>String(h.mid)===c);oi.applyCodecParameters({offerRtpParameters:i,answerMediaObject:p}),d={type:"answer",sdp:Re.write(l)},this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:l})),B.debug("receive() | calling pc.setLocalDescription() [answer:%o]",d),yield this._pc.setLocalDescription(d);let f=this._pc.getRemoteStreams().find(h=>h.id===a).getTrackById(s);if(!f)throw new Error("remote track not found");return this._mapRecvLocalIdInfo.set(s,{mid:c,rtpParameters:i}),{localId:s,track:f}})}stopReceiving(e){return m(this,null,function*(){this._assertRecvDirection(),B.debug("stopReceiving() [localId:%s]",e);let{mid:t,rtpParameters:i}=this._mapRecvLocalIdInfo.get(e)||{};this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:i});let n={type:"offer",sdp:this._remoteSdp.getSdp()};B.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),yield this._pc.setRemoteDescription(n);let s=yield this._pc.createAnswer();B.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),yield this._pc.setLocalDescription(s)})}getReceiverStats(e){return m(this,null,function*(){throw new _r.UnsupportedError("not implemented")})}receiveDataChannel(n){return m(this,arguments,function*({sctpStreamParameters:e,label:t,protocol:i}){this._assertRecvDirection();let{streamId:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:s,ordered:c,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:i};B.debug("receiveDataChannel() [options:%o]",d);let l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});let p={type:"offer",sdp:this._remoteSdp.getSdp()};B.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),yield this._pc.setRemoteDescription(p);let u=yield this._pc.createAnswer();if(!this._transportReady){let f=Re.parse(u.sdp);yield this._setupTransport({localDtlsRole:"client",localSdpObject:f})}B.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),yield this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:l}})}_setupTransport(i){return m(this,arguments,function*({localDtlsRole:e,localSdpObject:t}){t||(t=Re.parse(this._pc.localDescription.sdp));let n=oi.extractDtlsParameters({sdpObject:t});n.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),yield this.safeEmitAsPromise("@connect",{dtlsParameters:n}),this._transportReady=!0})}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};En.Chrome55=ci});var ko=b(Cn=>{"use strict";Object.defineProperty(Cn,"__esModule",{value:!0});var ze=me(),Ip=Z(),Lp=he(),xn=ie(),Nt=de(),di=je(),Do=mr(),Op=ge(),Ap=Ne(),U=new Ip.Logger("Firefox60"),Mo={OS:16,MIS:2048},pi=class extends Op.HandlerInterface{constructor(){super();this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new pi}get name(){return"Firefox60"}close(){if(U.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}getNativeRtpCapabilities(){return m(this,null,function*(){U.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");let n=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});let s=e.addTransceiver(n,{direction:"sendrecv"}),c=s.sender.getParameters(),a=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];c.encodings=a,yield s.sender.setParameters(c);let o=yield e.createOffer();try{t.remove()}catch(p){}try{n.stop()}catch(p){}try{e.close()}catch(p){}let d=ze.parse(o.sdp);return di.extractRtpCapabilities({sdpObject:d})}catch(s){try{t.remove()}catch(c){}try{n.stop()}catch(c){}try{e.close()}catch(c){}throw s}})}getNativeSctpCapabilities(){return m(this,null,function*(){return U.debug("getNativeSctpCapabilities()"),{numStreams:Mo}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){U.debug("run()"),this._direction=e,this._remoteSdp=new Ap.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s}),this._sendingRtpParametersByKind={audio:Nt.getSendingRtpParameters("audio",l),video:Nt.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:Nt.getSendingRemoteRtpParameters("audio",l),video:Nt.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(Object.assign({iceServers:c||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},o),d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}updateIceServers(e){return m(this,null,function*(){throw new Lp.UnsupportedError("not supported")})}restartIce(e){return m(this,null,function*(){if(U.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=yield this._pc.createOffer({iceRestart:!0});U.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),yield this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),yield this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);let i=yield this._pc.createAnswer();U.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}})}getTransportStats(){return m(this,null,function*(){return this._pc.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){this._assertSendDirection(),U.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&(t=xn.clone(t,[]),t.length>1&&(t.forEach((h,g)=>{h.rid=`r${g}`}),t.reverse()));let c=xn.clone(this._sendingRtpParametersByKind[e.kind],{});c.codecs=Nt.reduceCodecs(c.codecs,n);let a=xn.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});a.codecs=Nt.reduceCodecs(a.codecs,n);let o=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(t){let h=o.sender.getParameters();h.encodings=t,yield o.sender.setParameters(h)}let d=yield this._pc.createOffer(),l=ze.parse(d.sdp);this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:l})),U.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),yield this._pc.setLocalDescription(d);let p=o.mid;c.mid=p,l=ze.parse(this._pc.localDescription.sdp);let u=l.media[l.media.length-1];if(c.rtcp.cname=di.getCname({offerMediaObject:u}),!t)c.encodings=Do.getRtpEncodings({offerMediaObject:u});else if(t.length===1){let h=Do.getRtpEncodings({offerMediaObject:u});Object.assign(h[0],t[0]),c.encodings=h}else c.encodings=t.reverse();if(c.encodings.length>1&&(c.codecs[0].mimeType.toLowerCase()==="video/vp8"||c.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let h of c.encodings)h.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:u,offerRtpParameters:c,answerRtpParameters:a,codecOptions:i,extmapAllowMixed:!0});let f={type:"answer",sdp:this._remoteSdp.getSdp()};return U.debug("send() | calling pc.setRemoteDescription() [answer:%o]",f),yield this._pc.setRemoteDescription(f),this._mapMidTransceiver.set(p,o),{localId:p,rtpParameters:c,rtpSender:o.sender}})}stopSending(e){return m(this,null,function*(){U.debug("stopSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);let i=yield this._pc.createOffer();U.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)})}replaceTrack(e,t){return m(this,null,function*(){this._assertSendDirection(),t?U.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):U.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)})}setMaxSpatialLayer(e,t){return m(this,null,function*(){this._assertSendDirection(),U.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated transceiver not found");let n=i.sender.getParameters();t=n.encodings.length-1-t,n.encodings.forEach((s,c)=>{c>=t?s.active=!0:s.active=!1}),yield i.sender.setParameters(n)})}setRtpEncodingParameters(e,t){return m(this,null,function*(){this._assertSendDirection(),U.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((s,c)=>{n.encodings[c]=Object.assign(Object.assign({},s),t)}),yield i.sender.setParameters(n)})}getSenderStats(e){return m(this,null,function*(){this._assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()})}sendDataChannel(a){return m(this,arguments,function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s,priority:c}){this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s,priority:c};U.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Mo.MIS,!this._hasDataChannelMediaSection){let p=yield this._pc.createOffer(),u=ze.parse(p.sdp),f=u.media.find(g=>g.type==="application");this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:u})),U.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),yield this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:f});let h={type:"answer",sdp:this._remoteSdp.getSdp()};U.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:l}})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){this._assertRecvDirection(),U.debug("receive() [trackId:%s, kind:%s]",e,t);let s=i.mid||String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:i,streamId:i.rtcp.cname,trackId:e});let c={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",c),yield this._pc.setRemoteDescription(c);let a=yield this._pc.createAnswer(),o=ze.parse(a.sdp),d=o.media.find(p=>String(p.mid)===s);di.applyCodecParameters({offerRtpParameters:i,answerMediaObject:d}),a={type:"answer",sdp:ze.write(o)},this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:o})),U.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),yield this._pc.setLocalDescription(a);let l=this._pc.getTransceivers().find(p=>p.mid===s);if(!l)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(s,l),{localId:s,track:l.receiver.track,rtpReceiver:l.receiver}})}stopReceiving(e){return m(this,null,function*(){this._assertRecvDirection(),U.debug("stopReceiving() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);let i={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",i),yield this._pc.setRemoteDescription(i);let n=yield this._pc.createAnswer();U.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",n),yield this._pc.setLocalDescription(n)})}getReceiverStats(e){return m(this,null,function*(){this._assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()})}receiveDataChannel(n){return m(this,arguments,function*({sctpStreamParameters:e,label:t,protocol:i}){this._assertRecvDirection();let{streamId:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o,protocol:i};U.debug("receiveDataChannel() [options:%o]",d);let l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};U.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),yield this._pc.setRemoteDescription(p);let u=yield this._pc.createAnswer();if(!this._transportReady){let f=ze.parse(u.sdp);yield this._setupTransport({localDtlsRole:"client",localSdpObject:f})}U.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),yield this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:l}})}_setupTransport(i){return m(this,arguments,function*({localDtlsRole:e,localSdpObject:t}){t||(t=ze.parse(this._pc.localDescription.sdp));let n=di.extractDtlsParameters({sdpObject:t});n.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),yield this.safeEmitAsPromise("@connect",{dtlsParameters:n}),this._transportReady=!0})}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Cn.Firefox60=pi});var Ao=b(Pn=>{"use strict";Object.defineProperty(Pn,"__esModule",{value:!0});var Te=me(),jp=Z(),Io=ie(),Ft=de(),li=je(),Lo=mr(),Np=ge(),Fp=Ne(),j=new jp.Logger("Safari12"),Oo={OS:1024,MIS:1024},ui=class extends Np.HandlerInterface{constructor(){super();this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new ui}get name(){return"Safari12"}close(){if(j.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}getNativeRtpCapabilities(){return m(this,null,function*(){j.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");let t=yield e.createOffer();try{e.close()}catch(s){}let i=Te.parse(t.sdp);return li.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(i){}throw t}})}getNativeSctpCapabilities(){return m(this,null,function*(){return j.debug("getNativeSctpCapabilities()"),{numStreams:Oo}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){j.debug("run()"),this._direction=e,this._remoteSdp=new Fp.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s}),this._sendingRtpParametersByKind={audio:Ft.getSendingRtpParameters("audio",l),video:Ft.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:Ft.getSendingRemoteRtpParameters("audio",l),video:Ft.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(Object.assign({iceServers:c||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},o),d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}updateIceServers(e){return m(this,null,function*(){j.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)})}restartIce(e){return m(this,null,function*(){if(j.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=yield this._pc.createOffer({iceRestart:!0});j.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),yield this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),yield this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);let i=yield this._pc.createAnswer();j.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}})}getTransportStats(){return m(this,null,function*(){return this._pc.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){this._assertSendDirection(),j.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);let c=Io.clone(this._sendingRtpParametersByKind[e.kind],{});c.codecs=Ft.reduceCodecs(c.codecs,n);let a=Io.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});a.codecs=Ft.reduceCodecs(a.codecs,n);let o=this._remoteSdp.getNextMediaSectionIdx(),d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]}),l=yield this._pc.createOffer(),p=Te.parse(l.sdp),u;this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:p})),t&&t.length>1&&(j.debug("send() | enabling legacy simulcast"),p=Te.parse(l.sdp),u=p.media[o.idx],Lo.addLegacySimulcast({offerMediaObject:u,numStreams:t.length}),l={type:"offer",sdp:Te.write(p)}),j.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),yield this._pc.setLocalDescription(l);let f=d.mid;if(c.mid=f,p=Te.parse(this._pc.localDescription.sdp),u=p.media[o.idx],c.rtcp.cname=li.getCname({offerMediaObject:u}),c.encodings=Lo.getRtpEncodings({offerMediaObject:u}),t)for(let g=0;g<c.encodings.length;++g)t[g]&&Object.assign(c.encodings[g],t[g]);if(c.encodings.length>1&&(c.codecs[0].mimeType.toLowerCase()==="video/vp8"||c.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let g of c.encodings)g.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:u,reuseMid:o.reuseMid,offerRtpParameters:c,answerRtpParameters:a,codecOptions:i});let h={type:"answer",sdp:this._remoteSdp.getSdp()};return j.debug("send() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._mapMidTransceiver.set(f,d),{localId:f,rtpParameters:c,rtpSender:d.sender}})}stopSending(e){return m(this,null,function*(){this._assertSendDirection(),j.debug("stopSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);let i=yield this._pc.createOffer();j.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),yield this._pc.setLocalDescription(i);let n={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)})}replaceTrack(e,t){return m(this,null,function*(){this._assertSendDirection(),t?j.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):j.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");yield i.sender.replaceTrack(t)})}setMaxSpatialLayer(e,t){return m(this,null,function*(){this._assertSendDirection(),j.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((s,c)=>{c<=t?s.active=!0:s.active=!1}),yield i.sender.setParameters(n)})}setRtpEncodingParameters(e,t){return m(this,null,function*(){this._assertSendDirection(),j.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");let n=i.sender.getParameters();n.encodings.forEach((s,c)=>{n.encodings[c]=Object.assign(Object.assign({},s),t)}),yield i.sender.setParameters(n)})}getSenderStats(e){return m(this,null,function*(){this._assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()})}sendDataChannel(a){return m(this,arguments,function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s,priority:c}){this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s,priority:c};j.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Oo.MIS,!this._hasDataChannelMediaSection){let p=yield this._pc.createOffer(),u=Te.parse(p.sdp),f=u.media.find(g=>g.type==="application");this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:u})),j.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),yield this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:f});let h={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:l}})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){this._assertRecvDirection(),j.debug("receive() [trackId:%s, kind:%s]",e,t);let s=i.mid||String(this._mapMidTransceiver.size);this._remoteSdp.receive({mid:s,kind:t,offerRtpParameters:i,streamId:i.rtcp.cname,trackId:e});let c={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",c),yield this._pc.setRemoteDescription(c);let a=yield this._pc.createAnswer(),o=Te.parse(a.sdp),d=o.media.find(p=>String(p.mid)===s);li.applyCodecParameters({offerRtpParameters:i,answerMediaObject:d}),a={type:"answer",sdp:Te.write(o)},this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:o})),j.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),yield this._pc.setLocalDescription(a);let l=this._pc.getTransceivers().find(p=>p.mid===s);if(!l)throw new Error("new RTCRtpTransceiver not found");return this._mapMidTransceiver.set(s,l),{localId:s,track:l.receiver.track,rtpReceiver:l.receiver}})}stopReceiving(e){return m(this,null,function*(){this._assertRecvDirection(),j.debug("stopReceiving() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(t.mid);let i={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",i),yield this._pc.setRemoteDescription(i);let n=yield this._pc.createAnswer();j.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",n),yield this._pc.setLocalDescription(n)})}getReceiverStats(e){return m(this,null,function*(){this._assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()})}receiveDataChannel(n){return m(this,arguments,function*({sctpStreamParameters:e,label:t,protocol:i}){this._assertRecvDirection();let{streamId:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o,protocol:i};j.debug("receiveDataChannel() [options:%o]",d);let l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),yield this._pc.setRemoteDescription(p);let u=yield this._pc.createAnswer();if(!this._transportReady){let f=Te.parse(u.sdp);yield this._setupTransport({localDtlsRole:"client",localSdpObject:f})}j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),yield this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:l}})}_setupTransport(i){return m(this,arguments,function*({localDtlsRole:e,localSdpObject:t}){t||(t=Te.parse(this._pc.localDescription.sdp));let n=li.extractDtlsParameters({sdpObject:t});n.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),yield this.safeEmitAsPromise("@connect",{dtlsParameters:n}),this._transportReady=!0})}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Pn.Safari12=ui});var qo=b(Dn=>{"use strict";Object.defineProperty(Dn,"__esModule",{value:!0});var Ee=me(),qp=Z(),jo=ie(),qt=de(),fi=je(),No=vr(),Bp=ge(),Up=Ne(),O=new qp.Logger("Safari11"),Fo={OS:1024,MIS:1024},hi=class extends Bp.HandlerInterface{constructor(){super();this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new hi}get name(){return"Safari11"}close(){if(O.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}getNativeRtpCapabilities(){return m(this,null,function*(){O.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{let t=yield e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(s){}let i=Ee.parse(t.sdp);return fi.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(i){}throw t}})}getNativeSctpCapabilities(){return m(this,null,function*(){return O.debug("getNativeSctpCapabilities()"),{numStreams:Fo}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){O.debug("run()"),this._direction=e,this._remoteSdp=new Up.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,planB:!0}),this._sendingRtpParametersByKind={audio:qt.getSendingRtpParameters("audio",l),video:qt.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:qt.getSendingRemoteRtpParameters("audio",l),video:qt.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(Object.assign({iceServers:c||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},o),d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}updateIceServers(e){return m(this,null,function*(){O.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)})}restartIce(e){return m(this,null,function*(){if(O.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=yield this._pc.createOffer({iceRestart:!0});O.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),yield this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),yield this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);let i=yield this._pc.createAnswer();O.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}})}getTransportStats(){return m(this,null,function*(){return this._pc.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){this._assertSendDirection(),O.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&O.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let c=yield this._pc.createOffer(),a=Ee.parse(c.sdp),o,d=jo.clone(this._sendingRtpParametersByKind[e.kind],{});d.codecs=qt.reduceCodecs(d.codecs);let l=jo.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(l.codecs=qt.reduceCodecs(l.codecs),this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:a})),e.kind==="video"&&t&&t.length>1&&(O.debug("send() | enabling simulcast"),a=Ee.parse(c.sdp),o=a.media.find(h=>h.type==="video"),No.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),c={type:"offer",sdp:Ee.write(a)}),O.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),yield this._pc.setLocalDescription(c),a=Ee.parse(this._pc.localDescription.sdp),o=a.media.find(h=>h.type===e.kind),d.rtcp.cname=fi.getCname({offerMediaObject:o}),d.encodings=No.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let h=0;h<d.encodings.length;++h)t[h]&&Object.assign(d.encodings[h],t[h]);if(d.encodings.length>1&&d.codecs[0].mimeType.toLowerCase()==="video/vp8")for(let h of d.encodings)h.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:l,codecOptions:i});let p={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),yield this._pc.setRemoteDescription(p);let u=String(this._nextSendLocalId);this._nextSendLocalId++;let f=this._pc.getSenders().find(h=>h.track===e);return this._mapSendLocalIdRtpSender.set(u,f),{localId:u,rtpParameters:d,rtpSender:f}})}stopSending(e){return m(this,null,function*(){this._assertSendDirection();let t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);let i=yield this._pc.createOffer();O.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{yield this._pc.setLocalDescription(i)}catch(s){if(this._sendStream.getTracks().length===0){O.warn("stopSending() | ignoring expected error due no sending tracks: %s",s.toString());return}throw s}if(this._pc.signalingState==="stable")return;let n={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)})}replaceTrack(e,t){return m(this,null,function*(){this._assertSendDirection(),t?O.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):O.debug("replaceTrack() [localId:%s, no track]",e);let i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");let n=i.track;yield i.replaceTrack(t),n&&this._sendStream.removeTrack(n),t&&this._sendStream.addTrack(t)})}setMaxSpatialLayer(e,t){return m(this,null,function*(){this._assertSendDirection(),O.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");let n=i.getParameters();n.encodings.forEach((s,c)=>{c<=t?s.active=!0:s.active=!1}),yield i.setParameters(n)})}setRtpEncodingParameters(e,t){return m(this,null,function*(){this._assertSendDirection(),O.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._mapSendLocalIdRtpSender.get(e);if(!i)throw new Error("associated RTCRtpSender not found");let n=i.getParameters();n.encodings.forEach((s,c)=>{n.encodings[c]=Object.assign(Object.assign({},s),t)}),yield i.setParameters(n)})}getSenderStats(e){return m(this,null,function*(){this._assertSendDirection();let t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()})}sendDataChannel(a){return m(this,arguments,function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s,priority:c}){this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:s,priority:c};O.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Fo.MIS,!this._hasDataChannelMediaSection){let p=yield this._pc.createOffer(),u=Ee.parse(p.sdp),f=u.media.find(g=>g.type==="application");this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:u})),O.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),yield this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:f});let h={type:"answer",sdp:this._remoteSdp.getSdp()};O.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:l}})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){this._assertRecvDirection(),O.debug("receive() [trackId:%s, kind:%s]",e,t);let s=e,c=t;this._remoteSdp.receive({mid:c,kind:t,offerRtpParameters:i,streamId:i.rtcp.cname,trackId:e});let a={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",a),yield this._pc.setRemoteDescription(a);let o=yield this._pc.createAnswer(),d=Ee.parse(o.sdp),l=d.media.find(u=>String(u.mid)===c);fi.applyCodecParameters({offerRtpParameters:i,answerMediaObject:l}),o={type:"answer",sdp:Ee.write(d)},this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:d})),O.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),yield this._pc.setLocalDescription(o);let p=this._pc.getReceivers().find(u=>u.track&&u.track.id===s);if(!p)throw new Error("new RTCRtpReceiver not");return this._mapRecvLocalIdInfo.set(s,{mid:c,rtpParameters:i,rtpReceiver:p}),{localId:s,track:p.track,rtpReceiver:p}})}stopReceiving(e){return m(this,null,function*(){this._assertRecvDirection(),O.debug("stopReceiving() [localId:%s]",e);let{mid:t,rtpParameters:i}=this._mapRecvLocalIdInfo.get(e)||{};this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:i});let n={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),yield this._pc.setRemoteDescription(n);let s=yield this._pc.createAnswer();O.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),yield this._pc.setLocalDescription(s)})}getReceiverStats(e){return m(this,null,function*(){this._assertRecvDirection();let{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()})}receiveDataChannel(n){return m(this,arguments,function*({sctpStreamParameters:e,label:t,protocol:i}){this._assertRecvDirection();let{streamId:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o,protocol:i};O.debug("receiveDataChannel() [options:%o]",d);let l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});let p={type:"offer",sdp:this._remoteSdp.getSdp()};O.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),yield this._pc.setRemoteDescription(p);let u=yield this._pc.createAnswer();if(!this._transportReady){let f=Ee.parse(u.sdp);yield this._setupTransport({localDtlsRole:"client",localSdpObject:f})}O.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),yield this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:l}})}_setupTransport(i){return m(this,arguments,function*({localDtlsRole:e,localSdpObject:t}){t||(t=Ee.parse(this._pc.localDescription.sdp));let n=fi.extractDtlsParameters({sdpObject:t});n.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),yield this.safeEmitAsPromise("@connect",{dtlsParameters:n}),this._transportReady=!0})}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};Dn.Safari11=hi});var Uo=b(mi=>{"use strict";Object.defineProperty(mi,"__esModule",{value:!0});var Bo=ie();function $p(){let r=RTCRtpReceiver.getCapabilities(),e=Bo.clone(r,{});for(let t of e.codecs){if(t.channels=t.numChannels,delete t.numChannels,t.mimeType=t.mimeType||`${t.kind}/${t.name}`,t.parameters){let i=t.parameters;i.apt&&(i.apt=Number(i.apt)),i["packetization-mode"]&&(i["packetization-mode"]=Number(i["packetization-mode"]))}for(let i of t.rtcpFeedback||[])i.parameter||(i.parameter="")}return e}mi.getCapabilities=$p;function zp(r){let e=Bo.clone(r,{});e.mid&&(e.muxId=e.mid,delete e.mid);for(let t of e.codecs)t.channels&&(t.numChannels=t.channels,delete t.channels),t.mimeType&&!t.name&&(t.name=t.mimeType.split("/")[1]),delete t.mimeType;return e}mi.mangleRtpParameters=zp});var $o=b(Mn=>{"use strict";Object.defineProperty(Mn,"__esModule",{value:!0});var Wp=Z(),kn=he(),gi=ie(),In=de(),Ln=Uo(),Vp=ge(),$=new Wp.Logger("Edge11"),vi=class extends Vp.HandlerInterface{constructor(){super();this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}static createFactory(){return()=>new vi}get name(){return"Edge11"}close(){$.debug("close()");try{this._iceGatherer.close()}catch(e){}try{this._iceTransport.stop()}catch(e){}try{this._dtlsTransport.stop()}catch(e){}for(let e of this._rtpSenders.values())try{e.stop()}catch(t){}for(let e of this._rtpReceivers.values())try{e.stop()}catch(t){}}getNativeRtpCapabilities(){return m(this,null,function*(){return $.debug("getNativeRtpCapabilities()"),Ln.getCapabilities()})}getNativeSctpCapabilities(){return m(this,null,function*(){return $.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){$.debug("run()"),this._sendingRtpParametersByKind={audio:In.getSendingRtpParameters("audio",l),video:In.getSendingRtpParameters("video",l)},this._remoteIceParameters=t,this._remoteIceCandidates=i,this._remoteDtlsParameters=n,this._cname=`CNAME-${gi.generateRandomNumber()}`,this._setIceGatherer({iceServers:c,iceTransportPolicy:a}),this._setIceTransport(),this._setDtlsTransport()}updateIceServers(e){return m(this,null,function*(){throw new kn.UnsupportedError("not supported")})}restartIce(e){return m(this,null,function*(){if($.debug("restartIce()"),this._remoteIceParameters=e,!!this._transportReady){$.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(let t of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(t);this._iceTransport.addRemoteCandidate({})}})}getTransportStats(){return m(this,null,function*(){return this._iceTransport.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){$.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||(yield this._setupTransport({localDtlsRole:"server"})),$.debug("send() | calling new RTCRtpSender()");let c=new RTCRtpSender(e,this._dtlsTransport),a=gi.clone(this._sendingRtpParametersByKind[e.kind],{});a.codecs=In.reduceCodecs(a.codecs,n);let o=a.codecs.some(p=>/.+\/rtx$/i.test(p.mimeType));t||(t=[{}]);for(let p of t)p.ssrc=gi.generateRandomNumber(),o&&(p.rtx={ssrc:gi.generateRandomNumber()});a.encodings=t,a.rtcp={cname:this._cname,reducedSize:!0,mux:!0};let d=Ln.mangleRtpParameters(a);$.debug("send() | calling rtpSender.send() [params:%o]",d),yield c.send(d);let l=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(l,c),{localId:l,rtpParameters:a,rtpSender:c}})}stopSending(e){return m(this,null,function*(){$.debug("stopSending() [localId:%s]",e);let t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{$.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(i){throw $.warn("stopSending() | rtpSender.stop() failed:%o",i),i}})}replaceTrack(e,t){return m(this,null,function*(){t?$.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):$.debug("replaceTrack() [localId:%s, no track]",e);let i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");i.setTrack(t)})}setMaxSpatialLayer(e,t){return m(this,null,function*(){$.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");let n=i.getParameters();n.encodings.forEach((s,c)=>{c<=t?s.active=!0:s.active=!1}),yield i.setParameters(n)})}setRtpEncodingParameters(e,t){return m(this,null,function*(){$.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let i=this._rtpSenders.get(e);if(!i)throw new Error("RTCRtpSender not found");let n=i.getParameters();n.encodings.forEach((s,c)=>{n.encodings[c]=Object.assign(Object.assign({},s),t)}),yield i.setParameters(n)})}getSenderStats(e){return m(this,null,function*(){let t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()})}sendDataChannel(e){return m(this,null,function*(){throw new kn.UnsupportedError("not implemented")})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){$.debug("receive() [trackId:%s, kind:%s]",e,t),this._transportReady||(yield this._setupTransport({localDtlsRole:"server"})),$.debug("receive() | calling new RTCRtpReceiver()");let s=new RTCRtpReceiver(this._dtlsTransport,t);s.addEventListener("error",o=>{$.error('rtpReceiver "error" event [event:%o]',o)});let c=Ln.mangleRtpParameters(i);$.debug("receive() | calling rtpReceiver.receive() [params:%o]",c),yield s.receive(c);let a=e;return this._rtpReceivers.set(a,s),{localId:a,track:s.track,rtpReceiver:s}})}stopReceiving(e){return m(this,null,function*(){$.debug("stopReceiving() [localId:%s]",e);let t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(e);try{$.debug("stopReceiving() | calling rtpReceiver.stop()"),t.stop()}catch(i){$.warn("stopReceiving() | rtpReceiver.stop() failed:%o",i)}})}getReceiverStats(e){return m(this,null,function*(){let t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()})}receiveDataChannel(e){return m(this,null,function*(){throw new kn.UnsupportedError("not implemented")})}_setIceGatherer({iceServers:e,iceTransportPolicy:t}){let i=new RTCIceGatherer({iceServers:e||[],gatherPolicy:t||"all"});i.addEventListener("error",n=>{$.error('iceGatherer "error" event [event:%o]',n)});try{i.gather()}catch(n){$.debug("_setIceGatherer() | iceGatherer.gather() failed: %s",n.toString())}this._iceGatherer=i}_setIceTransport(){let e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}),e.addEventListener("icestatechange",()=>{switch(e.state){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}}),e.addEventListener("candidatepairchange",t=>{$.debug('iceTransport "candidatepairchange" event [pair:%o]',t.pair)}),this._iceTransport=e}_setDtlsTransport(){let e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",()=>{$.debug('dtlsTransport "statechange" event [state:%s]',e.state)}),e.addEventListener("dtlsstatechange",()=>{$.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),e.state==="closed"&&this.emit("@connectionstatechange","closed")}),e.addEventListener("error",t=>{$.error('dtlsTransport "error" event [event:%o]',t)}),this._dtlsTransport=e}_setupTransport(t){return m(this,arguments,function*({localDtlsRole:e}){$.debug("_setupTransport()");let i=this._dtlsTransport.getLocalParameters();i.role=e,yield this.safeEmitAsPromise("@connect",{dtlsParameters:i}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(let n of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(n);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter(n=>n.algorithm==="sha-256"||n.algorithm==="sha-384"||n.algorithm==="sha-512"),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0})}};Mn.Edge11=vi});var Vo=b(On=>{"use strict";Object.defineProperty(On,"__esModule",{value:!0});var Ce=me(),Gp=Z(),yr=he(),An=ie(),Bt=de(),_i=je(),zo=vr(),Kp=ge(),Hp=Ne(),F=new Gp.Logger("ReactNative"),Wo={OS:1024,MIS:1024},yi=class extends Kp.HandlerInterface{constructor(){super();this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}static createFactory(){return()=>new yi}get name(){return"ReactNative"}close(){if(F.debug("close()"),this._pc)try{this._pc.close()}catch(e){}}getNativeRtpCapabilities(){return m(this,null,function*(){F.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{let t=yield e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch(s){}let i=Ce.parse(t.sdp);return _i.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(i){}throw t}})}getNativeSctpCapabilities(){return m(this,null,function*(){return F.debug("getNativeSctpCapabilities()"),{numStreams:Wo}})}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,extendedRtpCapabilities:l}){F.debug("run()"),this._direction=e,this._remoteSdp=new Hp.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,planB:!0}),this._sendingRtpParametersByKind={audio:Bt.getSendingRtpParameters("audio",l),video:Bt.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:Bt.getSendingRemoteRtpParameters("audio",l),video:Bt.getSendingRemoteRtpParameters("video",l)},this._pc=new RTCPeerConnection(Object.assign({iceServers:c||[],iceTransportPolicy:a||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},o),d),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}updateIceServers(e){return m(this,null,function*(){F.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)})}restartIce(e){return m(this,null,function*(){if(F.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=yield this._pc.createOffer({iceRestart:!0});F.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),yield this._pc.setLocalDescription(t);let i={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),yield this._pc.setRemoteDescription(i)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),yield this._pc.setRemoteDescription(t);let i=yield this._pc.createAnswer();F.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),yield this._pc.setLocalDescription(i)}})}getTransportStats(){return m(this,null,function*(){return this._pc.getStats()})}send(s){return m(this,arguments,function*({track:e,encodings:t,codecOptions:i,codec:n}){this._assertSendDirection(),F.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),n&&F.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let c=yield this._pc.createOffer(),a=Ce.parse(c.sdp),o,d=An.clone(this._sendingRtpParametersByKind[e.kind],{});d.codecs=Bt.reduceCodecs(d.codecs);let l=An.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});if(l.codecs=Bt.reduceCodecs(l.codecs),this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:a})),e.kind==="video"&&t&&t.length>1&&(F.debug("send() | enabling simulcast"),a=Ce.parse(c.sdp),o=a.media.find(f=>f.type==="video"),zo.addLegacySimulcast({offerMediaObject:o,track:e,numStreams:t.length}),c={type:"offer",sdp:Ce.write(a)}),F.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),yield this._pc.setLocalDescription(c),a=Ce.parse(this._pc.localDescription.sdp),o=a.media.find(f=>f.type===e.kind),d.rtcp.cname=_i.getCname({offerMediaObject:o}),d.encodings=zo.getRtpEncodings({offerMediaObject:o,track:e}),t)for(let f=0;f<d.encodings.length;++f)t[f]&&Object.assign(d.encodings[f],t[f]);if(d.encodings.length>1&&(d.codecs[0].mimeType.toLowerCase()==="video/vp8"||d.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let f of d.encodings)f.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:l,codecOptions:i});let p={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("send() | calling pc.setRemoteDescription() [answer:%o]",p),yield this._pc.setRemoteDescription(p);let u=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(u,e),{localId:u,rtpParameters:d}})}stopSending(e){return m(this,null,function*(){this._assertSendDirection(),F.debug("stopSending() [localId:%s]",e);let t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);let i=yield this._pc.createOffer();F.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i);try{yield this._pc.setLocalDescription(i)}catch(s){if(this._sendStream.getTracks().length===0){F.warn("stopSending() | ignoring expected error due no sending tracks: %s",s.toString());return}throw s}if(this._pc.signalingState==="stable")return;let n={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),yield this._pc.setRemoteDescription(n)})}replaceTrack(e,t){return m(this,null,function*(){throw new yr.UnsupportedError("not implemented")})}setMaxSpatialLayer(e,t){return m(this,null,function*(){throw new yr.UnsupportedError("not implemented")})}setRtpEncodingParameters(e,t){return m(this,null,function*(){throw new yr.UnsupportedError("not implemented")})}getSenderStats(e){return m(this,null,function*(){throw new yr.UnsupportedError("not implemented")})}sendDataChannel(a){return m(this,arguments,function*({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:s,priority:c}){this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:i,protocol:s,priority:c};F.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Wo.MIS,!this._hasDataChannelMediaSection){let p=yield this._pc.createOffer(),u=Ce.parse(p.sdp),f=u.media.find(g=>g.type==="application");this._transportReady||(yield this._setupTransport({localDtlsRole:"server",localSdpObject:u})),F.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),yield this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:f});let h={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),yield this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:l}})}receive(n){return m(this,arguments,function*({trackId:e,kind:t,rtpParameters:i}){this._assertRecvDirection(),F.debug("receive() [trackId:%s, kind:%s]",e,t);let s=e,c=t,a=i.rtcp.cname;F.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),a+=`-hack-${An.generateRandomNumber()}`,this._remoteSdp.receive({mid:c,kind:t,offerRtpParameters:i,streamId:a,trackId:e});let o={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",o),yield this._pc.setRemoteDescription(o);let d=yield this._pc.createAnswer(),l=Ce.parse(d.sdp),p=l.media.find(h=>String(h.mid)===c);_i.applyCodecParameters({offerRtpParameters:i,answerMediaObject:p}),d={type:"answer",sdp:Ce.write(l)},this._transportReady||(yield this._setupTransport({localDtlsRole:"client",localSdpObject:l})),F.debug("receive() | calling pc.setLocalDescription() [answer:%o]",d),yield this._pc.setLocalDescription(d);let f=this._pc.getRemoteStreams().find(h=>h.id===a).getTrackById(s);if(!f)throw new Error("remote track not found");return this._mapRecvLocalIdInfo.set(s,{mid:c,rtpParameters:i}),{localId:s,track:f}})}stopReceiving(e){return m(this,null,function*(){this._assertRecvDirection(),F.debug("stopReceiving() [localId:%s]",e);let{mid:t,rtpParameters:i}=this._mapRecvLocalIdInfo.get(e)||{};this._mapRecvLocalIdInfo.delete(e),this._remoteSdp.planBStopReceiving({mid:t,offerRtpParameters:i});let n={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",n),yield this._pc.setRemoteDescription(n);let s=yield this._pc.createAnswer();F.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),yield this._pc.setLocalDescription(s)})}getReceiverStats(e){return m(this,null,function*(){throw new yr.UnsupportedError("not implemented")})}receiveDataChannel(n){return m(this,arguments,function*({sctpStreamParameters:e,label:t,protocol:i}){this._assertRecvDirection();let{streamId:s,ordered:c,maxPacketLifeTime:a,maxRetransmits:o}=e,d={negotiated:!0,id:s,ordered:c,maxPacketLifeTime:a,maxRetransmitTime:a,maxRetransmits:o,protocol:i};F.debug("receiveDataChannel() [options:%o]",d);let l=this._pc.createDataChannel(t,d);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});let p={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),yield this._pc.setRemoteDescription(p);let u=yield this._pc.createAnswer();if(!this._transportReady){let f=Ce.parse(u.sdp);yield this._setupTransport({localDtlsRole:"client",localSdpObject:f})}F.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",u),yield this._pc.setLocalDescription(u),this._hasDataChannelMediaSection=!0}return{dataChannel:l}})}_setupTransport(i){return m(this,arguments,function*({localDtlsRole:e,localSdpObject:t}){t||(t=Ce.parse(this._pc.localDescription.sdp));let n=_i.extractDtlsParameters({sdpObject:t});n.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),yield this.safeEmitAsPromise("@connect",{dtlsParameters:n}),this._transportReady=!0})}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};On.ReactNative=yi});var jn=b(wi=>{"use strict";Object.defineProperty(wi,"__esModule",{value:!0});var Jp=$i(),Qp=Z(),Yp=Ue(),Ut=he(),Xp=ie(),We=de(),Zp=fn(),el=vo(),tl=wo(),rl=To(),il=Po(),nl=ko(),sl=Ao(),al=qo(),ol=$o(),cl=Vo(),re=new Qp.Logger("Device");function Go(){if(typeof navigator=="object"&&navigator.product==="ReactNative"){if(typeof RTCPeerConnection=="undefined"){re.warn("this._detectDevice() | unsupported ReactNative without RTCPeerConnection");return}return re.debug("this._detectDevice() | ReactNative handler chosen"),"ReactNative"}else if(typeof navigator=="object"&&typeof navigator.userAgent=="string"){let r=navigator.userAgent,e=Jp.getParser(r),t=e.getEngine();if(e.satisfies({chrome:">=74",chromium:">=74"}))return"Chrome74";if(e.satisfies({chrome:">=70",chromium:">=70"}))return"Chrome70";if(e.satisfies({chrome:">=67",chromium:">=67"}))return"Chrome67";if(e.satisfies({chrome:">=55",chromium:">=55"}))return"Chrome55";if(e.satisfies({firefox:">=60"}))return"Firefox60";if(e.satisfies({safari:">=12.0"})&&typeof RTCRtpTransceiver!="undefined"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(e.satisfies({safari:">=11"}))return"Safari11";if(e.satisfies({"microsoft edge":">=11"})&&e.satisfies({"microsoft edge":"<=18"}))return"Edge11";if(t.name&&t.name.toLowerCase()==="blink"){let i=r.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(i){let n=Number(i[1]);return n>=74?"Chrome74":n>=70?"Chrome70":n>=67?"Chrome67":"Chrome55"}else return"Chrome74"}else{re.warn("this._detectDevice() | browser not supported [name:%s, version:%s]",e.getBrowserName(),e.getBrowserVersion());return}}else{re.warn("this._detectDevice() | unknown device");return}}wi.detectDevice=Go;var Ko=class{constructor({handlerName:e,handlerFactory:t,Handler:i}={}){if(this._loaded=!1,this._observer=new Yp.EnhancedEventEmitter,re.debug("constructor()"),i)if(re.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),typeof i=="string")e=i;else throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)re.debug("constructor() | handler given: %s",e);else if(e=Go(),e)re.debug("constructor() | detected handler: %s",e);else throw new Ut.UnsupportedError("device not supported");switch(e){case"Chrome74":this._handlerFactory=el.Chrome74.createFactory();break;case"Chrome70":this._handlerFactory=tl.Chrome70.createFactory();break;case"Chrome67":this._handlerFactory=rl.Chrome67.createFactory();break;case"Chrome55":this._handlerFactory=il.Chrome55.createFactory();break;case"Firefox60":this._handlerFactory=nl.Firefox60.createFactory();break;case"Safari12":this._handlerFactory=sl.Safari12.createFactory();break;case"Safari11":this._handlerFactory=al.Safari11.createFactory();break;case"Edge11":this._handlerFactory=ol.Edge11.createFactory();break;case"ReactNative":this._handlerFactory=cl.ReactNative.createFactory();break;default:throw new TypeError(`unknown handlerName "${e}"`)}}let n=this._handlerFactory();this._handlerName=n.name,n.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new Ut.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new Ut.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}load(t){return m(this,arguments,function*({routerRtpCapabilities:e}){re.debug("load() [routerRtpCapabilities:%o]",e),e=Xp.clone(e,void 0);let i;try{if(this._loaded)throw new Ut.InvalidStateError("already loaded");We.validateRtpCapabilities(e),i=this._handlerFactory();let n=yield i.getNativeRtpCapabilities();re.debug("load() | got native RTP capabilities:%o",n),We.validateRtpCapabilities(n),this._extendedRtpCapabilities=We.getExtendedRtpCapabilities(n,e),re.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=We.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=We.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=We.getRecvRtpCapabilities(this._extendedRtpCapabilities),We.validateRtpCapabilities(this._recvRtpCapabilities),re.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=yield i.getNativeSctpCapabilities(),re.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),We.validateSctpCapabilities(this._sctpCapabilities),re.debug("load() succeeded"),this._loaded=!0,i.close()}catch(n){throw i&&i.close(),n}})}canProduce(e){if(this._loaded){if(e!=="audio"&&e!=="video")throw new TypeError(`invalid kind "${e}"`)}else throw new Ut.InvalidStateError("not loaded");return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,appData:l={}}){return re.debug("createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,appData:l})}createRecvTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,appData:l={}}){return re.debug("createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:s,iceServers:c,iceTransportPolicy:a,additionalSettings:o,proprietaryConstraints:d,appData:l})}_createTransport({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:s,sctpParameters:c,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:l,appData:p={}}){if(this._loaded){if(typeof t!="string")throw new TypeError("missing id");if(typeof i!="object")throw new TypeError("missing iceParameters");if(Array.isArray(n)){if(typeof s!="object")throw new TypeError("missing dtlsParameters");if(c&&typeof c!="object")throw new TypeError("wrong sctpParameters");if(p&&typeof p!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new Ut.InvalidStateError("not loaded");let u=new Zp.Transport({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:s,sctpParameters:c,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:l,appData:p,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",u),u}};wi.Device=Ko});var Ho=b(Si=>{"use strict";function Ve(r){for(var e in r)Si.hasOwnProperty(e)||(Si[e]=r[e])}Object.defineProperty(Si,"__esModule",{value:!0});Ve(jn());Ve(fn());Ve(nn());Ve(an());Ve(cn());Ve(pn());Ve(ge());Ve(he())});var Qo=b(ct=>{"use strict";Object.defineProperty(ct,"__esModule",{value:!0});var Jo=jn();ct.Device=Jo.Device;ct.detectDevice=Jo.detectDevice;var dl=Ho();ct.types=dl;ct.version="3.6.28";var pl=Zr();ct.parseScalabilityMode=pl.parse});var w=function(){return w=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e},w.apply(this,arguments)};function lt(r,e){var t={};for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&e.indexOf(i)<0&&(t[i]=r[i]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,i=Object.getOwnPropertySymbols(r);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(r,i[n])&&(t[i[n]]=r[i[n]]);return t}function D(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],i=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&i>=r.length&&(r=void 0),{value:r&&r[i++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function _e(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var i=t.call(r),n,s=[],c;try{for(;(e===void 0||e-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(a){c={error:a}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(c)throw c.error}}return s}function Y(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(_e(arguments[e]));return r}var Sr=".",Ci={},br="xstate.guard",Un="";var K=!0;function z(r){return Object.keys(r)}function Wt(r,e,t){t===void 0&&(t=Sr);var i=ut(r,t),n=ut(e,t);return P(n)?P(i)?n===i:!1:P(i)?i in n:z(i).every(function(s){return s in n?Wt(i[s],n[s]):!1})}function Rr(r){try{return P(r)||typeof r=="number"?""+r:r.type}catch(e){throw new Error("Events must be strings or objects with a string event.type property.")}}function Tr(r,e){try{return xe(r)?r:r.toString().split(e)}catch(t){throw new Error("'"+r+"' is not a valid state path.")}}function gc(r){return typeof r=="object"&&"value"in r&&"context"in r&&"event"in r&&"_event"in r}function ut(r,e){if(gc(r))return r.value;if(xe(r))return Vt(r);if(typeof r!="string")return r;var t=Tr(r,e);return Vt(t)}function Vt(r){if(r.length===1)return r[0];for(var e={},t=e,i=0;i<r.length-1;i++)i===r.length-2?t[r[i]]=r[i+1]:(t[r[i]]={},t=t[r[i]]);return e}function ft(r,e){for(var t={},i=z(r),n=0;n<i.length;n++){var s=i[n];t[s]=e(r[s],s,r,n)}return t}function xi(r,e,t){var i,n,s={};try{for(var c=D(z(r)),a=c.next();!a.done;a=c.next()){var o=a.value,d=r[o];!t(d)||(s[o]=e(d,o,r))}}catch(l){i={error:l}}finally{try{a&&!a.done&&(n=c.return)&&n.call(c)}finally{if(i)throw i.error}}return s}var $n=function(r){return function(e){var t,i,n=e;try{for(var s=D(r),c=s.next();!c.done;c=s.next()){var a=c.value;n=n[a]}}catch(o){t={error:o}}finally{try{c&&!c.done&&(i=s.return)&&i.call(s)}finally{if(t)throw t.error}}return n}};function zn(r,e){return function(t){var i,n,s=t;try{for(var c=D(r),a=c.next();!a.done;a=c.next()){var o=a.value;s=s[e][o]}}catch(d){i={error:d}}finally{try{a&&!a.done&&(n=c.return)&&n.call(c)}finally{if(i)throw i.error}}return s}}function Gt(r){if(!r)return[[]];if(P(r))return[[r]];var e=H(z(r).map(function(t){var i=r[t];return typeof i!="string"&&(!i||!Object.keys(i).length)?[[t]]:Gt(r[t]).map(function(n){return[t].concat(n)})}));return e}function H(r){var e;return(e=[]).concat.apply(e,Y(r))}function Wn(r){return xe(r)?r:[r]}function ae(r){return r===void 0?[]:Wn(r)}function Ge(r,e,t){var i,n;if(N(r))return r(e,t.data);var s={};try{for(var c=D(Object.keys(r)),a=c.next();!a.done;a=c.next()){var o=a.value,d=r[o];N(d)?s[o]=d(e,t.data):s[o]=d}}catch(l){i={error:l}}finally{try{a&&!a.done&&(n=c.return)&&n.call(c)}finally{if(i)throw i.error}}return s}function Vn(r){return/^(done|error)\./.test(r)}function Er(r){return!!(r instanceof Promise||r!==null&&(N(r)||typeof r=="object")&&N(r.then))}function Cr(r,e){var t,i,n=_e([[],[]],2),s=n[0],c=n[1];try{for(var a=D(r),o=a.next();!o.done;o=a.next()){var d=o.value;e(d)?s.push(d):c.push(d)}}catch(l){t={error:l}}finally{try{o&&!o.done&&(i=a.return)&&i.call(a)}finally{if(t)throw t.error}}return[s,c]}function Gn(r,e){return ft(r.states,function(t,i){if(!!t){var n=(P(e)?void 0:e[i])||(t?t.current:void 0);if(!!n)return{current:n,states:Gn(t,n)}}})}function Kn(r,e){return{current:e,states:Gn(r,e)}}function Hn(r,e,t,i){K||Q(!!r,"Attempting to update undefined context");var n=r&&t.reduce(function(s,c){var a,o,d=c.assignment,l={state:i,action:c,_event:e},p={};if(N(d))p=d(s,e.data,l);else try{for(var u=D(z(d)),f=u.next();!f.done;f=u.next()){var h=f.value,g=d[h];p[h]=N(g)?g(s,e.data,l):g}}catch(v){a={error:v}}finally{try{f&&!f.done&&(o=u.return)&&o.call(u)}finally{if(a)throw a.error}}return Object.assign({},s,p)},r);return n}var Q=function(){};K||(Q=function(r,e){var t=r instanceof Error?r:void 0;if(!(!t&&r)&&console!==void 0){var i=["Warning: "+e];t&&i.push(t),console.warn.apply(console,i)}});function xe(r){return Array.isArray(r)}function N(r){return typeof r=="function"}function P(r){return typeof r=="string"}function xr(r,e){if(!!r)return P(r)?{type:br,name:r,predicate:e?e[r]:void 0}:N(r)?{type:br,name:r.name,predicate:r}:r}function Pi(r){try{return"subscribe"in r&&N(r.subscribe)}catch(e){return!1}}var Jn=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function oe(r){try{return"__xstatenode"in r}catch(e){return!1}}function Qn(r){return!!r&&typeof r.send=="function"}var Yn=function(){var r=0;return function(){return r++,r.toString(16)}}();function Kt(r,e){return P(r)||typeof r=="number"?w({type:r},e):r}function X(r,e){if(!P(r)&&"$$type"in r&&r.$$type==="scxml")return r;var t=Kt(r);return w({name:t.type,data:t,$$type:"scxml",type:"external"},e)}function Ke(r,e){var t=Wn(e).map(function(i){return typeof i=="undefined"||typeof i=="string"||oe(i)?{target:i,event:r}:w(w({},i),{event:r})});return t}function Xn(r){if(!(r===void 0||r===Un))return ae(r)}function Zn(r,e,t){if(!K){var i=r.stack?" Stacktrace was '"+r.stack+"'":"";if(r===e)console.error("Missing onError handler for invocation '"+t+"', error was '"+r+"'."+i);else{var n=e.stack?" Stacktrace was '"+e.stack+"'":"";console.error("Missing onError handler and/or unhandled exception/promise rejection for invocation '"+t+"'. "+("Original error: '"+r+"'. "+i+" Current error is '"+e+"'."+n))}}}function Pr(r,e,t,i,n){var s=r.options.guards,c={state:n,cond:e,_event:i};if(e.type===br)return e.predicate(t,i.data,c);var a=s[e.type];if(!a)throw new Error("Guard '"+e.type+"' is not implemented on machine '"+r.id+"'.");return a(t,i.data,c)}function Dr(r){return typeof r=="string"?{type:r}:r}function es(r,e,t){if(typeof r=="object")return r;var i=function(){};return{next:r,error:e||i,complete:t||i}}var q;(function(r){r.Start="xstate.start",r.Stop="xstate.stop",r.Raise="xstate.raise",r.Send="xstate.send",r.Cancel="xstate.cancel",r.NullEvent="",r.Assign="xstate.assign",r.After="xstate.after",r.DoneState="done.state",r.DoneInvoke="done.invoke",r.Log="xstate.log",r.Init="xstate.init",r.Invoke="xstate.invoke",r.ErrorExecution="error.execution",r.ErrorCommunication="error.communication",r.ErrorPlatform="error.platform",r.ErrorCustom="xstate.error",r.Update="xstate.update",r.Pure="xstate.pure",r.Choose="xstate.choose"})(q||(q={}));var Pe;(function(r){r.Parent="#_parent",r.Internal="#_internal"})(Pe||(Pe={}));var Ht=q.Start,ht=q.Stop,mt=q.Raise,He=q.Send,Mr=q.Cancel,ts=q.NullEvent,Di=q.Assign,Il=q.After,Ll=q.DoneState,kr=q.Log,rs=q.Init,Jt=q.Invoke,Ol=q.ErrorExecution,Mi=q.ErrorPlatform,ki=q.ErrorCustom,Qt=q.Update,is=q.Choose,ns=q.Pure;var Je=X({type:rs});function Ir(r,e){return e&&e[r]||void 0}function gt(r,e){var t;if(P(r)||typeof r=="number"){var i=Ir(r,e);N(i)?t={type:r,exec:i}:i?t=i:t={type:r,exec:void 0}}else if(N(r))t={type:r.name||r.toString(),exec:r};else{var i=Ir(r.type,e);if(N(i))t=w(w({},r),{exec:i});else if(i){var n=i.type||r.type;t=w(w(w({},i),r),{type:n})}else t=r}return Object.defineProperty(t,"toString",{value:function(){return t.type},enumerable:!1,configurable:!0}),t}var Yt=function(r,e){if(!r)return[];var t=xe(r)?r:[r];return t.map(function(i){return gt(i,e)})};function Lr(r){var e=gt(r);return w(w({id:P(r)?r:e.id},e),{type:e.type})}function ss(r){return P(r)?{type:mt,event:r}:ye(r,{to:Pe.Internal})}function vc(r){return{type:mt,_event:X(r.event)}}function ye(r,e){return{to:e?e.to:void 0,type:He,event:N(r)?r:Kt(r),delay:e?e.delay:void 0,id:e&&e.id!==void 0?e.id:N(r)?r.name:Rr(r)}}function _c(r,e,t,i){var n={_event:t},s=X(N(r.event)?r.event(e,t.data,n):r.event),c;if(P(r.delay)){var a=i&&i[r.delay];c=N(a)?a(e,t.data,n):a}else c=N(r.delay)?r.delay(e,t.data,n):r.delay;var o=N(r.to)?r.to(e,t.data,n):r.to;return w(w({},r),{to:o,_event:s,event:s.data,delay:c})}function as(r,e){return ye(r,w(w({},e),{to:Pe.Parent}))}var yc=function(r,e,t){return w(w({},r),{value:P(r.expr)?r.expr:r.expr(e,t.data,{_event:t})})},os=function(r){return{type:Mr,sendId:r}};function cs(r){var e=Lr(r);return{type:q.Start,activity:e,exec:void 0}}function ds(r){var e=N(r)?r:Lr(r);return{type:q.Stop,activity:e,exec:void 0}}function wc(r,e,t){var i=N(r.activity)?r.activity(e,t.data):r.activity,n=typeof i=="string"?{id:i}:i,s={type:q.Stop,activity:n};return s}var fe=function(r){return{type:Di,assignment:r}};function ps(r,e){var t=e?"#"+e:"";return q.After+"("+r+")"+t}function Xt(r,e){var t=q.DoneState+"."+r,i={type:t,data:e};return i.toString=function(){return t},i}function vt(r,e){var t=q.DoneInvoke+"."+r,i={type:t,data:e};return i.toString=function(){return t},i}function Qe(r,e){var t=q.ErrorPlatform+"."+r,i={type:t,data:e};return i.toString=function(){return t},i}function Or(r,e,t,i,n){var s=_e(Cr(n,function(l){return l.type===Di}),2),c=s[0],a=s[1],o=c.length?Hn(t,i,c,e):t,d=H(a.map(function(l){var p;switch(l.type){case mt:return vc(l);case He:var u=_c(l,o,i,r.options.delays);return K||Q(!P(l.delay)||typeof u.delay=="number","No delay reference for delay expression '"+l.delay+"' was found on machine '"+r.id+"'"),u;case kr:return yc(l,o,i);case is:{var f=l,h=(p=f.conds.find(function(v){var _=xr(v.cond,r.options.guards);return!_||Pr(r,_,o,i,e)}))===null||p===void 0?void 0:p.actions;if(!h)return[];var g=Or(r,e,o,i,Yt(ae(h),r.options.actions));return o=g[1],g[0]}case ns:{var h=l.get(o,i.data);if(!h)return[];var g=Or(r,e,o,i,Yt(ae(h),r.options.actions));return o=g[1],g[0]}case ht:return wc(l,o,i);default:return gt(l,r.options.actions)}}));return[d,o]}var Zt=function(r){return r.type==="atomic"||r.type==="final"};function Ye(r){return z(r.states).map(function(e){return r.states[e]})}function Ii(r){var e=[r];return Zt(r)?e:e.concat(H(Ye(r).map(Ii)))}function Xe(r,e){var t,i,n,s,c,a,o,d,l=new Set(r),p=Li(l),u=new Set(e);try{for(var f=D(u),h=f.next();!h.done;h=f.next())for(var g=h.value,v=g.parent;v&&!u.has(v);)u.add(v),v=v.parent}catch(C){t={error:C}}finally{try{h&&!h.done&&(i=f.return)&&i.call(f)}finally{if(t)throw t.error}}var _=Li(u);try{for(var y=D(u),S=y.next();!S.done;S=y.next()){var g=S.value;if(g.type==="compound"&&(!_.get(g)||!_.get(g).length))p.get(g)?p.get(g).forEach(function(V){return u.add(V)}):g.initialStateNodes.forEach(function(V){return u.add(V)});else if(g.type==="parallel")try{for(var R=(c=void 0,D(Ye(g))),E=R.next();!E.done;E=R.next()){var L=E.value;L.type!=="history"&&(u.has(L)||(u.add(L),p.get(L)?p.get(L).forEach(function(V){return u.add(V)}):L.initialStateNodes.forEach(function(V){return u.add(V)})))}}catch(V){c={error:V}}finally{try{E&&!E.done&&(a=R.return)&&a.call(R)}finally{if(c)throw c.error}}}}catch(C){n={error:C}}finally{try{S&&!S.done&&(s=y.return)&&s.call(y)}finally{if(n)throw n.error}}try{for(var x=D(u),T=x.next();!T.done;T=x.next())for(var g=T.value,v=g.parent;v&&!u.has(v);)u.add(v),v=v.parent}catch(C){o={error:C}}finally{try{T&&!T.done&&(d=x.return)&&d.call(x)}finally{if(o)throw o.error}}return u}function ls(r,e){var t=e.get(r);if(!t)return{};if(r.type==="compound"){var i=t[0];if(i){if(Zt(i))return i.key}else return{}}var n={};return t.forEach(function(s){n[s.key]=ls(s,e)}),n}function Li(r){var e,t,i=new Map;try{for(var n=D(r),s=n.next();!s.done;s=n.next()){var c=s.value;i.has(c)||i.set(c,[]),c.parent&&(i.has(c.parent)||i.set(c.parent,[]),i.get(c.parent).push(c))}}catch(a){e={error:a}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}return i}function us(r,e){var t=Xe([r],e);return ls(r,Li(t))}function er(r,e){return Array.isArray(r)?r.some(function(t){return t===e}):r instanceof Set?r.has(e):!1}function fs(r){return H(Y(new Set(r.map(function(e){return e.ownEvents}))))}function Ze(r,e){return e.type==="compound"?Ye(e).some(function(t){return t.type==="final"&&er(r,t)}):e.type==="parallel"?Ye(e).every(function(t){return Ze(r,t)}):!1}function Oi(r,e){if(r===e)return!0;if(r===void 0||e===void 0)return!1;if(P(r)||P(e))return r===e;var t=z(r),i=z(e);return t.length===i.length&&t.every(function(n){return Oi(r[n],e[n])})}function hs(r){return P(r)?!1:"value"in r&&"history"in r}function ms(r,e){var t=r.exec,i=w(w({},r),{exec:t!==void 0?function(){return t(e.context,e.event,{action:r,state:e,_event:e._event})}:void 0});return i}var De=function(){function r(e){var t=this;this.actions=[],this.activities=Ci,this.meta={},this.events=[],this.value=e.value,this.context=e.context,this._event=e._event,this._sessionid=e._sessionid,this.event=this._event.data,this.historyValue=e.historyValue,this.history=e.history,this.actions=e.actions||[],this.activities=e.activities||Ci,this.meta=e.meta||{},this.events=e.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=e.configuration,this.transitions=e.transitions,this.children=e.children,this.done=!!e.done,Object.defineProperty(this,"nextEvents",{get:function(){return fs(t.configuration)}})}return r.from=function(e,t){if(e instanceof r)return e.context!==t?new r({value:e.value,context:t,_event:e._event,_sessionid:null,historyValue:e.historyValue,history:e.history,actions:[],activities:e.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):e;var i=Je;return new r({value:e,context:t,_event:i,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},r.create=function(e){return new r(e)},r.inert=function(e,t){if(e instanceof r){if(!e.actions.length)return e;var i=Je;return new r({value:e.value,context:t,_event:i,_sessionid:null,historyValue:e.historyValue,history:e.history,activities:e.activities,configuration:e.configuration,transitions:[],children:{}})}return r.from(e,t)},r.prototype.toStrings=function(e,t){var i=this;if(e===void 0&&(e=this.value),t===void 0&&(t="."),P(e))return[e];var n=z(e);return n.concat.apply(n,Y(n.map(function(s){return i.toStrings(e[s],t).map(function(c){return s+t+c})})))},r.prototype.toJSON=function(){var e=this,t=e.configuration,i=e.transitions,n=lt(e,["configuration","transitions"]);return n},r.prototype.matches=function(e){return Wt(e,this.value)},r}();var Ar=[],et=function(r,e){Ar.push(r);var t=e(r);return Ar.pop(),t},gs=function(r){return r(Ar[Ar.length-1])};function vs(r){return{id:r,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},toJSON:function(){return{id:r}}}}function _s(r,e,t,i){var n,s=Dr(r.src),c=(n=e==null?void 0:e.options.services)===null||n===void 0?void 0:n[s.type],a=r.data?Ge(r.data,t,i):void 0,o=c?Ai(c,r.id,a):vs(r.id);return o.meta=r,o}function Ai(r,e,t){var i=vs(e);return i.deferred=!0,oe(r)&&(i.state=et(void 0,function(){return(t?r.withContext(t):r).initialState})),i}function Sc(r){try{return typeof r.send=="function"}catch(e){return!1}}function ys(r){return Sc(r)&&"id"in r}function bc(r){if(typeof r=="string"){var e={type:r};return e.toString=function(){return r},e}return r}function tr(r){return w(w({type:Jt},r),{toJSON:function(){var e=r.onDone,t=r.onError,i=lt(r,["onDone","onError"]);return w(w({},i),{type:Jt,src:bc(r.src)})}})}var rr="",ji="#",ir="*",_t={},yt=function(r){return r[0]===ji},Rc=function(){return{actions:{},guards:{},services:{},activities:{},delays:{}}},Tc=function(r,e,t){var i=t.slice(0,-1).some(function(s){return!("cond"in s)&&!("in"in s)&&(P(s.target)||oe(s.target))}),n=e===rr?"the transient event":"event '"+e+"'";Q(!i,"One or more transitions for "+n+" on state '"+r.id+"' are unreachable. Make sure that the default transition is the last one defined.")},ws=function(){function r(e,t,i){var n=this;this.config=e,this.context=i,this.order=-1,this.__xstatenode=!0,this.__cache={events:void 0,relativeValue:new Map,initialStateValue:void 0,initialState:void 0,on:void 0,transitions:void 0,candidates:{},delayedTransitions:void 0},this.idMap={},this.options=Object.assign(Rc(),t),this.parent=this.options._parent,this.key=this.config.key||this.options._key||this.config.id||"(machine)",this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=this.config.delimiter||(this.parent?this.parent.delimiter:Sr),this.id=this.config.id||Y([this.machine.key],this.path).join(this.delimiter),this.version=this.parent?this.parent.version:this.config.version,this.type=this.config.type||(this.config.parallel?"parallel":this.config.states&&z(this.config.states).length?"compound":this.config.history?"history":"atomic"),K||Q(!("parallel"in this.config),'The "parallel" property is deprecated and will be removed in version 4.1. '+(this.config.parallel?"Replace with `type: 'parallel'`":"Use `type: '"+this.type+"'`")+" in the config for state node '"+this.id+"' instead."),this.initial=this.config.initial,this.states=this.config.states?ft(this.config.states,function(a,o){var d,l=new r(a,{_parent:n,_key:o});return Object.assign(n.idMap,w((d={},d[l.id]=l,d),l.idMap)),l}):_t;var s=0;function c(a){var o,d;a.order=s++;try{for(var l=D(Ye(a)),p=l.next();!p.done;p=l.next()){var u=p.value;c(u)}}catch(f){o={error:f}}finally{try{p&&!p.done&&(d=l.return)&&d.call(l)}finally{if(o)throw o.error}}}c(this),this.history=this.config.history===!0?"shallow":this.config.history||!1,this._transient=!!this.config.always||(this.config.on?Array.isArray(this.config.on)?this.config.on.some(function(a){var o=a.event;return o===rr}):rr in this.config.on:!1),this.strict=!!this.config.strict,this.onEntry=ae(this.config.entry||this.config.onEntry).map(function(a){return gt(a)}),this.onExit=ae(this.config.exit||this.config.onExit).map(function(a){return gt(a)}),this.meta=this.config.meta,this.doneData=this.type==="final"?this.config.data:void 0,this.invoke=ae(this.config.invoke).map(function(a,o){var d,l;if(oe(a))return n.machine.options.services=w((d={},d[a.id]=a,d),n.machine.options.services),tr({src:a.id,id:a.id});if(P(a.src))return tr(w(w({},a),{id:a.id||a.src,src:a.src}));if(oe(a.src)||N(a.src)){var p=n.id+":invocation["+o+"]";return n.machine.options.services=w((l={},l[p]=a.src,l),n.machine.options.services),tr(w(w({id:p},a),{src:p}))}else{var u=a.src;return tr(w(w({id:u.type},a),{src:u}))}}),this.activities=ae(this.config.activities).concat(this.invoke).map(function(a){return Lr(a)}),this.transition=this.transition.bind(this)}return r.prototype._init=function(){this.__cache.transitions||Ii(this).forEach(function(e){return e.on})},r.prototype.withConfig=function(e,t){t===void 0&&(t=this.context);var i=this.options,n=i.actions,s=i.activities,c=i.guards,a=i.services,o=i.delays;return new r(this.config,{actions:w(w({},n),e.actions),activities:w(w({},s),e.activities),guards:w(w({},c),e.guards),services:w(w({},a),e.services),delays:w(w({},o),e.delays)},t)},r.prototype.withContext=function(e){return new r(this.config,this.options,e)},Object.defineProperty(r.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,context:this.context,type:this.type,initial:this.initial,history:this.history,states:ft(this.states,function(e){return e.definition}),on:this.on,transitions:this.transitions,entry:this.onEntry,exit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.doneData,invoke:this.invoke}},enumerable:!1,configurable:!0}),r.prototype.toJSON=function(){return this.definition},Object.defineProperty(r.prototype,"on",{get:function(){if(this.__cache.on)return this.__cache.on;var e=this.transitions;return this.__cache.on=e.reduce(function(t,i){return t[i.eventType]=t[i.eventType]||[],t[i.eventType].push(i),t},{})},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"after",{get:function(){return this.__cache.delayedTransitions||(this.__cache.delayedTransitions=this.getDelayedTransitions(),this.__cache.delayedTransitions)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"transitions",{get:function(){return this.__cache.transitions||(this.__cache.transitions=this.formatTransitions(),this.__cache.transitions)},enumerable:!1,configurable:!0}),r.prototype.getCandidates=function(e){if(this.__cache.candidates[e])return this.__cache.candidates[e];var t=e===rr,i=this.transitions.filter(function(n){var s=n.eventType===e;return t?s:s||n.eventType===ir});return this.__cache.candidates[e]=i,i},r.prototype.getDelayedTransitions=function(){var e=this,t=this.config.after;if(!t)return[];var i=function(s,c){var a=N(s)?e.id+":delay["+c+"]":s,o=ps(a,e.id);return e.onEntry.push(ye(o,{delay:s})),e.onExit.push(os(o)),o},n=xe(t)?t.map(function(s,c){var a=i(s.delay,c);return w(w({},s),{event:a})}):H(z(t).map(function(s,c){var a=t[s],o=P(a)?{target:a}:a,d=isNaN(+s)?s:+s,l=i(d,c);return ae(o).map(function(p){return w(w({},p),{event:l,delay:d})})}));return n.map(function(s){var c=s.delay;return w(w({},e.formatTransition(s)),{delay:c})})},r.prototype.getStateNodes=function(e){var t,i=this;if(!e)return[];var n=e instanceof De?e.value:ut(e,this.delimiter);if(P(n)){var s=this.getStateNode(n).initial;return s!==void 0?this.getStateNodes((t={},t[n]=s,t)):[this.states[n]]}var c=z(n),a=c.map(function(o){return i.getStateNode(o)});return a.concat(c.reduce(function(o,d){var l=i.getStateNode(d).getStateNodes(n[d]);return o.concat(l)},[]))},r.prototype.handles=function(e){var t=Rr(e);return this.events.includes(t)},r.prototype.resolveState=function(e){var t=Array.from(Xe([],this.getStateNodes(e.value)));return new De(w(w({},e),{value:this.resolve(e.value),configuration:t,done:Ze(t,this)}))},r.prototype.transitionLeafNode=function(e,t,i){var n=this.getStateNode(e),s=n.next(t,i);return!s||!s.transitions.length?this.next(t,i):s},r.prototype.transitionCompoundNode=function(e,t,i){var n=z(e),s=this.getStateNode(n[0]),c=s._transition(e[n[0]],t,i);return!c||!c.transitions.length?this.next(t,i):c},r.prototype.transitionParallelNode=function(e,t,i){var n,s,c={};try{for(var a=D(z(e)),o=a.next();!o.done;o=a.next()){var d=o.value,l=e[d];if(!!l){var p=this.getStateNode(d),u=p._transition(l,t,i);u&&(c[d]=u)}}}catch(y){n={error:y}}finally{try{o&&!o.done&&(s=a.return)&&s.call(a)}finally{if(n)throw n.error}}var f=z(c).map(function(y){return c[y]}),h=H(f.map(function(y){return y.transitions})),g=f.some(function(y){return y.transitions.length>0});if(!g)return this.next(t,i);var v=H(f.map(function(y){return y.entrySet})),_=H(z(c).map(function(y){return c[y].configuration}));return{transitions:h,entrySet:v,exitSet:H(f.map(function(y){return y.exitSet})),configuration:_,source:t,actions:H(z(c).map(function(y){return c[y].actions}))}},r.prototype._transition=function(e,t,i){return P(e)?this.transitionLeafNode(e,t,i):z(e).length===1?this.transitionCompoundNode(e,t,i):this.transitionParallelNode(e,t,i)},r.prototype.next=function(e,t){var i,n,s=this,c=t.name,a=[],o=[],d;try{for(var l=D(this.getCandidates(c)),p=l.next();!p.done;p=l.next()){var u=p.value,f=u.cond,h=u.in,g=e.context,v=h?P(h)&&yt(h)?e.matches(ut(this.getStateNodeById(h).path,this.delimiter)):Wt(ut(h,this.delimiter),$n(this.path.slice(0,-2))(e.value)):!0,_=!1;try{_=!f||Pr(this.machine,f,g,t,e)}catch(E){throw new Error("Unable to evaluate guard '"+(f.name||f.type)+"' in transition for event '"+c+"' in state node '"+this.id+`':
`+E.message)}if(_&&v){u.target!==void 0&&(o=u.target),a.push.apply(a,Y(u.actions)),d=u;break}}}catch(E){i={error:E}}finally{try{p&&!p.done&&(n=l.return)&&n.call(l)}finally{if(i)throw i.error}}if(!!d){if(!o.length)return{transitions:[d],entrySet:[],exitSet:[],configuration:e.value?[this]:[],source:e,actions:a};var y=H(o.map(function(E){return s.getRelativeStateNodes(E,e.historyValue)})),S=!!d.internal,R=S?[]:H(y.map(function(E){return s.nodesFromChild(E)}));return{transitions:[d],entrySet:R,exitSet:S?[]:[this],configuration:y,source:e,actions:a}}},r.prototype.nodesFromChild=function(e){if(e.escapes(this))return[];for(var t=[],i=e;i&&i!==this;)t.push(i),i=i.parent;return t.push(this),t},r.prototype.escapes=function(e){if(this===e)return!1;for(var t=this.parent;t;){if(t===e)return!1;t=t.parent}return!0},r.prototype.getActions=function(e,t,i,n){var s,c,a,o,d=Xe([],n?this.getStateNodes(n.value):[this]),l=e.configuration.length?Xe(d,e.configuration):d;try{for(var p=D(l),u=p.next();!u.done;u=p.next()){var f=u.value;er(d,f)||e.entrySet.push(f)}}catch(x){s={error:x}}finally{try{u&&!u.done&&(c=p.return)&&c.call(p)}finally{if(s)throw s.error}}try{for(var h=D(d),g=h.next();!g.done;g=h.next()){var f=g.value;(!er(l,f)||er(e.exitSet,f.parent))&&e.exitSet.push(f)}}catch(x){a={error:x}}finally{try{g&&!g.done&&(o=h.return)&&o.call(h)}finally{if(a)throw a.error}}e.source||(e.exitSet=[],e.entrySet.push(this));var v=H(e.entrySet.map(function(x){var T=[];if(x.type!=="final")return T;var C=x.parent;if(!C.parent)return T;T.push(Xt(x.id,x.doneData),Xt(C.id,x.doneData?Ge(x.doneData,t,i):void 0));var V=C.parent;return V.type==="parallel"&&Ye(V).every(function(Fe){return Ze(e.configuration,Fe)})&&T.push(Xt(V.id)),T}));e.exitSet.sort(function(x,T){return T.order-x.order}),e.entrySet.sort(function(x,T){return x.order-T.order});var _=new Set(e.entrySet),y=new Set(e.exitSet),S=_e([H(Array.from(_).map(function(x){return Y(x.activities.map(function(T){return cs(T)}),x.onEntry)})).concat(v.map(ss)),H(Array.from(y).map(function(x){return Y(x.onExit,x.activities.map(function(T){return ds(T)}))}))],2),R=S[0],E=S[1],L=Yt(E.concat(e.actions).concat(R),this.machine.options.actions);return L},r.prototype.transition=function(e,t,i){e===void 0&&(e=this.initialState);var n=X(t),s;if(e instanceof De)s=i===void 0?e:this.resolveState(De.from(e,i));else{var c=P(e)?this.resolve(Vt(this.getResolvedPath(e))):this.resolve(e),a=i||this.machine.context;s=this.resolveState(De.from(c,a))}if(!K&&n.name===ir)throw new Error("An event cannot have the wildcard type ('"+ir+"')");if(this.strict&&!this.events.includes(n.name)&&!Vn(n.name))throw new Error("Machine '"+this.id+"' does not accept event '"+n.name+"'");var o=this._transition(s.value,s,n)||{transitions:[],configuration:[],entrySet:[],exitSet:[],source:s,actions:[]},d=Xe([],this.getStateNodes(s.value)),l=o.configuration.length?Xe(d,o.configuration):d;return o.configuration=Y(l),this.resolveTransition(o,s,n)},r.prototype.resolveRaisedTransition=function(e,t,i){var n,s=e.actions;return e=this.transition(e,t),e._event=i,e.event=i.data,(n=e.actions).unshift.apply(n,Y(s)),e},r.prototype.resolveTransition=function(e,t,i,n){var s,c,a=this;i===void 0&&(i=Je),n===void 0&&(n=this.machine.context);var o=e.configuration,d=!t||e.transitions.length>0,l=d?us(this.machine,o):void 0,p=t?t.historyValue?t.historyValue:e.source?this.machine.historyValue(t.value):void 0:void 0,u=t?t.context:n,f=this.getActions(e,u,i,t),h=t?w({},t.activities):{};try{for(var g=D(f),v=g.next();!v.done;v=g.next()){var _=v.value;_.type===Ht?h[_.activity.id||_.activity.type]=_:_.type===ht&&(h[_.activity.id||_.activity.type]=!1)}}catch(te){s={error:te}}finally{try{v&&!v.done&&(c=g.return)&&c.call(g)}finally{if(s)throw s.error}}var y=_e(Or(this,t,u,i,f),2),S=y[0],R=y[1],E=_e(Cr(S,function(te){return te.type===mt||te.type===He&&te.to===Pe.Internal}),2),L=E[0],x=E[1],T=S.filter(function(te){var ve;return te.type===Ht&&((ve=te.activity)===null||ve===void 0?void 0:ve.type)===Jt}),C=T.reduce(function(te,ve){return te[ve.activity.id]=_s(ve.activity,a.machine,R,i),te},t?w({},t.children):{}),V=l?e.configuration:t?t.configuration:[],Fe=V.reduce(function(te,ve){return ve.meta!==void 0&&(te[ve.id]=ve.meta),te},{}),qe=Ze(V,this),dt=new De({value:l||t.value,context:R,_event:i,_sessionid:t?t._sessionid:null,historyValue:l?p?Kn(p,l):void 0:t?t.historyValue:void 0,history:!l||e.source?t:void 0,actions:l?x:[],activities:l?h:t?t.activities:{},meta:l?Fe:t?t.meta:void 0,events:[],configuration:V,transitions:e.transitions,children:C,done:qe}),wr=u!==R;dt.changed=i.name===Qt||wr;var pt=dt.history;if(pt&&delete pt.history,!l)return dt;var ue=dt;if(!qe){var ac=this._transient||o.some(function(te){return te._transient});for(ac&&(ue=this.resolveRaisedTransition(ue,{type:ts},i));L.length;){var oc=L.shift();ue=this.resolveRaisedTransition(ue,oc._event,i)}}var cc=ue.changed||(pt?!!ue.actions.length||wr||typeof pt.value!=typeof ue.value||!Oi(ue.value,pt.value):void 0);return ue.changed=cc,ue.history=pt,ue},r.prototype.getStateNode=function(e){if(yt(e))return this.machine.getStateNodeById(e);if(!this.states)throw new Error("Unable to retrieve child state '"+e+"' from '"+this.id+"'; no child states exist.");var t=this.states[e];if(!t)throw new Error("Child state '"+e+"' does not exist on '"+this.id+"'");return t},r.prototype.getStateNodeById=function(e){var t=yt(e)?e.slice(ji.length):e;if(t===this.id)return this;var i=this.machine.idMap[t];if(!i)throw new Error("Child state node '#"+t+"' does not exist on machine '"+this.id+"'");return i},r.prototype.getStateNodeByPath=function(e){if(typeof e=="string"&&yt(e))try{return this.getStateNodeById(e.slice(1))}catch(s){}for(var t=Tr(e,this.delimiter).slice(),i=this;t.length;){var n=t.shift();if(!n.length)break;i=i.getStateNode(n)}return i},r.prototype.resolve=function(e){var t,i=this;if(!e)return this.initialStateValue||_t;switch(this.type){case"parallel":return ft(this.initialStateValue,function(s,c){return s?i.getStateNode(c).resolve(e[c]||s):_t});case"compound":if(P(e)){var n=this.getStateNode(e);return n.type==="parallel"||n.type==="compound"?(t={},t[e]=n.initialStateValue,t):e}return z(e).length?ft(e,function(s,c){return s?i.getStateNode(c).resolve(s):_t}):this.initialStateValue||{};default:return e||_t}},r.prototype.getResolvedPath=function(e){if(yt(e)){var t=this.machine.idMap[e.slice(ji.length)];if(!t)throw new Error("Unable to find state node '"+e+"'");return t.path}return Tr(e,this.delimiter)},Object.defineProperty(r.prototype,"initialStateValue",{get:function(){var e;if(this.__cache.initialStateValue)return this.__cache.initialStateValue;var t;if(this.type==="parallel")t=xi(this.states,function(i){return i.initialStateValue||_t},function(i){return i.type!=="history"});else if(this.initial!==void 0){if(!this.states[this.initial])throw new Error("Initial state '"+this.initial+"' not found on '"+this.key+"'");t=Zt(this.states[this.initial])?this.initial:(e={},e[this.initial]=this.states[this.initial].initialStateValue,e)}return this.__cache.initialStateValue=t,this.__cache.initialStateValue},enumerable:!1,configurable:!0}),r.prototype.getInitialState=function(e,t){var i=this.getStateNodes(e);return this.resolveTransition({configuration:i,entrySet:i,exitSet:[],transitions:[],source:void 0,actions:[]},void 0,void 0,t)},Object.defineProperty(r.prototype,"initialState",{get:function(){this._init();var e=this.initialStateValue;if(!e)throw new Error("Cannot retrieve initial state from simple state '"+this.id+"'.");return this.getInitialState(e)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){var e;if(this.type==="history"){var t=this.config;P(t.target)?e=yt(t.target)?Vt(this.machine.getStateNodeById(t.target).path.slice(this.path.length-1)):t.target:e=t.target}return e},enumerable:!1,configurable:!0}),r.prototype.getRelativeStateNodes=function(e,t,i){return i===void 0&&(i=!0),i?e.type==="history"?e.resolveHistory(t):e.initialStateNodes:[e]},Object.defineProperty(r.prototype,"initialStateNodes",{get:function(){var e=this;if(Zt(this))return[this];if(this.type==="compound"&&!this.initial)return K||Q(!1,"Compound state node '"+this.id+"' has no initial state."),[this];var t=Gt(this.initialStateValue);return H(t.map(function(i){return e.getFromRelativePath(i)}))},enumerable:!1,configurable:!0}),r.prototype.getFromRelativePath=function(e){if(!e.length)return[this];var t=_e(e),i=t[0],n=t.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '"+i+"' from node with no states");var s=this.getStateNode(i);if(s.type==="history")return s.resolveHistory();if(!this.states[i])throw new Error("Child state '"+i+"' does not exist on '"+this.id+"'");return this.states[i].getFromRelativePath(n)},r.prototype.historyValue=function(e){if(!!z(this.states).length)return{current:e||this.initialStateValue,states:xi(this.states,function(t,i){if(!e)return t.historyValue();var n=P(e)?void 0:e[i];return t.historyValue(n||t.initialStateValue)},function(t){return!t.history})}},r.prototype.resolveHistory=function(e){var t=this;if(this.type!=="history")return[this];var i=this.parent;if(!e){var n=this.target;return n?H(Gt(n).map(function(c){return i.getFromRelativePath(c)})):i.initialStateNodes}var s=zn(i.path,"states")(e).current;return P(s)?[i.getStateNode(s)]:H(Gt(s).map(function(c){return t.history==="deep"?i.getFromRelativePath(c):[i.states[c[0]]]}))},Object.defineProperty(r.prototype,"stateIds",{get:function(){var e=this,t=H(z(this.states).map(function(i){return e.states[i].stateIds}));return[this.id].concat(t)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"events",{get:function(){var e,t,i,n;if(this.__cache.events)return this.__cache.events;var s=this.states,c=new Set(this.ownEvents);if(s)try{for(var a=D(z(s)),o=a.next();!o.done;o=a.next()){var d=o.value,l=s[d];if(l.states)try{for(var p=(i=void 0,D(l.events)),u=p.next();!u.done;u=p.next()){var f=u.value;c.add(""+f)}}catch(h){i={error:h}}finally{try{u&&!u.done&&(n=p.return)&&n.call(p)}finally{if(i)throw i.error}}}}catch(h){e={error:h}}finally{try{o&&!o.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}return this.__cache.events=Array.from(c)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"ownEvents",{get:function(){var e=new Set(this.transitions.filter(function(t){return!(!t.target&&!t.actions.length&&t.internal)}).map(function(t){return t.eventType}));return Array.from(e)},enumerable:!1,configurable:!0}),r.prototype.resolveTarget=function(e){var t=this;if(e!==void 0)return e.map(function(i){if(!P(i))return i;var n=i[0]===t.delimiter;if(n&&!t.parent)return t.getStateNodeByPath(i.slice(1));var s=n?t.key+i:i;if(t.parent)try{var c=t.parent.getStateNodeByPath(s);return c}catch(a){throw new Error("Invalid transition definition for state node '"+t.id+`':
`+a.message)}else return t.getStateNodeByPath(s)})},r.prototype.formatTransition=function(e){var t=this,i=Xn(e.target),n="internal"in e?e.internal:i?i.some(function(o){return P(o)&&o[0]===t.delimiter}):!0,s=this.machine.options.guards,c=this.resolveTarget(i),a=w(w({},e),{actions:Yt(ae(e.actions)),cond:xr(e.cond,s),target:c,source:this,internal:n,eventType:e.event,toJSON:function(){return w(w({},a),{target:a.target?a.target.map(function(o){return"#"+o.id}):void 0,source:"#"+t.id})}});return a},r.prototype.formatTransitions=function(){var e,t,i=this,n;if(!this.config.on)n=[];else if(Array.isArray(this.config.on))n=this.config.on;else{var s=this.config.on,c=ir,a=s[c],o=a===void 0?[]:a,d=lt(s,[typeof c=="symbol"?c:c+""]);n=H(z(d).map(function(y){!K&&y===rr&&Q(!1,"Empty string transition configs (e.g., `{ on: { '': ... }}`) for transient transitions are deprecated. Specify the transition in the `{ always: ... }` property instead. "+('Please check the `on` configuration for "#'+i.id+'".'));var S=Ke(y,d[y]);return K||Tc(i,y,S),S}).concat(Ke(ir,o)))}var l=this.config.always?Ke("",this.config.always):[],p=this.config.onDone?Ke(String(Xt(this.id)),this.config.onDone):[];K||Q(!(this.config.onDone&&!this.parent),'Root nodes cannot have an ".onDone" transition. Please check the config of "'+this.id+'".');var u=H(this.invoke.map(function(y){var S=[];return y.onDone&&S.push.apply(S,Y(Ke(String(vt(y.id)),y.onDone))),y.onError&&S.push.apply(S,Y(Ke(String(Qe(y.id)),y.onError))),S})),f=this.after,h=H(Y(p,u,n,l).map(function(y){return ae(y).map(function(S){return i.formatTransition(S)})}));try{for(var g=D(f),v=g.next();!v.done;v=g.next()){var _=v.value;h.push(_)}}catch(y){e={error:y}}finally{try{v&&!v.done&&(t=g.return)&&t.call(g)}finally{if(e)throw e.error}}return h},r}();function jr(r,e,t){t===void 0&&(t=r.context);var i=typeof t=="function"?t():t;return new ws(r,e,i)}var Ec={deferEvents:!1},Ni=function(){function r(e){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=w(w({},Ec),e)}return r.prototype.initialize=function(e){if(this.initialized=!0,e){if(!this.options.deferEvents){this.schedule(e);return}this.process(e)}this.flushEvents()},r.prototype.schedule=function(e){if(!this.initialized||this.processingEvent){this.queue.push(e);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(e),this.flushEvents()},r.prototype.clear=function(){this.queue=[]},r.prototype.flushEvents=function(){for(var e=this.queue.shift();e;)this.process(e),e=this.queue.shift()},r.prototype.process=function(e){this.processingEvent=!0;try{e()}catch(t){throw this.clear(),t}finally{this.processingEvent=!1}},r}();var Fi=new Map,Cc=0,nr={bookId:function(){return"x:"+Cc++},register:function(r,e){return Fi.set(r,e),r},get:function(r){return Fi.get(r)},free:function(r){Fi.delete(r)}};function Nr(){if(typeof self!="undefined")return self;if(typeof window!="undefined")return window;if(typeof global!="undefined")return global}function xc(){var r=Nr();if(r&&"__xstate__"in r)return r.__xstate__}function Ss(r){if(!(K||!Nr())){var e=xc();e&&e.register(r)}}var qi={sync:!1,autoForward:!1},ne;(function(r){r[r.NotStarted=0]="NotStarted",r[r.Running=1]="Running",r[r.Stopped=2]="Stopped"})(ne||(ne={}));var Pc=function(){function r(e,t){var i=this;t===void 0&&(t=r.defaultOptions),this.machine=e,this.scheduler=new Ni,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=ne.NotStarted,this.children=new Map,this.forwardTo=new Set,this.init=this.start,this.send=function(l,p){if(xe(l))return i.batch(l),i.state;var u=X(Kt(l,p));if(i.status===ne.Stopped)return K||Q(!1,'Event "'+u.name+'" was sent to stopped service "'+i.machine.id+`". This service has already reached its final state, and will not transition.
Event: `+JSON.stringify(u.data)),i.state;if(i.status!==ne.Running&&!i.options.deferEvents)throw new Error('Event "'+u.name+'" was sent to uninitialized service "'+i.machine.id+`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `+JSON.stringify(u.data));return i.scheduler.schedule(function(){i.forward(u);var f=i.nextState(u);i.update(f,u)}),i._state},this.sendTo=function(l,p){var u=i.parent&&(p===Pe.Parent||i.parent.id===p),f=u?i.parent:P(p)?i.children.get(p)||nr.get(p):Qn(p)?p:void 0;if(!f){if(!u)throw new Error("Unable to send event to child '"+p+"' from service '"+i.id+"'.");K||Q(!1,"Service '"+i.id+"' has no parent: unable to send event "+l.type);return}"machine"in f?f.send(w(w({},l),{name:l.name===ki?""+Qe(i.id):l.name,origin:i.sessionId})):f.send(l.data)};var n=w(w({},r.defaultOptions),t),s=n.clock,c=n.logger,a=n.parent,o=n.id,d=o!==void 0?o:e.id;this.id=d,this.logger=c,this.clock=s,this.parent=a,this.options=n,this.scheduler=new Ni({deferEvents:this.options.deferEvents}),this.sessionId=nr.bookId()}return Object.defineProperty(r.prototype,"initialState",{get:function(){var e=this;return this._initialState?this._initialState:et(this,function(){return e._initialState=e.machine.initialState,e._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"state",{get:function(){return K||Q(this.status!==ne.NotStarted,"Attempted to read state from uninitialized service '"+this.id+"'. Make sure the service is started first."),this._state},enumerable:!1,configurable:!0}),r.prototype.execute=function(e,t){var i,n;try{for(var s=D(e.actions),c=s.next();!c.done;c=s.next()){var a=c.value;this.exec(a,e,t)}}catch(o){i={error:o}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}},r.prototype.update=function(e,t){var i,n,s,c,a,o,d,l,p=this;if(e._sessionid=this.sessionId,this._state=e,this.options.execute&&this.execute(this.state),this.children.forEach(function(C){p.state.children[C.id]=C}),this.devTools&&this.devTools.send(t.data,e),e.event)try{for(var u=D(this.eventListeners),f=u.next();!f.done;f=u.next()){var h=f.value;h(e.event)}}catch(C){i={error:C}}finally{try{f&&!f.done&&(n=u.return)&&n.call(u)}finally{if(i)throw i.error}}try{for(var g=D(this.listeners),v=g.next();!v.done;v=g.next()){var h=v.value;h(e,e.event)}}catch(C){s={error:C}}finally{try{v&&!v.done&&(c=g.return)&&c.call(g)}finally{if(s)throw s.error}}try{for(var _=D(this.contextListeners),y=_.next();!y.done;y=_.next()){var S=y.value;S(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(C){a={error:C}}finally{try{y&&!y.done&&(o=_.return)&&o.call(_)}finally{if(a)throw a.error}}var R=Ze(e.configuration||[],this.machine);if(this.state.configuration&&R){var E=e.configuration.find(function(C){return C.type==="final"&&C.parent===p.machine}),L=E&&E.doneData?Ge(E.doneData,e.context,t):void 0;try{for(var x=D(this.doneListeners),T=x.next();!T.done;T=x.next()){var h=T.value;h(vt(this.id,L))}}catch(C){d={error:C}}finally{try{T&&!T.done&&(l=x.return)&&l.call(x)}finally{if(d)throw d.error}}this.stop()}},r.prototype.onTransition=function(e){return this.listeners.add(e),this.status===ne.Running&&e(this.state,this.state.event),this},r.prototype.subscribe=function(e,t,i){var n=this;if(!e)return{unsubscribe:function(){}};var s,c=i;return typeof e=="function"?s=e:(s=e.next.bind(e),c=e.complete.bind(e)),this.listeners.add(s),this.status===ne.Running&&s(this.state),c&&this.onDone(c),{unsubscribe:function(){s&&n.listeners.delete(s),c&&n.doneListeners.delete(c)}}},r.prototype.onEvent=function(e){return this.eventListeners.add(e),this},r.prototype.onSend=function(e){return this.sendListeners.add(e),this},r.prototype.onChange=function(e){return this.contextListeners.add(e),this},r.prototype.onStop=function(e){return this.stopListeners.add(e),this},r.prototype.onDone=function(e){return this.doneListeners.add(e),this},r.prototype.off=function(e){return this.listeners.delete(e),this.eventListeners.delete(e),this.sendListeners.delete(e),this.stopListeners.delete(e),this.doneListeners.delete(e),this.contextListeners.delete(e),this},r.prototype.start=function(e){var t=this;if(this.status===ne.Running)return this;nr.register(this.sessionId,this),this.initialized=!0,this.status=ne.Running;var i=e===void 0?this.initialState:et(this,function(){return hs(e)?t.machine.resolveState(e):t.machine.resolveState(De.from(e,t.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){t.update(i,Je)}),this},r.prototype.stop=function(){var e,t,i,n,s,c,a,o,d,l,p=this;try{for(var u=D(this.listeners),f=u.next();!f.done;f=u.next()){var h=f.value;this.listeners.delete(h)}}catch(T){e={error:T}}finally{try{f&&!f.done&&(t=u.return)&&t.call(u)}finally{if(e)throw e.error}}try{for(var g=D(this.stopListeners),v=g.next();!v.done;v=g.next()){var h=v.value;h(),this.stopListeners.delete(h)}}catch(T){i={error:T}}finally{try{v&&!v.done&&(n=g.return)&&n.call(g)}finally{if(i)throw i.error}}try{for(var _=D(this.contextListeners),y=_.next();!y.done;y=_.next()){var h=y.value;this.contextListeners.delete(h)}}catch(T){s={error:T}}finally{try{y&&!y.done&&(c=_.return)&&c.call(_)}finally{if(s)throw s.error}}try{for(var S=D(this.doneListeners),R=S.next();!R.done;R=S.next()){var h=R.value;this.doneListeners.delete(h)}}catch(T){a={error:T}}finally{try{R&&!R.done&&(o=S.return)&&o.call(S)}finally{if(a)throw a.error}}if(!this.initialized)return this;this.state.configuration.forEach(function(T){var C,V;try{for(var Fe=D(T.definition.exit),qe=Fe.next();!qe.done;qe=Fe.next()){var dt=qe.value;p.exec(dt,p.state)}}catch(wr){C={error:wr}}finally{try{qe&&!qe.done&&(V=Fe.return)&&V.call(Fe)}finally{if(C)throw C.error}}}),this.children.forEach(function(T){N(T.stop)&&T.stop()});try{for(var E=D(z(this.delayedEventsMap)),L=E.next();!L.done;L=E.next()){var x=L.value;this.clock.clearTimeout(this.delayedEventsMap[x])}}catch(T){d={error:T}}finally{try{L&&!L.done&&(l=E.return)&&l.call(E)}finally{if(d)throw d.error}}return this.scheduler.clear(),this.initialized=!1,this.status=ne.Stopped,nr.free(this.sessionId),this},r.prototype.batch=function(e){var t=this;if(this.status===ne.NotStarted&&this.options.deferEvents)K||Q(!1,e.length+' event(s) were sent to uninitialized service "'+this.machine.id+`" and are deferred. Make sure .start() is called for this service.
Event: `+JSON.stringify(event));else if(this.status!==ne.Running)throw new Error(e.length+' event(s) were sent to uninitialized service "'+this.machine.id+'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.');this.scheduler.schedule(function(){var i,n,s=t.state,c=!1,a=[],o=function(u){var f=X(u);t.forward(f),s=et(t,function(){return t.machine.transition(s,f)}),a.push.apply(a,Y(s.actions.map(function(h){return ms(h,s)}))),c=c||!!s.changed};try{for(var d=D(e),l=d.next();!l.done;l=d.next()){var p=l.value;o(p)}}catch(u){i={error:u}}finally{try{l&&!l.done&&(n=d.return)&&n.call(d)}finally{if(i)throw i.error}}s.changed=c,s.actions=a,t.update(s,X(e[e.length-1]))})},r.prototype.sender=function(e){return this.send.bind(this,e)},r.prototype.nextState=function(e){var t=this,i=X(e);if(i.name.indexOf(Mi)===0&&!this.state.nextEvents.some(function(s){return s.indexOf(Mi)===0}))throw i.data.data;var n=et(this,function(){return t.machine.transition(t.state,i)});return n},r.prototype.forward=function(e){var t,i;try{for(var n=D(this.forwardTo),s=n.next();!s.done;s=n.next()){var c=s.value,a=this.children.get(c);if(!a)throw new Error("Unable to forward event '"+e+"' from interpreter '"+this.id+"' to nonexistant child '"+c+"'.");a.send(e)}}catch(o){t={error:o}}finally{try{s&&!s.done&&(i=n.return)&&i.call(n)}finally{if(t)throw t.error}}},r.prototype.defer=function(e){var t=this;this.delayedEventsMap[e.id]=this.clock.setTimeout(function(){e.to?t.sendTo(e._event,e.to):t.send(e._event)},e.delay)},r.prototype.cancel=function(e){this.clock.clearTimeout(this.delayedEventsMap[e]),delete this.delayedEventsMap[e]},r.prototype.exec=function(e,t,i){i===void 0&&(i=this.machine.options.actions);var n=t.context,s=t._event,c=e.exec||Ir(e.type,i),a=N(c)?c:c?c.exec:e.exec;if(a)try{return a(n,s.data,{action:e,state:this.state,_event:s})}catch(S){throw this.parent&&this.parent.send({type:"xstate.error",data:S}),S}switch(e.type){case He:var o=e;if(typeof o.delay=="number"){this.defer(o);return}else o.to?this.sendTo(o._event,o.to):this.send(o._event);break;case Mr:this.cancel(e.sendId);break;case Ht:{var d=e.activity;if(!this.state.activities[d.id||d.type])break;if(d.type===q.Invoke){var l=Dr(d.src),p=this.machine.options.services?this.machine.options.services[l.type]:void 0,u=d.id,f=d.data;K||Q(!("forward"in d),"`forward` property is deprecated (found in invocation of '"+d.src+"' in in machine '"+this.machine.id+"'). Please use `autoForward` instead.");var h="autoForward"in d?d.autoForward:!!d.forward;if(!p){K||Q(!1,"No service found for invocation '"+d.src+"' in machine '"+this.machine.id+"'.");return}var g=f?Ge(f,n,s):void 0,v=N(p)?p(n,s.data,{data:g,src:l}):p;Er(v)?this.spawnPromise(Promise.resolve(v),u):N(v)?this.spawnCallback(v,u):Pi(v)?this.spawnObservable(v,u):oe(v)&&this.spawnMachine(g?v.withContext(g):v,{id:u,autoForward:h})}else this.spawnActivity(d);break}case ht:{this.stopChild(e.activity.id);break}case kr:var _=e.label,y=e.value;_?this.logger(_,y):this.logger(y);break;default:K||Q(!1,"No implementation found for action type '"+e.type+"'");break}},r.prototype.removeChild=function(e){this.children.delete(e),this.forwardTo.delete(e),delete this.state.children[e]},r.prototype.stopChild=function(e){var t=this.children.get(e);!t||(this.removeChild(e),N(t.stop)&&t.stop())},r.prototype.spawn=function(e,t,i){if(Er(e))return this.spawnPromise(Promise.resolve(e),t);if(N(e))return this.spawnCallback(e,t);if(ys(e))return this.spawnActor(e);if(Pi(e))return this.spawnObservable(e,t);if(oe(e))return this.spawnMachine(e,w(w({},i),{id:t}));throw new Error('Unable to spawn entity "'+t+'" of type "'+typeof e+'".')},r.prototype.spawnMachine=function(e,t){var i=this;t===void 0&&(t={});var n=new r(e,w(w({},this.options),{parent:this,id:t.id||e.id})),s=w(w({},qi),t);s.sync&&n.onTransition(function(a){i.send(Qt,{state:a,id:n.id})});var c=n;return this.children.set(n.id,c),s.autoForward&&this.forwardTo.add(n.id),n.onDone(function(a){i.removeChild(n.id),i.send(X(a,{origin:n.id}))}).start(),c},r.prototype.spawnPromise=function(e,t){var i=this,n=!1;e.then(function(c){n||(i.removeChild(t),i.send(X(vt(t,c),{origin:t})))},function(c){if(!n){i.removeChild(t);var a=Qe(t,c);try{i.send(X(a,{origin:t}))}catch(o){Zn(c,o,t),i.devTools&&i.devTools.send(a,i.state),i.machine.strict&&i.stop()}}});var s={id:t,send:function(){},subscribe:function(c,a,o){var d=es(c,a,o),l=!1;return e.then(function(p){l||(d.next(p),!l&&d.complete())},function(p){l||d.error(p)}),{unsubscribe:function(){return l=!0}}},stop:function(){n=!0},toJSON:function(){return{id:t}}};return this.children.set(t,s),s},r.prototype.spawnCallback=function(e,t){var i=this,n=!1,s=new Set,c=new Set,a=function(l){c.forEach(function(p){return p(l)}),!n&&i.send(X(l,{origin:t}))},o;try{o=e(a,function(l){s.add(l)})}catch(l){this.send(Qe(t,l))}if(Er(o))return this.spawnPromise(o,t);var d={id:t,send:function(l){return s.forEach(function(p){return p(l)})},subscribe:function(l){return c.add(l),{unsubscribe:function(){c.delete(l)}}},stop:function(){n=!0,N(o)&&o()},toJSON:function(){return{id:t}}};return this.children.set(t,d),d},r.prototype.spawnObservable=function(e,t){var i=this,n=e.subscribe(function(c){i.send(X(c,{origin:t}))},function(c){i.removeChild(t),i.send(X(Qe(t,c),{origin:t}))},function(){i.removeChild(t),i.send(X(vt(t),{origin:t}))}),s={id:t,send:function(){},subscribe:function(c,a,o){return e.subscribe(c,a,o)},stop:function(){return n.unsubscribe()},toJSON:function(){return{id:t}}};return this.children.set(t,s),s},r.prototype.spawnActor=function(e){return this.children.set(e.id,e),e},r.prototype.spawnActivity=function(e){var t=this.machine.options&&this.machine.options.activities?this.machine.options.activities[e.type]:void 0;if(!t){K||Q(!1,"No implementation found for activity '"+e.type+"'");return}var i=t(this.state.context,e);this.spawnEffect(e.id,i)},r.prototype.spawnEffect=function(e,t){this.children.set(e,{id:e,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:t||void 0,toJSON:function(){return{id:e}}})},r.prototype.attachDev=function(){var e=Nr();if(this.options.devTools&&e){if(e.__REDUX_DEVTOOLS_EXTENSION__){var t=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=e.__REDUX_DEVTOOLS_EXTENSION__.connect(w(w({name:this.id,autoPause:!0,stateSanitizer:function(i){return{value:i.value,context:i.context,actions:i.actions}}},t),{features:w({jump:!1,skip:!1},t?t.features:void 0)}),this.machine),this.devTools.init(this.state)}Ss(this)}},r.prototype.toJSON=function(){return{id:this.id}},r.prototype[Jn]=function(){return this},r.defaultOptions=function(e){return{execute:!0,deferEvents:!0,clock:{setTimeout:function(t,i){return setTimeout(t,i)},clearTimeout:function(t){return clearTimeout(t)}},logger:e.console.log.bind(console),devTools:!1}}(typeof self!="undefined"?self:global),r.interpret=Bi,r}(),Dc=function(r){return P(r)?w(w({},qi),{name:r}):w(w(w({},qi),{name:Yn()}),r)};function bs(r,e){var t=Dc(e);return gs(function(i){if(!K){var n=oe(r)||N(r);Q(!!i||n,'Attempted to spawn an Actor (ID: "'+(oe(r)?r.id:"undefined")+'") outside of a service. This will have no effect.')}return i?i.spawn(r,t.name,t):Ai(r,t.name)})}function Bi(r,e){var t=new Pc(r,e);return t}var ec=Ei($i());var Fn=Ei(fa()),Xo=Ei(Qo());var Nn=(r,e,t)=>(r.addEventListener(e,t),()=>r.removeEventListener(e,t)),Yo=jr({id:"Media",initial:"active",states:{active:{invoke:[{id:"Track",src:"track"},{id:"Producer",src:"producer"}],on:{CLOSED:{target:"stopped"},SWITCH:{target:"switching"},"TRACK.ENDED":{target:"stopped"}},initial:"_",states:{_:{always:[{target:"paused",cond:"isPaused"},{target:"live"}]},live:{initial:"healthy",on:{PAUSED:{target:"paused"}},states:{healthy:{on:{"TRACK.METADATA_FAILURE":{target:"unhealthy"}}},unhealthy:{on:{"TRACK.METADATA_RESOLVED":{target:"healthy"}}}}},paused:{on:{RESUMED:{target:"live"}}}}},switching:{invoke:{src:"switch",onDone:{target:"active",actions:fe((r,e)=>({track:e.data.track}))},onError:{target:"stopped"}}},stopped:{type:"final",entry:["close",as(r=>({type:"MEDIA.CLOSED",mediaId:r.id}))]}}},{guards:{isPaused:r=>{var e,t;return((e=r==null?void 0:r.producer)==null?void 0:e.paused)||((t=r==null?void 0:r.consumer)==null?void 0:t.paused)}},actions:{close:r=>{var e,t;(e=r.consumer)==null||e.close(),(t=r.producer)==null||t.close()}},services:{switch:(r,e)=>m(void 0,null,function*(){return console.log("Switching media track",{previous:r.track,next:e.track}),yield r.producer.replaceTrack({track:e.track}),{track:e.track}}),producer:r=>(e,t)=>{var i;(i=r.producer)==null||i.on("close",()=>e({type:"CLOSED"}))},track:r=>(e,t)=>{let{track:i}=r,n=[Nn(i,"muted",s=>{e({type:"TRACK.METADATA_FAILURE"})}),Nn(i,"unmuted",s=>{e({type:"TRACK.METADATA_RESOLVED"})}),Nn(i,"ended",s=>{e({type:"TRACK.ENDED"})})];return()=>{n.forEach(s=>s()),i==null||i.stop()}}}});var ll={qvga:{width:{ideal:320},height:{ideal:240}},vga:{width:{ideal:640},height:{ideal:480}},hd:{width:{ideal:1280},height:{ideal:720}}},ul={optional:[{googDscp:!0}]},fl=[{scaleResolutionDownBy:4,maxBitrate:5e5},{scaleResolutionDownBy:2,maxBitrate:1e6},{scaleResolutionDownBy:1,maxBitrate:5e6}],hl=[{scalabilityMode:"S3T3_KEY"}];var ml=["downlinkBwe","consumerLayersChanged","consumerScore"],gl={notificationHandler:()=>(r,e)=>e(t=>m(void 0,null,function*(){let{notification:i,context:n}=t,s=c=>{r({type:"NOTIFICATION_ERROR",name:i.name,reason:c})};console.log(`Notification received: %c${i.name}`,"color:#777;font-size:11px;",i);try{let{data:c}=i;switch(i.name){case"newPeer":return r({type:"PEER_JOINED",peer:{id:c.id,info:c.info,device:c.device}});case"peerClosed":return n.media.filter(o=>o.peerId===c.peerId).forEach(o=>{var d;return(d=o.consumer)==null?void 0:d.close()}),r({type:"PEER_LEFT",peerId:c.peerId});case"peerUpdated":return r({type:"PEER_UPDATED",peerId:c.peerId,info:c.info});case"consumerClosed":{let{consumerId:a}=i.data;return ye("CLOSED",{to:a})}}}catch(c){console.error(c),s(c.message)}})),requestHandler:()=>(r,e)=>e(t=>m(void 0,null,function*(){let{request:i,context:n,accept:s,reject:c}=t,{recvTransport:a}=n;console.log(`Request received: %c${i.name}`,"background-color:#88c6e4;color:#111;font-size:15px;font-weight:bold;",i);try{switch(i.name){case"newConsumer":{let{peerId:o,producerId:d,id:l,kind:p,rtpParameters:u,appData:f}=i.data,h=yield a.consume({id:l,producerId:d,kind:p,rtpParameters:u,appData:G(G({},f),{peerId:o})});return h.on("transportclose",()=>{console.log("Consumer transport closed",h.id)}),r({type:"REMOTE_MEDIA_ADDED",media:G({id:h.id,track:h.track,consumer:h,peerId:o,kind:h.kind},h.appData)}),s()}}}catch(o){c(o)}})),commandHandler:()=>(r,e)=>{let t=a=>m(void 0,[a],function*({deviceId:n,resolution:s,constraints:c}){let o=G(G({deviceId:n},ll[s||"vga"]),c);return(yield navigator.mediaDevices.getUserMedia({video:o})).getVideoTracks()[0]}),i=c=>m(void 0,[c],function*({deviceId:n,constraints:s}){let a=G({deviceId:n},s);return(yield navigator.mediaDevices.getUserMedia({audio:a})).getAudioTracks()[0]});e(n=>m(void 0,null,function*(){let{command:s,context:c}=n,a=p=>{r({type:"COMMAND_FAILED",name:s.name,reason:p})};console.log(`Command sent: %c${s.name}`,"background-color:#c1ac12;color:#111;font-size:15px;font-weight:bold;",s);let{protoo:o,sendTransport:d,mediasoupDevice:l}=c;try{switch(s.name){case"SendAudio":{let p=s.payload;if(!l.canProduce("audio"))return console.warn("Cannot produce audio");let u=p.track||(yield i(p)),f=yield d.produce({track:u,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{type:p.type||"unknown",deviceId:p.deviceId,label:p.label||""}});return f.on("transportclose",()=>{ye("CLOSED",{to:f.id})}),u?r({type:"LOCAL_MEDIA_ADDED",media:G({id:f.id,peerId:c.peerId,track:u,producer:f,kind:f.kind},f.appData)}):a("Failed to get audio track")}case"SendVideo":{let p=s.payload,{settings:u,mediasoupDevice:f}=c;if(!f.canProduce("video"))return console.warn("Cannot produce video");let h=p.track||(yield t(p)),g,v,_={videoGoogleStartBitrate:1e3};if(u.forceH264){if(v=f.rtpCapabilities.codecs.find(S=>S.mimeType.toLowerCase()==="video/h264"),!v)throw new Error("desired H264 codec+configuration is not supported")}else if(u.forceVP9&&(v=f.rtpCapabilities.codecs.find(S=>S.mimeType.toLowerCase()==="video/vp9"),!v))throw new Error("desired VP9 codec+configuration is not supported");if(u.useSimulcast){let S=f.rtpCapabilities.codecs.find(R=>R.kind==="video");u.forceVP9&&v||S.mimeType.toLowerCase()==="video/vp9"?g=hl:g=fl}let y=yield d.produce({track:h,encodings:g,codecOptions:_,codec:v,appData:{type:p.type||"unknown",deviceId:p.deviceId,label:p.label||""}});return h?r({type:"LOCAL_MEDIA_ADDED",media:G({id:y.id,peerId:c.peerId,track:h,producer:y,kind:y.kind},y.appData)}):a("Failed to get audio track")}case"PauseMedia":{let{mediaId:p}=s.payload,u=c.media.find(f=>f.id===p);return u?(u.consumer&&(yield o.request("pauseConsumer",{consumerId:u.consumer.id}),u.consumer.pause()),u.producer&&(yield o.request("pauseProducer",{producerId:u.producer.id}),u.producer.pause()),u.actor.send("PAUSED")):a("Media not found")}case"ResumeMedia":{let{mediaId:p}=s.payload,u=c.media.find(f=>f.id===p);if(!u)return a("Media not found");if(u.consumer){if(u.consumer.closed)return a("Media is closed");yield o.request("resumeConsumer",{consumerId:u.consumer.id}),u.consumer.resume()}if(u.producer){if(u.producer.closed)return a("Media is closed");yield o.request("resumeProducer",{producerId:u.producer.id}),u.producer.resume()}return u.actor.send({type:"RESUMED"})}case"StopSendingMedia":{let{mediaId:p}=s.payload,u=c.media.find(f=>f.id===p);return u?u.producer?(yield o.request("closeProducer",{producerId:u.producer.id}),u.producer.close(),u.actor.send({type:"CLOSED"})):a("Media is not sending"):a("Media not found")}case"SwitchVideo":{let{mediaId:p,newDefinition:u}=s.payload,f=c.media.find(g=>g.id===p);if(!f)return a("Media not found");if(!f.producer)return a("Media is not sending");let h=u.track||(yield t(u));return h?f.actor.send({type:"SWITCH",track:h}):a("Failed to get video track")}case"SwitchAudio":{let{mediaId:p,newDefinition:u}=s.payload,f=c.media.find(g=>g.id===p);if(!f)return a("Media not found");if(!f.producer)return a("Media is not sending");let h=u.track||(yield i(u));return h?f.actor.send({type:"SWITCH",track:h}):a("Failed to get video track")}}yield o.request(s.name,s.payload)}catch(p){console.error(p),a(p.message)}}))},socket:r=>(e,t)=>{let i=new Fn.default.WebSocketTransport(r.socketUrl,{retry:{retries:30,factor:2,minTimeout:.5*1e3,maxTimeout:10*1e3}}),n=new Fn.default.Peer(i);return n.on("open",()=>m(void 0,null,function*(){let s=new Xo.Device,c=yield n.request("getRouterRtpCapabilities");yield s.load({routerRtpCapabilities:c}),e({type:"SOCKET.CONNECTED",protoo:n,mediasoupDevice:s})})),n.on("failed",()=>{console.log("Connection failed, retrying..."),e("SOCKET.FAILED")}),n.on("disconnected",()=>{console.log("Connection lost, reconnecting..."),e("SOCKET.DISCONNECTED")}),n.on("close",()=>e("SOCKET.CLOSED")),n.on("request",(s,c,a)=>e({type:"REQUEST",request:{name:s.method,data:s.data},accept:c,reject:(o="Not available")=>a(403,o)})),n.on("notification",s=>{let c={name:s.method,data:s.data};ml.includes(c.name)?r.onDiagnostics&&r.onDiagnostics(c):e({type:"NOTIFICATION",notification:c})}),()=>{n.close()}},performJoin:r=>m(void 0,null,function*(){let{protoo:e,settings:t,mediasoupDevice:i}=r;console.log("Execute join...");let n,s;if(t.produce){let c=yield e.request("createWebRtcTransport",{forceTcp:t.forceTcp,producing:!0,consuming:!1}),{id:a,iceParameters:o,iceCandidates:d,dtlsParameters:l,sctpParameters:p}=c;if(s=i.createSendTransport({id:a,iceParameters:o,iceCandidates:d,dtlsParameters:l,sctpParameters:p,iceServers:[],proprietaryConstraints:ul}),s.on("connect",({dtlsParameters:h},g,v)=>{e.request("connectWebRtcTransport",{transportId:s.id,dtlsParameters:h}).then(g).catch(v)}),s.on("produce",(S,R,E)=>m(void 0,[S,R,E],function*({kind:h,rtpParameters:g,appData:v},_,y){try{let{id:L}=yield e.request("produce",{transportId:s.id,kind:h,rtpParameters:g,appData:v});_({id:L})}catch(L){y(L)}})),t.consume){let h=yield e.request("createWebRtcTransport",{forceTcp:t.forceTcp,producing:!1,consuming:!0}),{id:g,iceParameters:v,iceCandidates:_,dtlsParameters:y,sctpParameters:S}=h;n=i.createRecvTransport({id:g,iceParameters:v,iceCandidates:_,dtlsParameters:y,sctpParameters:S,iceServers:[]}),n.on("connect",({dtlsParameters:R},E,L)=>{e.request("connectWebRtcTransport",{transportId:n.id,dtlsParameters:R}).then(E).catch(L)})}let u={id:r.peerId,info:r.peerInfo,device:r.browser},{peers:f}=yield e.request("join",G(G({},u),{consuming:t.consume,producing:t.produce,rtpCapabilities:t.consume?i.rtpCapabilities:void 0}));return f=[...f,u],{peers:f,sendTransport:s,recvTransport:n,mediasoupDevice:i}}}),performLeave:r=>m(void 0,null,function*(){var t,i;let{protoo:e}=r;r.media.forEach(n=>{var s;(s=n.consumer)==null||s.close(),n.producer&&(n.producer.close(),e.request("closeProducer",{producerId:n.producer.id}))}),(t=r.sendTransport)==null||t.close(),(i=r.recvTransport)==null||i.close(),yield r.protoo.request("Leave")})},Zo=jr({id:"Room",initial:"waiting",on:{DISCONNECT:"waiting","SOCKET.CLOSED":"waiting"},states:{waiting:{on:{CONNECT:"active"}},active:{initial:"connecting",invoke:{id:"Socket",src:"socket"},exit:"reset",states:{connecting:{on:{"SOCKET.CONNECTED":{target:"connected",actions:[fe({protoo:(r,e)=>e.protoo,mediasoupDevice:(r,e)=>e.mediasoupDevice})]}}},connected:{initial:"waiting",invoke:[{id:"RequestHandler",src:"requestHandler"},{id:"NotificationHandler",src:"notificationHandler"}],on:{"SOCKET.DISCONNECTED":"reconnecting",REQUEST:{actions:ye((r,e)=>G(G({},e),{context:r}),{to:"RequestHandler"}),internal:!0},NOTIFICATION:{actions:ye((r,e)=>G(G({},e),{context:r}),{to:"NotificationHandler"}),internal:!0},PEER_JOINED:{actions:fe((r,e)=>({peers:[...r.peers,e.peer]}))},PEER_LEFT:{actions:fe((r,e)=>({peers:r.peers.filter(t=>t.id!==e.peerId),media:r.media.filter(t=>t.peerId!==e.peerId)}))},PEER_UPDATED:{actions:fe((r,e)=>({peers:r.peers.map(t=>t.id!==e.peerId?t:G(G({},t),{info:e.info}))}))},LOCAL_MEDIA_ADDED:{actions:"addMedia"},REMOTE_MEDIA_ADDED:{actions:"addMedia"},"MEDIA.CLOSED":{actions:[fe((r,e)=>({media:r.media.filter(t=>t.id!==e.mediaId)})),(r,e)=>{r.media.filter(t=>t.id===e.mediaId).forEach(t=>t.actor.stop())}]}},states:{waiting:{on:{JOIN:"joining"}},joining:{invoke:{src:"performJoin",onDone:{target:"joined",actions:fe((r,e)=>G({},e.data))},onError:{target:"waiting"}}},joined:{invoke:{id:"CommandHandler",src:"commandHandler"},on:{LEAVE:"leaving",COMMAND:{actions:ye((r,e)=>({type:"COMMAND",context:r,command:e.command}),{to:"CommandHandler"})}}},leaving:{invoke:{src:"performLeave",onDone:{actions:"reset",target:"left"},onError:{target:"joined"}}},left:{on:{JOIN:"joining"}}}},reconnecting:{on:{"SOCKET.CONNECTED":{target:"connected"}}}}}}},{services:gl,actions:{reset:fe(r=>({peers:[],media:[]})),addMedia:fe((r,e)=>({media:[...r.media,G(G({},e.media),{actor:bs(Yo.withContext(e.media),{sync:!0,name:e.media.id})})]}))}});var tc=()=>{let r=navigator.userAgent,e=ec.default.getParser(r),t;return e.satisfies({chrome:">=0",chromium:">=0"})?t="chrome":e.satisfies({firefox:">=0"})?t="firefox":e.satisfies({safari:">=0"})?t="safari":e.satisfies({opera:">=0"})?t="opera":e.satisfies({"microsoft edge":">=0"})?t="edge":t="unknown",{flag:t,name:e.getBrowserName(),version:e.getBrowserVersion()}},vl=r=>r.toString(16),_l=()=>vl(Math.random()*16)[0],qn=()=>`${Math.round(Date.now()/1e3)}${Array(10).fill("").map(_l).join("")}`,bi=r=>G(G({},r.context),{state:r.toStrings().reverse()[0],matches:r.matches}),rc=(r,e)=>{let t=r.subscribe({next:i=>e(bi(i)),complete:()=>{}});return e(bi(r.state)),()=>{t.unsubscribe()}},yl=({id:r,peerId:e,peerInfo:t={},settings:i={}})=>{if(r&&$t.get(r))return $t.get(r);r=r||qn(),e=e||qn();let c=`wss://${window.location.hostname}:${4443}/?roomId=${r}&peerId=${e}`,a=_=>{typeof(v==null?void 0:v.onDiagnostics)=="function"&&(v==null||v.onDiagnostics(_))},o={id:r,peers:[],media:[],protoo:null,sendTransport:null,recvTransport:null,mediasoupDevice:null,browser:tc(),socketUrl:c,onDiagnostics:a,peerInfo:t,peerId:e,settings:G({produce:!0,consume:!0},i)},d=Bi(Zo.withContext(o)).start(),l=_=>{d.send({type:"COMMAND",command:_})},p=(_,{deviceId:y,kind:S,type:R,peerId:E})=>!(S!==_.kind||R!=="any"&&R!==_.type||y!=="any"&&y!==_.deviceId||E!=="any"&&E!==_.peerId),u=new Map,f=(_,y)=>{if(y.active&&_.some(E=>E.media.id===y.active.id&&E.available))return;let S=_.find(R=>R.available&&p(R.media,y.options));return y.active=S==null?void 0:S.media,S==null?void 0:S.media},h=()=>{let _=g();u.forEach((y,S)=>{let R=f(_,y);R&&S(R)})},g=()=>d.state.context.media.map(_=>({media:_.actor.state.context,available:_.actor.state.matches("active.live")}));d.onTransition(()=>{h()});let v={Connect:()=>d.send({type:"CONNECT"}),Join:()=>d.send("JOIN"),Leave:()=>d.send("LEAVE"),Disconnect:()=>d.send("DISCONNECT"),Close:()=>ic(d.id),SendVideo:_=>l({name:"SendVideo",payload:_}),SendAudio:_=>l({name:"SendAudio",payload:_}),PauseMedia:_=>l({name:"PauseMedia",payload:_}),ResumeMedia:_=>l({name:"ResumeMedia",payload:_}),StopSendingMedia:_=>l({name:"StopSendingMedia",payload:_}),SwitchAudio:_=>l({name:"SwitchAudio",payload:_}),SwitchVideo:_=>l({name:"SwitchVideo",payload:_}),ModifyMedia:_=>l({name:"ModifyMedia",payload:_}),UpdatePeer:_=>l({name:"UpdatePeer",payload:_}),RestartIce:()=>l({name:"RestartIce"}),getMedia:_=>{let y=d.state.context.media.find(S=>S.id===_);return y?bi(y.actor.state):null},useMedia:(_,y)=>{let S=d.state.context.media.find(R=>R.id===_);return S?rc(S.actor,y):()=>{}},getState:()=>bi(d.state),useState:_=>rc(d,_),watch:(_,y)=>{let S={options:G({type:"any",deviceId:"any",peerId:"any"},_)};return u.set(y,S),y(f(g(),S)),()=>{u.delete(y)}},onDiagnostics:a,sendCommand:l,id:r,peerId:e,settings:i,service:d};return $t.set(r,v),v},ic=r=>{let e=$t.get(r);e&&(e.service.send("DISCONNECT"),$t.delete(r))},zt=new Set,Bn=()=>m(void 0,null,function*(){let r=yield navigator.mediaDevices.enumerateDevices(),e=r.find(i=>i.kind==="videoinput"),t=r.find(i=>i.kind==="audioinput");return{video:Boolean(e)&&Boolean(e.deviceId),audio:Boolean(t)&&Boolean(t.deviceId)}}),sc=()=>m(void 0,null,function*(){let r=yield Bn();if(r.audio&&r.video)return r;try{return(yield nc({video:!r.video,audio:!r.audio})).getTracks().forEach(t=>{t.stop()}),Bn()}catch(e){return console.warn(e),r}}),wl=r=>(zt.size===0&&navigator.mediaDevices.addEventListener("devicechange",Ri),zt.add(r),Ri().catch(()=>{}),()=>{zt.delete(r),zt.size===0&&navigator.mediaDevices.removeEventListener("devicechange",Ri)}),nc=(...r)=>m(void 0,null,function*(){let e=yield navigator.mediaDevices.getUserMedia(...r);return Ri(),e}),Ri=()=>m(void 0,null,function*(){let r=yield sc(),e=yield navigator.mediaDevices.enumerateDevices(),t=r.video?e.filter(s=>s.kind==="videoinput"):[],i=r.audio?e.filter(s=>s.kind==="audioinput"):[],n=r.audio?e.filter(s=>s.kind==="audiooutput"):[];zt.forEach(s=>s({webcams:t,microphones:i,speakers:n}))});zt.forEach(r=>{});var $t=new Map;export{ic as deleteRoom,sc as ensureDevicePermissions,qn as generateID,tc as getBrowserInfo,Bn as getDevicePermissions,nc as getUserMedia,$t as rooms,yl as startRoom,wl as watchDevices};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
